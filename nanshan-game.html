<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂçóÂ±±Áµå„Éü„Çπ„ÉÜ„É™„Éº - ÁÅ´Êü¥‰∫∫Êé¢ÂÅµ„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f5f3e9;
            color: #2c1810;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* „Ç≤„Éº„É†„Ç≥„É≥„ÉÜ„Éä */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
        }

        .game-title {
            font-size: 2.5em;
            color: #8b4513;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-subtitle {
            font-size: 1.2em;
            color: #666;
        }

        /* „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* ÁÅ´Êü¥‰∫∫„Ç≠„É£„É≥„Éê„Çπ„Ç®„É™„Ç¢ */
        .stick-figure-area {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        #gameCanvas {
            width: 100%;
            height: 400px;
            border: 1px dashed #ccc;
            cursor: pointer;
        }

        /* „ÉÜ„Ç≠„Çπ„Éà„Å®„Éë„Ç∫„É´„Ç®„É™„Ç¢ */
        .content-area {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
        }

        /* Á´†„Çø„Ç§„Éà„É´ */
        .chapter-title {
            font-size: 1.8em;
            color: #8b4513;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b4513;
        }

        /* „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫„Ç®„É™„Ç¢ */
        .text-display {
            background: #fefefe;
            padding: 15px;
            border-left: 4px solid #d4a574;
            margin-bottom: 20px;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .original-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dotted #ccc;
        }

        /* „Éë„Ç∫„É´„Ç®„É™„Ç¢ */
        .puzzle-area {
            background: #f9f7f3;
            border: 2px dashed #8b4513;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .puzzle-title {
            font-size: 1.4em;
            color: #8b4513;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .puzzle-icon {
            font-size: 1.5em;
        }

        .puzzle-progress {
            font-size: 0.9em;
            color: #666;
            margin-left: auto;
        }

        /* „ÇØ„Ç§„Ç∫„Éª„Éë„Ç∫„É´Ë¶ÅÁ¥† */
        .quiz-question {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .quiz-option {
            background: white;
            border: 2px solid #d4a574;
            border-radius: 5px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            position: relative;
            overflow: hidden;
        }

        .quiz-option:hover {
            background: #f4e6d7;
            transform: translateX(5px);
            border-color: #8b4513;
        }

        .quiz-option.correct {
            background: #90ee90;
            border-color: #228b22;
            animation: correctPulse 0.6s ease;
        }

        .quiz-option.incorrect {
            background: #ffcccb;
            border-color: #dc143c;
            animation: shake 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* „Éí„É≥„Éà„Ç∑„Çπ„ÉÜ„É† */
        .hint-box {
            background: #fffacd;
            border: 1px solid #daa520;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .hint-button {
            background: #daa520;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        .hint-button:hover {
            background: #b8860b;
        }

        /* ÈÄ≤Ë°åÁä∂Ê≥Å„Éê„Éº */
        .progress-container {
            margin-bottom: 20px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, #8b4513, #d4a574);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Êé®ÁêÜ„Éé„Éº„Éà */
        .detective-notebook {
            background: #fffef0;
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .notebook-title {
            font-size: 1.3em;
            color: #8b4513;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .clue-list {
            list-style: none;
            padding-left: 20px;
        }

        .clue-item {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .clue-item::before {
            content: "üîç";
            position: absolute;
            left: 0;
        }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥ */
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #6b3410;
            transform: translateY(-2px);
        }

        .control-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* „Çπ„Ç≥„Ç¢Ë°®Á§∫ */
        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .score-label {
            font-size: 0.9em;
            color: #666;
        }

        .score-value {
            font-size: 1.8em;
            color: #8b4513;
            font-weight: bold;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éó„É¨„Éì„É•„Éº */
        .animation-preview {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 5px;
            display: none;
            pointer-events: none;
            z-index: 100;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .stick-figure-area {
                min-height: 300px;
            }
            
            #gameCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="game-header">
            <h1 class="game-title">ÂçóÂ±±Áµå„Éü„Çπ„ÉÜ„É™„Éº</h1>
            <p class="game-subtitle">ÁÅ´Êü¥‰∫∫Êé¢ÂÅµ„Å®Â±±Êµ∑Áµå„ÅÆË¨é„ÇíËß£„Åè</p>
        </div>

        <!-- ÈÄ≤Ë°åÁä∂Ê≥Å„Éê„Éº -->
        <div class="progress-container">
            <div class="progress-info">
                <span>ÈÄ≤Ë°åÁä∂Ê≥Å</span>
                <span id="progressText">0 / 0 „Éë„Ç∫„É´ÂÆå‰∫Ü</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <!-- „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
        <div class="game-area">
            <!-- ÁÅ´Êü¥‰∫∫Ë°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="stick-figure-area">
                <canvas id="gameCanvas"></canvas>
                <div class="animation-preview">
                    <canvas id="previewCanvas" width="100" height="100"></canvas>
                </div>
                <div class="detective-notebook">
                    <h3 class="notebook-title">
                        <span>üìî</span>
                        <span>Êé¢ÂÅµ„Éé„Éº„Éà</span>
                    </h3>
                    <ul class="clue-list" id="clueList">
                        <li class="clue-item">„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶Êâã„Åå„Åã„Çä„ÇíÈõÜ„ÇÅ„Çà„ÅÜ</li>
                    </ul>
                </div>
            </div>

            <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
            <div class="content-area">
                <h2 class="chapter-title" id="chapterTitle">„Ç≤„Éº„É†ÈñãÂßãÁîªÈù¢</h2>
                
                <div class="text-display" id="textDisplay">
                    <p>Â±±Êµ∑Áµå„ÅÆÂçóÂ±±Áµå„Å´„ÅØ„ÄÅ‰∏çÊÄùË≠∞„Å™Áîü„ÅçÁâ©„ÇÑÊ§çÁâ©„Åå„Åü„Åè„Åï„ÇìË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                    <p>„ÅÇ„Å™„Åü„ÅØÁÅ´Êü¥‰∫∫Êé¢ÂÅµ„Å®„Å™„Å£„Å¶„ÄÅÂè§‰ª£„ÅÆË¨é„ÇíËß£„ÅçÊòé„Åã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <p>„ÉÜ„Ç≠„Çπ„Éà„Çí„Çà„ÅèË™≠„Çì„Åß„ÄÅÁîü„ÅçÁâ©„ÅÆÁâπÂæ¥„ÇíÊé®ÁêÜ„Åó„ÄÅ„Éë„Ç∫„É´„ÇíËß£„ÅÑ„Å¶ÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                </div>

                <div class="puzzle-area" id="puzzleArea">
                    <h3 class="puzzle-title">
                        <span class="puzzle-icon">üß©</span>
                        <span>Ê∫ñÂÇô„ÅØ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü</span>
                    </h3>
                    <div class="control-buttons">
                        <button class="control-button" onclick="startGame()">„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Çπ„Ç≥„Ç¢Ë°®Á§∫ -->
        <div class="score-display">
            <div class="score-label">„Çπ„Ç≥„Ç¢</div>
            <div class="score-value" id="scoreValue">0</div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ÂãïÁöÑ„Å´ÂÜÖÂÆπ„ÇíÊåøÂÖ• -->
        </div>
    </div>

    <!-- Â§ñÈÉ®„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„Åø -->
    <script src="shanhaijing-complete-text.js"></script>
    
    <script>
        // „Ç≤„Éº„É†Áä∂ÊÖãÁÆ°ÁêÜ
        const gameState = {
            currentChapter: -1,
            currentPuzzle: 0,
            totalPuzzles: 0,
            completedPuzzles: 0,
            score: 0,
            clues: [],
            solvedPuzzles: [],
            chapters: [],
            animations: {}
        };

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
        const ANIMATION_CONFIG = {
            frameRate: 60,
            creatures: {
                xingxing: { frames: 8, speed: 0.15 },
                lushu: { frames: 10, speed: 0.2 },
                phoenix: { frames: 12, speed: 0.1 },
                default: { frames: 6, speed: 0.15 }
            }
        };

        // „Ç≠„É£„É≥„Éê„ÇπË®≠ÂÆö
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë®≠ÂÆö
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éï„É¨„Éº„É†ÁÆ°ÁêÜ
        let animationFrame = 0;
        let lastTime = 0;

        // ÁÅ´Êü¥‰∫∫ÊèèÁîªÈñ¢Êï∞Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂØæÂøúÔºâ
        function drawStickFigure(ctx, x, y, type = 'detective', frame = 0, scale = 1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.strokeStyle = '#2c1810';
            ctx.lineWidth = 3;
            
            if (type === 'detective') {
                // Êé¢ÂÅµÁÅ´Êü¥‰∫∫ÔºàÊ≠©Ë°å„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
                const walkOffset = Math.sin(frame * 0.1) * 5;
                
                // È†≠
                ctx.beginPath();
                ctx.arc(0, -30 + walkOffset * 0.3, 15, 0, Math.PI * 2);
                ctx.stroke();
                
                // Â∏ΩÂ≠ê
                ctx.beginPath();
                ctx.moveTo(-20, -35 + walkOffset * 0.3);
                ctx.lineTo(20, -35 + walkOffset * 0.3);
                ctx.lineTo(15, -45 + walkOffset * 0.3);
                ctx.lineTo(-15, -45 + walkOffset * 0.3);
                ctx.closePath();
                ctx.stroke();
                
                // ‰Ωì
                ctx.beginPath();
                ctx.moveTo(0, -15 + walkOffset * 0.3);
                ctx.lineTo(0, 20);
                ctx.stroke();
                
                // ËÖïÔºàÊ≠©Ë°åÊôÇ„ÅÆÊåØ„ÇäÔºâ
                const armSwing = Math.sin(frame * 0.1) * 10;
                ctx.beginPath();
                ctx.moveTo(-15 - armSwing * 0.5, 0);
                ctx.lineTo(0, -5 + walkOffset * 0.3);
                ctx.lineTo(15 + armSwing * 0.5, 0);
                ctx.stroke();
                
                // Ëô´ÁúºÈè°
                ctx.beginPath();
                ctx.arc(25 + armSwing * 0.5, -5, 8, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(20 + armSwing * 0.5, 0);
                ctx.lineTo(15 + armSwing * 0.5, 5);
                ctx.stroke();
                
                // ËÑöÔºàÊ≠©Ë°å„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
                const legSwing = Math.sin(frame * 0.1) * 15;
                ctx.beginPath();
                ctx.moveTo(0, 20);
                ctx.lineTo(-10 - legSwing, 40);
                ctx.moveTo(0, 20);
                ctx.lineTo(10 + legSwing, 40);
                ctx.stroke();
            } else if (type === 'celebration') {
                // Ê≠£Ëß£ÊôÇ„ÅÆÂñú„Å≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                const jumpHeight = Math.abs(Math.sin(frame * 0.2)) * 20;
                const armRaise = Math.sin(frame * 0.3) * 30;
                
                // È†≠
                ctx.beginPath();
                ctx.arc(0, -30 - jumpHeight, 15, 0, Math.PI * 2);
                ctx.stroke();
                
                // Á¨ëÈ°î
                ctx.beginPath();
                ctx.arc(0, -25 - jumpHeight, 8, 0, Math.PI);
                ctx.stroke();
                
                // ‰Ωì
                ctx.beginPath();
                ctx.moveTo(0, -15 - jumpHeight);
                ctx.lineTo(0, 20 - jumpHeight);
                ctx.stroke();
                
                // ËÖïÔºà‰∏ä„Åí‰∏ã„ÅíÔºâ
                ctx.beginPath();
                ctx.moveTo(-15, -5 - jumpHeight);
                ctx.lineTo(0, -5 - jumpHeight);
                ctx.lineTo(15, -5 - jumpHeight - armRaise);
                ctx.stroke();
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(0, 20 - jumpHeight);
                ctx.lineTo(-10, 40);
                ctx.moveTo(0, 20 - jumpHeight);
                ctx.lineTo(10, 40);
                ctx.stroke();
            } else if (type === 'wrong') {
                // ‰∏çÊ≠£Ëß£ÊôÇ„ÅÆÈ¶ñÊåØ„Çä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                const headShake = Math.sin(frame * 0.3) * 10;
                
                // È†≠ÔºàÈ¶ñÊåØ„ÇäÔºâ
                ctx.beginPath();
                ctx.arc(headShake, -30, 15, 0, Math.PI * 2);
                ctx.stroke();
                
                // Âõ∞„Å£„ÅüÈ°î
                ctx.beginPath();
                ctx.moveTo(headShake - 5, -25);
                ctx.lineTo(headShake + 5, -25);
                ctx.stroke();
                
                // ‰Ωì
                ctx.beginPath();
                ctx.moveTo(0, -15);
                ctx.lineTo(0, 20);
                ctx.stroke();
                
                // ËÖïÔºà‰∏ã„ÅíÊ∞óÂë≥Ôºâ
                ctx.beginPath();
                ctx.moveTo(-15, 5);
                ctx.lineTo(0, -5);
                ctx.lineTo(15, 5);
                ctx.stroke();
                
                // ËÑö
                ctx.beginPath();
                ctx.moveTo(0, 20);
                ctx.lineTo(-10, 40);
                ctx.moveTo(0, 20);
                ctx.lineTo(10, 40);
                ctx.stroke();
            }
            
            ctx.restore();
        }

        // Áîü„ÅçÁâ©„ÇíÁÅ´Êü¥‰∫∫„Çπ„Çø„Ç§„É´„ÅßÊèèÁîªÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂØæÂøúÔºâ
        function drawCreature(ctx, x, y, creatureData, frame = 0, scale = 1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 2;
            
            switch(creatureData.type) {
                case 'xingxing': // ÁãåÁãåÔºà‰∫∫„ÅÆ„Çà„ÅÜ„Å´Ê≠©„ÅèÁåøÔºâ
                    const walkCycle = Math.sin(frame * 0.15) * 10;
                    const armSwing = Math.sin(frame * 0.15 + Math.PI) * 15;
                    
                    // È†≠
                    ctx.beginPath();
                    ctx.arc(0, -20 + Math.abs(walkCycle) * 0.3, 12, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ÁôΩ„ÅÑËÄ≥Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(-15, -22 + Math.abs(walkCycle) * 0.3, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(15, -22 + Math.abs(walkCycle) * 0.3, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // ‰ΩìÔºàÁõ¥Á´ãÊ≠©Ë°åÔºâ
                    ctx.beginPath();
                    ctx.moveTo(0, -8 + Math.abs(walkCycle) * 0.3);
                    ctx.lineTo(0, 15);
                    ctx.stroke();
                    
                    // ËÖïÔºà‰∫∫Èñì„ÅÆ„Çà„ÅÜ„Å™ÊåØ„ÇäÔºâ
                    ctx.beginPath();
                    ctx.moveTo(-10, 0);
                    ctx.lineTo(0, -5 + Math.abs(walkCycle) * 0.3);
                    ctx.lineTo(10, 0 - armSwing * 0.5);
                    ctx.stroke();
                    
                    // ËÑöÔºà‰∫åË∂≥Ê≠©Ë°åÔºâ
                    ctx.beginPath();
                    ctx.moveTo(0, 15);
                    ctx.lineTo(-8 - walkCycle * 0.5, 30);
                    ctx.moveTo(0, 15);
                    ctx.lineTo(8 + walkCycle * 0.5, 30);
                    ctx.stroke();
                    
                    // Âêπ„ÅçÂá∫„ÅóÔºàÂêçÂâç„ÇíÂëº„Å∂Ôºâ
                    if (frame % 120 < 60) {
                        ctx.beginPath();
                        ctx.moveTo(20, -25);
                        ctx.lineTo(30, -35);
                        ctx.lineTo(50, -35);
                        ctx.lineTo(50, -45);
                        ctx.lineTo(30, -45);
                        ctx.lineTo(25, -35);
                        ctx.closePath();
                        ctx.stroke();
                        ctx.fillStyle = '#2c1810';
                        ctx.font = '10px sans-serif';
                        ctx.fillText('ÂêçÂâçÔºÅ', 32, -38);
                    }
                    break;
                    
                case 'lushu': // ÈπøËúÄÔºàËôéÁ∏û„ÅÆÈ¶¨Ôºâ
                    const gallop = Math.sin(frame * 0.2) * 5;
                    const legCycle = frame * 0.2;
                    
                    // È†≠ÔºàÈ¶¨Ôºâ
                    ctx.beginPath();
                    ctx.ellipse(0, -25 + gallop, 10, 15, Math.PI * 0.1, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ‰ΩìÔºàÊ®™Èï∑Ôºâ
                    ctx.beginPath();
                    ctx.ellipse(0, 0 + gallop, 25, 15, 0, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ËôéÁ∏ûÊ®°Êßò
                    ctx.strokeStyle = '#ff8c00';
                    for (let i = -20; i <= 20; i += 8) {
                        ctx.beginPath();
                        ctx.moveTo(i, -10 + gallop);
                        ctx.lineTo(i + 3, 10 + gallop);
                        ctx.stroke();
                    }
                    ctx.strokeStyle = '#8b4513';
                    
                    // ËÑöÔºàËµ∞Ë°å„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
                    const legs = [
                        { x: -15, phase: 0 },
                        { x: -8, phase: Math.PI },
                        { x: 8, phase: Math.PI * 0.5 },
                        { x: 15, phase: Math.PI * 1.5 }
                    ];
                    
                    legs.forEach(leg => {
                        const legHeight = Math.sin(legCycle + leg.phase) * 10;
                        ctx.beginPath();
                        ctx.moveTo(leg.x, 15 + gallop);
                        ctx.lineTo(leg.x, 25 + legHeight);
                        ctx.stroke();
                    });
                    
                    // Â∞æ
                    const tailSwing = Math.sin(frame * 0.15) * 20;
                    ctx.beginPath();
                    ctx.moveTo(25, 0 + gallop);
                    ctx.quadraticCurveTo(35 + tailSwing * 0.5, 5 + gallop, 30 + tailSwing, 15 + gallop);
                    ctx.stroke();
                    break;
                    
                case 'phoenix': // È≥≥Âá∞ÔºàÈ£õÁøî„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
                    const flyHeight = Math.sin(frame * 0.1) * 10;
                    const wingFlap = Math.sin(frame * 0.3) * 30;
                    
                    // ‰∫∫„ÅÆÈ†≠
                    ctx.beginPath();
                    ctx.arc(0, -25 + flyHeight, 10, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ÁéãÂÜ†
                    ctx.beginPath();
                    ctx.moveTo(-8, -35 + flyHeight);
                    ctx.lineTo(-4, -40 + flyHeight);
                    ctx.lineTo(0, -38 + flyHeight);
                    ctx.lineTo(4, -40 + flyHeight);
                    ctx.lineTo(8, -35 + flyHeight);
                    ctx.stroke();
                    
                    // ‰ΩìÔºàÈ≥•Ôºâ
                    ctx.beginPath();
                    ctx.ellipse(0, 0 + flyHeight, 15, 20, 0, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ÁøºÔºàÁæΩ„Å∞„Åü„ÅçÔºâ
                    ctx.beginPath();
                    ctx.moveTo(-15, -5 + flyHeight);
                    ctx.quadraticCurveTo(-30 - wingFlap, -10 + flyHeight - wingFlap * 0.5, -25 - wingFlap, 5 + flyHeight);
                    ctx.moveTo(15, -5 + flyHeight);
                    ctx.quadraticCurveTo(30 + wingFlap, -10 + flyHeight - wingFlap * 0.5, 25 + wingFlap, 5 + flyHeight);
                    ctx.stroke();
                    
                    // ÁæΩÊ†π„ÅÆË©≥Á¥∞
                    ctx.strokeStyle = '#d4a574';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.moveTo(-20 - wingFlap + i * 5, -5 + flyHeight - wingFlap * 0.3);
                        ctx.lineTo(-22 - wingFlap + i * 5, 0 + flyHeight);
                        ctx.moveTo(20 + wingFlap - i * 5, -5 + flyHeight - wingFlap * 0.3);
                        ctx.lineTo(22 + wingFlap - i * 5, 0 + flyHeight);
                        ctx.stroke();
                    }
                    ctx.strokeStyle = '#8b4513';
                    ctx.lineWidth = 2;
                    
                    // Â∞æÔºàÂÑ™ÈõÖ„Å´Êè∫„Çå„ÇãÔºâ
                    const tailSway = Math.sin(frame * 0.08) * 10;
                    ctx.beginPath();
                    ctx.moveTo(0, 20 + flyHeight);
                    ctx.lineTo(-5 + tailSway * 0.3, 30 + flyHeight);
                    ctx.moveTo(0, 20 + flyHeight);
                    ctx.lineTo(0 + tailSway * 0.5, 32 + flyHeight);
                    ctx.moveTo(0, 20 + flyHeight);
                    ctx.lineTo(5 + tailSway * 0.3, 30 + flyHeight);
                    ctx.stroke();
                    
                    // Ëºù„Åç„Ç®„Éï„Çß„ÇØ„Éà
                    if (frame % 60 < 30) {
                        ctx.strokeStyle = '#ffd700';
                        ctx.beginPath();
                        ctx.arc(0, -10 + flyHeight, 25, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    break;
                    
                case 'plant_effect': // Ê§çÁâ©ÂäπÊûú„Éá„É¢„É≥„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥
                    const eatCycle = frame % 180;
                    
                    // Âü∫Êú¨„ÅÆÁÅ´Êü¥‰∫∫
                    ctx.beginPath();
                    ctx.arc(0, -20, 12, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(0, -8);
                    ctx.lineTo(0, 15);
                    ctx.stroke();
                    
                    // ËÖïÔºàÈ£ü„Åπ„ÇãÂãï‰ΩúÔºâ
                    if (eatCycle < 60) {
                        const handMove = eatCycle / 60;
                        ctx.beginPath();
                        ctx.moveTo(-10, 0);
                        ctx.lineTo(0, -5);
                        ctx.lineTo(10 - handMove * 10, -5 - handMove * 15);
                        ctx.stroke();
                        
                        // Ê§çÁâ©
                        ctx.fillStyle = '#90ee90';
                        ctx.beginPath();
                        ctx.arc(10 - handMove * 10, -5 - handMove * 15, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                    } else {
                        // ÂäπÊûúÁô∫Âãï
                        ctx.beginPath();
                        ctx.moveTo(-10, -10);
                        ctx.lineTo(0, -5);
                        ctx.lineTo(10, -10);
                        ctx.stroke();
                        
                        // „Ç®„Éï„Çß„ÇØ„Éà
                        const effectRadius = (eatCycle - 60) / 120 * 30;
                        ctx.strokeStyle = '#32cd32';
                        ctx.beginPath();
                        ctx.arc(0, 0, effectRadius, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // ÂäπÊûú„ÉÜ„Ç≠„Çπ„Éà
                        if (creatureData.effect) {
                            ctx.fillStyle = '#228b22';
                            ctx.font = '12px sans-serif';
                            ctx.fillText(creatureData.effect, -30, -40);
                        }
                    }
                    
                    // ËÑö
                    ctx.strokeStyle = '#8b4513';
                    ctx.beginPath();
                    ctx.moveTo(0, 15);
                    ctx.lineTo(-8, 30);
                    ctx.moveTo(0, 15);
                    ctx.lineTo(8, 30);
                    ctx.stroke();
                    break;
                    
                case 'direction': // ÊñπÂêëÊåáÁ§∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    const pointCycle = Math.sin(frame * 0.1) * 10;
                    
                    // È†≠
                    ctx.beginPath();
                    ctx.arc(0, -20, 10, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // ‰Ωì
                    ctx.beginPath();
                    ctx.moveTo(0, -10);
                    ctx.lineTo(0, 15);
                    ctx.stroke();
                    
                    // ÊåáÂ∑Æ„ÅóËÖï
                    const direction = creatureData.direction || 'east';
                    let armAngle = 0;
                    switch(direction) {
                        case 'east': armAngle = 0; break;
                        case 'west': armAngle = Math.PI; break;
                        case 'north': armAngle = -Math.PI / 2; break;
                        case 'south': armAngle = Math.PI / 2; break;
                    }
                    
                    ctx.beginPath();
                    ctx.moveTo(0, -5);
                    ctx.lineTo(
                        Math.cos(armAngle) * (20 + pointCycle),
                        -5 + Math.sin(armAngle) * (20 + pointCycle)
                    );
                    ctx.stroke();
                    
                    // Áü¢Âç∞
                    ctx.save();
                    ctx.translate(
                        Math.cos(armAngle) * (25 + pointCycle),
                        -5 + Math.sin(armAngle) * (25 + pointCycle)
                    );
                    ctx.rotate(armAngle);
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(-5, -5);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(-5, 5);
                    ctx.stroke();
                    ctx.restore();
                    
                    // „ÇÇ„ÅÜÁâáÊñπ„ÅÆËÖï
                    ctx.beginPath();
                    ctx.moveTo(0, -5);
                    ctx.lineTo(-10, 0);
                    ctx.stroke();
                    
                    // ËÑö
                    ctx.beginPath();
                    ctx.moveTo(0, 15);
                    ctx.lineTo(-8, 30);
                    ctx.moveTo(0, 15);
                    ctx.lineTo(8, 30);
                    ctx.stroke();
                    
                    // ÊñπÂêë„ÉÜ„Ç≠„Çπ„Éà
                    ctx.fillStyle = '#8b4513';
                    ctx.font = '14px sans-serif';
                    const dirText = {
                        'east': 'Êù±„Å∏‚Üí',
                        'west': '‚ÜêË•ø„Å∏',
                        'north': '‚ÜëÂåó„Å∏',
                        'south': 'Âçó„Å∏‚Üì'
                    };
                    ctx.fillText(dirText[direction] || '', -20, -40);
                    break;
            }
            
            ctx.restore();
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
        function animate(currentTime) {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            if (deltaTime > 16) { // 60fpsÂà∂Èôê
                animationFrame++;
                
                // „É°„Ç§„É≥„Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, 'rgba(255, 250, 240, 0.5)');
                gradient.addColorStop(1, 'rgba(255, 248, 220, 0.5)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Êé¢ÂÅµ„ÇíÊèèÁîª
                drawStickFigure(ctx, 150, canvas.height / 2 + 50, gameState.animations.detective || 'detective', animationFrame);
                
                // ÁèæÂú®„ÅÆ„ÇØ„É™„Éº„ÉÅ„É£„Éº„ÇíÊèèÁîª
                if (gameState.animations.creature) {
                    drawCreature(ctx, canvas.width - 200, canvas.height / 2 + 50, gameState.animations.creature, animationFrame);
                }
                
                // ËøΩÂä†„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë¶ÅÁ¥†
                if (gameState.animations.extras) {
                    gameState.animations.extras.forEach(extra => {
                        if (extra.type === 'celebration') {
                            drawStickFigure(ctx, extra.x, extra.y, 'celebration', animationFrame, 0.8);
                        }
                    });
                }
            }
            
            requestAnimationFrame(animate);
        }

        // „Éë„Ç∫„É´ÁîüÊàêÈñ¢Êï∞
        function generatePuzzle(chapterData, puzzleIndex) {
            const puzzleTypes = [
                'creature_identification',
                'property_matching',
                'text_analysis',
                'location_puzzle'
            ];
            
            const type = puzzleTypes[puzzleIndex % puzzleTypes.length];
            
            switch(type) {
                case 'creature_identification':
                    return generateCreatureIdentificationPuzzle(chapterData);
                case 'property_matching':
                    return generatePropertyMatchingPuzzle(chapterData);
                case 'text_analysis':
                    return generateTextAnalysisPuzzle(chapterData);
                case 'location_puzzle':
                    return generateLocationPuzzle(chapterData);
            }
        }

        // Áîü„ÅçÁâ©Ë≠òÂà•„Éë„Ç∫„É´
        function generateCreatureIdentificationPuzzle(chapterData) {
            const creatures = extractCreatures(chapterData);
            if (creatures.length === 0) return null;
            
            const targetCreature = creatures[Math.floor(Math.random() * creatures.length)];
            const question = `Ê¨°„ÅÆÁâπÂæ¥„ÇíÊåÅ„Å§Áîü„ÅçÁâ©„ÅØ‰Ωï„Åß„Åó„Çá„ÅÜÔºü\n${targetCreature.description}`;
            
            const options = [
                targetCreature.name,
                'Â§©Áãó',
                'È∫íÈ∫ü',
                'Èæç'
            ].sort(() => Math.random() - 0.5);
            
            return {
                type: 'creature',
                question: question,
                options: options,
                correct: targetCreature.name,
                hint: `„Éí„É≥„ÉàÔºö${chapterData.title}„Å´ÁôªÂ†¥„Åô„ÇãÁîü„ÅçÁâ©„Åß„Åô„ÄÇ`,
                creatureData: targetCreature
            };
        }

        // ÁâπÊÄß„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Éë„Ç∫„É´
        function generatePropertyMatchingPuzzle(chapterData) {
            const properties = extractProperties(chapterData);
            if (properties.length === 0) return null;
            
            const targetProperty = properties[Math.floor(Math.random() * properties.length)];
            const question = `„Äå${targetProperty.item}„Äç„ÅÆÂäπÊûú„ÅØ‰Ωï„Åß„Åó„Çá„ÅÜÔºü`;
            
            const options = [
                targetProperty.effect,
                'ÁóÖÊ∞ó„ÇíÊ≤ª„Åô',
                'Èï∑ÂØø„Çí„ÇÇ„Åü„Çâ„Åô',
                'ÂØå„Çí„ÇÇ„Åü„Çâ„Åô'
            ].sort(() => Math.random() - 0.5);
            
            return {
                type: 'property',
                question: question,
                options: options,
                correct: targetProperty.effect,
                hint: `„Éí„É≥„ÉàÔºöÂéüÊñá„Çí„Çà„ÅèË™≠„Çì„Åß„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                propertyData: targetProperty
            };
        }

        // „ÉÜ„Ç≠„Çπ„ÉàÂàÜÊûê„Éë„Ç∫„É´
        function generateTextAnalysisPuzzle(chapterData) {
            const question = `${chapterData.title}„ÅÆËàûÂè∞„Å®„Å™„ÇãÂ±±„ÅÆÁâπÂæ¥„ÅØÔºü`;
            const features = extractMountainFeatures(chapterData);
            
            if (features.length === 0) return null;
            
            const correct = features[0];
            const options = [
                correct,
                'Êù±„ÅÆÊµ∑„Å´Èù¢„Åó„Å¶„ÅÑ„Çã',
                'Èõ™„Åå‰∏ÄÂπ¥‰∏≠Á©ç„ÇÇ„Å£„Å¶„ÅÑ„Çã',
                '‰∫∫„Åå‰Ωè„Çì„Åß„ÅÑ„Çã'
            ].sort(() => Math.random() - 0.5);
            
            return {
                type: 'text',
                question: question,
                options: options,
                correct: correct,
                hint: `„Éí„É≥„ÉàÔºöÂ±±„ÅÆ‰ΩçÁΩÆ„ÇÑÁâπÂæ¥„Å´Ê≥®ÁõÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
            };
        }

        // ‰ΩçÁΩÆ„Éë„Ç∫„É´
        function generateLocationPuzzle(chapterData) {
            const locations = extractLocations(chapterData);
            if (locations.length === 0) return null;
            
            const question = `„Åì„ÅÆÁ´†„Å´ÁôªÂ†¥„Åô„ÇãÂ∑ù„ÅØ„Å©„Åì„Å´ÊµÅ„Çå„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü`;
            const correct = locations[0].destination;
            
            const options = [
                correct,
                'Êù±„ÅÆÊπñ',
                'Âåó„ÅÆÂ§ßÊ≤≥',
                'Âçó„ÅÆÊ≤º'
            ].sort(() => Math.random() - 0.5);
            
            const directionMap = {
                'Êµ∑': 'east',
                'Êù±„ÅÆÊπñ': 'east',
                'Âåó„ÅÆÂ§ßÊ≤≥': 'north',
                'Âçó„ÅÆÊ≤º': 'south'
            };
            
            return {
                type: 'location',
                question: question,
                options: options,
                correct: correct,
                hint: `„Éí„É≥„ÉàÔºöÊ∞¥„ÅÆÊµÅ„Çå„ÇãÊñπÂêë„Å´Ê≥®ÁõÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                locationData: { direction: directionMap[correct] || 'east' }
            };
        }

        // „Éá„Éº„ÇøÊäΩÂá∫Èñ¢Êï∞
        function extractCreatures(chapterData) {
            const creatures = [];
            const text = chapterData.japanese;
            
            // ÁãåÁãå„ÅÆÊäΩÂá∫
            if (text.includes('ÁãåÁãå')) {
                creatures.push({
                    name: 'ÁãåÁãåÔºà„Åõ„ÅÑ„Åõ„ÅÑÔºâ',
                    description: 'Áåø„Å´‰ºº„Å¶ÁôΩ„ÅÑËÄ≥„ÇíÊåÅ„Å°„ÄÅÂú∞„ÇíÈÄô„ÅÜ„Çà„ÅÜ„Å´ÈÄ≤„Åø‰∫∫„ÅÆ„Çà„ÅÜ„Å´Ëµ∞„Çã',
                    type: 'xingxing'
                });
            }
            
            // ÈπøËúÄ„ÅÆÊäΩÂá∫
            if (text.includes('ÈπøËúÄ')) {
                creatures.push({
                    name: 'ÈπøËúÄÔºà„Çç„Åè„Åó„Çá„ÅèÔºâ',
                    description: 'È¶¨„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„ÅßÁôΩ„ÅÑÈ†≠„ÄÅËôé„ÅÆ„Çà„ÅÜ„Å™Ê®°Êßò„ÇíÊåÅ„Å§',
                    type: 'lushu'
                });
            }
            
            // Ë≤çÂäõ„ÅÆÊäΩÂá∫
            if (text.includes('Ë≤çÂäõ')) {
                creatures.push({
                    name: 'Ë≤çÂäõÔºà„Çä„Çä„Çá„ÅèÔºâ',
                    description: 'Ë±ö„Å´‰ºº„ÅüÂΩ¢„ÅßËπ¥Áà™„ÇíÊåÅ„Å°„ÄÅÁä¨„ÅåÂê†„Åà„Çã„Çà„ÅÜ„Å™Â£∞„ÇíÂá∫„Åô',
                    type: 'lushu' // ‰∏ÄÊôÇÁöÑ„Å´ÈπøËúÄ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çí‰ΩøÁî®
                });
            }
            
            // È≥≥Âá∞„ÅÆÊäΩÂá∫
            if (text.includes('È≥≥Áöá')) {
                creatures.push({
                    name: 'È≥≥ÁöáÔºà„Åª„ÅÜ„Åä„ÅÜÔºâ',
                    description: 'È¥üÔºà„Å®„Å≥Ôºâ„ÅÆ„Çà„ÅÜ„Å™ÂΩ¢„Åß‰∫∫„ÅÆÈ†≠„ÇíÊåÅ„Å§',
                    type: 'phoenix'
                });
            }
            
            return creatures;
        }

        function extractProperties(chapterData) {
            const properties = [];
            const text = chapterData.japanese;
            
            if (text.includes('Á•ùÈ§ò')) {
                properties.push({
                    item: 'Á•ùÈ§òÔºà„Åó„ÇÖ„Åè„ÇàÔºâ',
                    effect: 'È£ü„Åπ„Çã„Å®È£¢„Åà„Çã„Åì„Å®„Åå„Å™„ÅÑ',
                    type: 'plant_effect'
                });
            }
            
            if (text.includes('Ëø∑Á©Ä')) {
                properties.push({
                    item: 'Ëø∑Á©ÄÔºà„ÇÅ„ÅÑ„Åì„ÅèÔºâ',
                    effect: 'Ë∫´„Å´„Å§„Åë„Çã„Å®ÈÅì„Å´Ëø∑„Çè„Å™„ÅÑ',
                    type: 'plant_effect'
                });
            }
            
            if (text.includes('ËÇ≤Ê≤õ')) {
                properties.push({
                    item: 'ËÇ≤Ê≤õÔºà„ÅÑ„Åè„ÅØ„ÅÑÔºâ',
                    effect: 'Ë∫´„Å´„Å§„Åë„Çã„Å®ÁóÖÊ∞ó„Å´„Åã„Åã„Çâ„Å™„ÅÑ',
                    type: 'plant_effect'
                });
            }
            
            return properties;
        }

        function extractMountainFeatures(chapterData) {
            const features = [];
            const text = chapterData.japanese;
            
            if (text.includes('Ë•ø„ÅÆÊµ∑„ÇíË¶ã‰∏ã„Çç„Åó')) {
                features.push('Ë•ø„ÅÆÊµ∑„ÇíË¶ã‰∏ã„Çç„Åô‰ΩçÁΩÆ„Å´„ÅÇ„Çã');
            }
            
            if (text.includes('Ê°Ç„ÅÆÊú®„ÅåÂ§ö„Åè')) {
                features.push('Ê°Ç„ÅÆÊú®„ÅåÂ§ö„ÅèÁîü„Åà„Å¶„ÅÑ„Çã');
            }
            
            if (text.includes('Èáë„ÇÑÁéâ„ÇÇË±äÂØå')) {
                features.push('Èáë„ÇÑÁéâ„ÅåË±äÂØå„Å´Áî£Âá∫„Åï„Çå„Çã');
            }
            
            return features;
        }

        function extractLocations(chapterData) {
            const locations = [];
            const text = chapterData.japanese;
            
            const riverMatch = text.match(/(.+?)„Å®„ÅÑ„ÅÜÂ∑ù„Åå.+?ÊµÅ„Çå.+?([^„Å´]+?)„Å´Ê≥®„Åê/);
            if (riverMatch) {
                locations.push({
                    river: riverMatch[1],
                    destination: riverMatch[2]
                });
            }
            
            // „Éá„Éï„Ç©„É´„ÉàÂÄ§
            if (locations.length === 0 && text.includes('Êµ∑„Å´Ê≥®„Åê')) {
                locations.push({
                    river: 'Â∑ù',
                    destination: 'Êµ∑'
                });
            }
            
            return locations;
        }

        // Á∑è„Éë„Ç∫„É´Êï∞„ÇíË®àÁÆó
        function calculateTotalPuzzles() {
            const puzzlesPerChapter = 3;
            return gameState.chapters.length * puzzlesPerChapter;
        }

        // „Ç≤„Éº„É†ÈñãÂßãÈñ¢Êï∞
        function startGame() {
            gameState.currentChapter = 0;
            gameState.currentPuzzle = 0;
            gameState.completedPuzzles = 0;
            gameState.score = 0;
            gameState.clues = [];
            gameState.chapters = window.SHANHAIJING_COMPLETE.nanshan.chapters;
            gameState.totalPuzzles = calculateTotalPuzzles();
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
            gameState.animations = {
                detective: 'detective',
                creature: null,
                extras: []
            };
            
            loadChapter(0);
            updateProgress();
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„ÉóÈñãÂßã
            requestAnimationFrame(animate);
        }

        // Á´†„ÅÆË™≠„ÅøËæº„Åø
        function loadChapter(chapterIndex) {
            if (chapterIndex >= gameState.chapters.length) {
                showGameComplete();
                return;
            }
            
            const chapter = gameState.chapters[chapterIndex];
            gameState.currentChapter = chapterIndex;
            gameState.currentPuzzle = 0;
            
            // UIÊõ¥Êñ∞
            document.getElementById('chapterTitle').textContent = chapter.title;
            document.getElementById('textDisplay').innerHTML = `
                <p>${chapter.japanese}</p>
                <div class="original-text">
                    <strong>ÂéüÊñáÔºö</strong>${chapter.original}
                </div>
            `;
            
            // Á´†„Å´Èñ¢ÈÄ£„Åô„ÇãÁîü„ÅçÁâ©„ÇíË®≠ÂÆö
            const creatures = extractCreatures(chapter);
            if (creatures.length > 0) {
                gameState.animations.creature = creatures[0];
            } else {
                gameState.animations.creature = null;
            }
            
            // ÊúÄÂàù„ÅÆ„Éë„Ç∫„É´„ÇíË°®Á§∫
            showNextPuzzle();
        }

        // Ê¨°„ÅÆ„Éë„Ç∫„É´„ÇíË°®Á§∫
        function showNextPuzzle() {
            const chapter = gameState.chapters[gameState.currentChapter];
            const puzzle = generatePuzzle(chapter, gameState.currentPuzzle);
            
            if (!puzzle || gameState.currentPuzzle >= 3) {
                // „Éë„Ç∫„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊ¨°„ÅÆÁ´†„Å∏
                loadChapter(gameState.currentChapter + 1);
                return;
            }
            
            displayPuzzle(puzzle);
        }

        // „Éë„Ç∫„É´„ÅÆË°®Á§∫
        function displayPuzzle(puzzle) {
            const puzzleArea = document.getElementById('puzzleArea');
            
            // ÁèæÂú®„ÅÆ„Éë„Ç∫„É´Áï™Âè∑„ÇíË®àÁÆó
            const currentPuzzleNumber = gameState.currentChapter * 3 + gameState.currentPuzzle + 1;
            
            let puzzleHTML = `
                <h3 class="puzzle-title">
                    <span class="puzzle-icon">üß©</span>
                    <span>Ë¨éËß£„Åç ${gameState.currentPuzzle + 1}</span>
                    <span class="puzzle-progress">(${currentPuzzleNumber} / ${gameState.totalPuzzles})</span>
                </h3>
                <div class="quiz-question">${puzzle.question}</div>
                <div class="quiz-options">
            `;
            
            puzzle.options.forEach((option, index) => {
                puzzleHTML += `
                    <div class="quiz-option" 
                         data-option="${option}" 
                         data-index="${index}"
                         onmouseover="previewAnimation(this, '${puzzle.type}', ${index})"
                         onmouseout="hidePreview()"
                         onclick="checkAnswer('${option}', '${puzzle.correct}', this, '${puzzle.type}')">
                        ${option}
                    </div>
                `;
            });
            
            puzzleHTML += `
                </div>
                <button class="hint-button" onclick="showHint('${puzzle.hint}')">„Éí„É≥„Éà„ÇíË¶ã„Çã</button>
                <div class="hint-box" id="hintBox"></div>
            `;
            
            puzzleArea.innerHTML = puzzleHTML;
            
            // „Éë„Ç∫„É´„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
            if (puzzle.type === 'creature' && puzzle.creatureData) {
                gameState.animations.creature = puzzle.creatureData;
            } else if (puzzle.type === 'property' && puzzle.propertyData) {
                gameState.animations.creature = {
                    type: 'plant_effect',
                    effect: puzzle.propertyData.effect
                };
            } else if (puzzle.type === 'location' && puzzle.locationData) {
                gameState.animations.creature = {
                    type: 'direction',
                    direction: puzzle.locationData.direction
                };
            }
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éó„É¨„Éì„É•„Éº
        function previewAnimation(element, puzzleType, optionIndex) {
            const preview = document.querySelector('.animation-preview');
            const rect = element.getBoundingClientRect();
            
            preview.style.display = 'block';
            preview.style.left = '50%';
            
            // „Éó„É¨„Éì„É•„Éº„Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            
            // „Ç™„Éó„Ç∑„Éß„É≥„Å´Âü∫„Å•„ÅÑ„Å¶Á∞°Âçò„Å™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫
            if (puzzleType === 'creature') {
                drawStickFigure(previewCtx, 50, 70, 'detective', animationFrame * 2, 0.6);
            } else if (puzzleType === 'property') {
                drawCreature(previewCtx, 50, 70, { type: 'plant_effect', effect: '?' }, animationFrame * 2, 0.6);
            } else if (puzzleType === 'location') {
                const directions = ['east', 'north', 'west', 'south'];
                drawCreature(previewCtx, 50, 70, { type: 'direction', direction: directions[optionIndex] }, animationFrame * 2, 0.6);
            }
        }

        // „Éó„É¨„Éì„É•„Éº„ÇíÈö†„Åô
        function hidePreview() {
            document.querySelector('.animation-preview').style.display = 'none';
        }

        // Á≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAnswer(selected, correct, element, puzzleType) {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(opt => {
                opt.onclick = null;
                opt.onmouseover = null;
                opt.onmouseout = null;
            });
            
            if (selected === correct) {
                element.classList.add('correct');
                gameState.score += 100;
                gameState.completedPuzzles++;
                updateScore();
                updateProgress();
                
                // Ê≠£Ëß£„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                gameState.animations.detective = 'celebration';
                gameState.animations.extras = [
                    { type: 'celebration', x: 250, y: canvas.height / 2 + 50 },
                    { type: 'celebration', x: 350, y: canvas.height / 2 + 50 }
                ];
                
                // Êâã„Åå„Åã„Çä„ÇíËøΩÂä†
                addClue(`${gameState.chapters[gameState.currentChapter].title}„ÅÆË¨é„ÇíËß£ÊòéÔºÅ`);
                
                setTimeout(() => {
                    gameState.animations.detective = 'detective';
                    gameState.animations.extras = [];
                    gameState.currentPuzzle++;
                    
                    if (gameState.currentPuzzle >= 3) {
                        // Á´†„ÇØ„É™„Ç¢
                        showChapterComplete();
                    } else {
                        showNextPuzzle();
                    }
                }, 2000);
            } else {
                element.classList.add('incorrect');
                gameState.score = Math.max(0, gameState.score - 20);
                updateScore();
                
                // ‰∏çÊ≠£Ëß£„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                gameState.animations.detective = 'wrong';
                
                // Ê≠£Ëß£„ÇíË°®Á§∫
                options.forEach(opt => {
                    if (opt.textContent.trim() === correct) {
                        opt.classList.add('correct');
                    }
                });
                
                setTimeout(() => {
                    gameState.animations.detective = 'detective';
                    gameState.currentPuzzle++;
                    
                    if (gameState.currentPuzzle >= 3) {
                        showChapterComplete();
                    } else {
                        showNextPuzzle();
                    }
                }, 2500);
            }
        }

        // „Éí„É≥„ÉàË°®Á§∫
        function showHint(hint) {
            const hintBox = document.getElementById('hintBox');
            hintBox.style.display = 'block';
            hintBox.innerHTML = `<strong>„Éí„É≥„ÉàÔºö</strong> ${hint}`;
            
            // „Çπ„Ç≥„Ç¢„ÇíÂ∞ë„ÅóÊ∏õ„Çâ„Åô
            gameState.score = Math.max(0, gameState.score - 10);
            updateScore();
        }

        // Êâã„Åå„Åã„Çä„ÇíËøΩÂä†
        function addClue(clue) {
            gameState.clues.push(clue);
            updateClueList();
        }

        // Êâã„Åå„Åã„Çä„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateClueList() {
            const clueList = document.getElementById('clueList');
            clueList.innerHTML = gameState.clues.map(clue => 
                `<li class="clue-item">${clue}</li>`
            ).join('');
        }

        // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
        function updateScore() {
            document.getElementById('scoreValue').textContent = gameState.score;
        }

        // ÈÄ≤Ë°åÁä∂Ê≥ÅÊõ¥Êñ∞
        function updateProgress() {
            const progressPercent = (gameState.completedPuzzles / gameState.totalPuzzles) * 100;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = progressPercent + '%';
            progressFill.textContent = Math.round(progressPercent) + '%';
            progressText.textContent = `${gameState.completedPuzzles} / ${gameState.totalPuzzles} „Éë„Ç∫„É´ÂÆå‰∫Ü`;
        }

        // Á´†„ÇØ„É™„Ç¢Ë°®Á§∫
        function showChapterComplete() {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <h2 style="color: #8b4513; margin-bottom: 20px;">Á´†„ÇØ„É™„Ç¢ÔºÅ</h2>
                <p style="font-size: 1.2em; margin-bottom: 20px;">
                    ${gameState.chapters[gameState.currentChapter].title}„ÅÆË¨é„ÇíËß£„ÅçÊòé„Åã„Åó„Åæ„Åó„ÅüÔºÅ
                </p>
                <p style="color: #666; margin-bottom: 20px;">
                    Áç≤Âæó„Çπ„Ç≥„Ç¢: +300
                </p>
                <button class="control-button" onclick="closeModal(); loadChapter(${gameState.currentChapter + 1});">
                    Ê¨°„ÅÆÁ´†„Å∏ÈÄ≤„ÇÄ
                </button>
            `;
            
            modal.style.display = 'flex';
            gameState.score += 300;
            updateScore();
        }

        // „Ç≤„Éº„É†ÂÆå‰∫ÜË°®Á§∫
        function showGameComplete() {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            const completionRate = Math.round((gameState.completedPuzzles / gameState.totalPuzzles) * 100);
            
            modalContent.innerHTML = `
                <h2 style="color: #8b4513; margin-bottom: 20px;">üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ üéâ</h2>
                <p style="font-size: 1.2em; margin-bottom: 20px;">
                    ÂçóÂ±±Áµå„ÅÆ„Åô„Åπ„Å¶„ÅÆË¨é„ÇíËß£„ÅçÊòé„Åã„Åó„Åæ„Åó„ÅüÔºÅ
                </p>
                <p style="font-size: 1.5em; color: #8b4513; margin-bottom: 20px;">
                    ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${gameState.score}
                </p>
                <p style="color: #666; margin-bottom: 10px;">
                    ÂÆå‰∫ÜÁéá: ${completionRate}%
                </p>
                <p style="color: #666; margin-bottom: 20px;">
                    ÈõÜ„ÇÅ„ÅüÊâã„Åå„Åã„Çä: ${gameState.clues.length}ÂÄã
                </p>
                <button class="control-button" onclick="location.reload();">
                    „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§
                </button>
            `;
            
            modal.style.display = 'flex';
            
            // Ëä±ÁÅ´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            gameState.animations.extras = [];
            for (let i = 0; i < 5; i++) {
                gameState.animations.extras.push({
                    type: 'celebration',
                    x: 100 + i * 150,
                    y: canvas.height / 2
                });
            }
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // ÂàùÊúüÊèèÁîª
        window.addEventListener('load', () => {
            // ÂàùÊúüÁîªÈù¢„Å´Êé¢ÂÅµ„ÇíÊèèÁîª
            requestAnimationFrame(animate);
        });

        // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // „ÇØ„É™„ÉÉ„ÇØ‰ΩçÁΩÆ„Å´‰∏ÄÊôÇÁöÑ„Å™„Ç®„Éï„Çß„ÇØ„Éà
            gameState.animations.extras.push({
                type: 'celebration',
                x: x,
                y: y,
                duration: 30
            });
            
            // 30„Éï„É¨„Éº„É†Âæå„Å´ÂâäÈô§
            setTimeout(() => {
                gameState.animations.extras = gameState.animations.extras.filter(e => e.duration !== 30);
            }, 500);
        });
    </script>
</body>
</html>