<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  - ç¥è©±ç‰©èªã®è‡ªå‹•ã‚¢ãƒ‹ãƒ¡åŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-container {
            flex: 1;
            display: flex;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        .input-section {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .story-input {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .story-textarea {
            width: 100%;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            padding: 15px;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .story-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .story-textarea:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.15);
        }

        .template-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .template-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border: none;
            border-radius: 10px;
            color: #333;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .analysis-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .analysis-section {
            margin-bottom: 20px;
        }

        .analysis-section h4 {
            color: #4ade80;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tag.character { border-color: #ff6b6b; color: #ff6b6b; }
        .tag.action { border-color: #4ecdc4; color: #4ecdc4; }
        .tag.scene { border-color: #ffe66d; color: #ffe66d; }
        .tag.prop { border-color: #a8e6cf; color: #a8e6cf; }

        .timeline {
            margin-top: 15px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .timeline-number {
            background: #4ecdc4;
            color: #333;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            margin-right: 15px;
        }

        .animation-canvas {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canvas-title {
            font-size: 1.5em;
            color: #ffd700;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #ffd700;
        }

        .control-btn.active {
            background: #ffd700;
            color: #333;
            border-color: #ffd700;
        }

        canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .narration-box {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .narration-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #f0f0f0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffb347 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
        }

        .demo-examples {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .example-item {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #4ecdc4;
        }

        .example-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .example-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .example-desc {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .input-section {
                width: 100%;
            }
        }

        .loading {
            display: none;
            text-align: center;
            color: #ffd700;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ­ ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>æ–‡å­—ã§ç¥è©±ç‰©èªã‚’æãã€ç«æŸ´äººã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡¨ç¾ã™ã‚‹</p>
    </div>

    <div class="main-container">
        <div class="input-section">
            <!-- æ•…äº‹è¼¸å…¥ -->
            <div class="story-input">
                <h3 class="section-title">
                    <span>ğŸ“</span>
                    <span>ç‰©èªã‚’å…¥åŠ›</span>
                </h3>
                <textarea class="story-textarea" id="storyInput" placeholder="ç‰©èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...

ä¾‹:
å¤¸çˆ¶ã¯å¤ªé™½ã‚’è¿½ã„ã‹ã‘ã¦èµ°ã‚‹ã€‚å±±ã‚’è¶Šãˆã€å·ã‚’æ¸¡ã‚Šã€ã¤ã„ã«ç–²ã‚Œæœã¦ã¦å€’ã‚Œã‚‹ã€‚

å“ªå’ã¯æµ·è¾ºã§éŠã‚“ã§ã„ã‚‹ã€‚æ··å¤©ç¶¾ã‚’æŒ¯ã‚‹ã¨æµ·ãŒæºã‚Œã‚‹ã€‚é¾ç‹ã®æ¯å­ãŒç¾ã‚Œã€äºŒäººã¯æ¿€ã—ãæˆ¦ã†ã€‚

ç´ æˆ”å—šå°Šã¯å…«å²å¤§è›‡ã¨å¯¾å³™ã™ã‚‹ã€‚å‰£ã‚’æŠœã„ã¦å‹‡æ•¢ã«ç«‹ã¡å‘ã‹ã†ã€‚"></textarea>

                <div class="template-buttons">
                    <button class="template-btn" onclick="loadTemplate('kuafu')">å¤¸çˆ¶é€æ—¥</button>
                    <button class="template-btn" onclick="loadTemplate('nezha')">å“ªå’é¬§æµ·</button>
                    <button class="template-btn" onclick="loadTemplate('susanoo')">ç´ æˆ”å—šå°Š</button>
                    <button class="template-btn" onclick="loadTemplate('chang_e')">å«¦å¨¥å¥”æœˆ</button>
                </div>

                <button class="generate-btn" onclick="generateAnimation()">
                    ğŸ¬ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
                </button>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <span>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆä¸­...</span>
                </div>
            </div>

            <!-- è§£æçµæœ -->
            <div class="analysis-panel">
                <h3 class="section-title">
                    <span>ğŸ”</span>
                    <span>è§£æçµæœ</span>
                </h3>

                <div class="analysis-section">
                    <h4>æ¤œå‡ºã•ã‚ŒãŸè¦ç´ :</h4>
                    <div class="tag-list" id="detectedElements">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>
                </div>

                <div class="analysis-section">
                    <h4>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³:</h4>
                    <div class="timeline" id="timeline">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <!-- è¨­å®š -->
            <div class="settings-panel">
                <h3 class="section-title">
                    <span>âš™ï¸</span>
                    <span>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</span>
                </h3>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>å†ç”Ÿé€Ÿåº¦</span>
                        <span id="speedValue">1.0x</span>
                    </div>
                    <input type="range" class="slider" id="speedSlider" 
                           min="0.5" max="3" step="0.1" value="1">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>è¡¨ç¾åº¦</span>
                        <span id="expressionValue">100%</span>
                    </div>
                    <input type="range" class="slider" id="expressionSlider" 
                           min="50" max="150" step="10" value="100">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>ã‚«ãƒ¡ãƒ©è·é›¢</span>
                        <span id="zoomValue">1.0x</span>
                    </div>
                    <input type="range" class="slider" id="zoomSlider" 
                           min="0.5" max="2" step="0.1" value="1">
                </div>
            </div>

            <!-- ç¯„ä¾‹ -->
            <div class="demo-examples">
                <h3 class="section-title">
                    <span>ğŸ’¡</span>
                    <span>å‚è€ƒä¾‹æ–‡</span>
                </h3>

                <div class="example-item" onclick="loadExample(this)">
                    <div class="example-title">å¤¸çˆ¶é€æ—¥</div>
                    <div class="example-desc">å¤¸çˆ¶ã¯å¤ªé™½ã‚’è¿½ã„ã‹ã‘ã¦å¤§åœ°ã‚’é§†ã‘æŠœã‘ã€æœ€å¾Œã«æ¡ƒã®æ£®ã«ãªã‚‹æ„Ÿå‹•çš„ãªç‰©èª</div>
                </div>

                <div class="example-item" onclick="loadExample(this)">
                    <div class="example-title">å…«å²å¤§è›‡é€€æ²»</div>
                    <div class="example-desc">ç´ æˆ”å—šå°ŠãŒå·¨å¤§ãªå…«ã¤é ­ã®è›‡ã‚’é€€æ²»ã—ã€è‰è–™å‰£ã‚’æ‰‹ã«å…¥ã‚Œã‚‹è‹±é›„è­š</div>
                </div>

                <div class="example-item" onclick="loadExample(this)">
                    <div class="example-title">ç²¾è¡›å¡«æµ·</div>
                    <div class="example-desc">å°é³¥ã®ç²¾è¡›ãŒæµ·ã‚’åŸ‹ã‚ã‚ˆã†ã¨å°çŸ³ã‚’é‹ã³ç¶šã‘ã‚‹ä¸å±ˆã®ç²¾ç¥ã®ç‰©èª</div>
                </div>
            </div>
        </div>

        <div class="animation-canvas">
            <div class="canvas-header">
                <h3 class="canvas-title">ğŸ¬ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸</h3>
                <div class="playback-controls">
                    <button class="control-btn" id="playBtn" onclick="togglePlayback()">
                        â–¶ å†ç”Ÿ
                    </button>
                    <button class="control-btn" onclick="restartAnimation()">
                        â® æœ€åˆã‹ã‚‰
                    </button>
                    <button class="control-btn" onclick="exportAnimation()">
                        ğŸ’¾ ä¿å­˜
                    </button>
                </div>
            </div>

            <canvas id="animationCanvas"></canvas>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="narration-box">
                <div class="narration-text" id="narrationText">
                    ç‰©èªã‚’å…¥åŠ›ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ–‡æœ¬è§£æå¼•æ“ ====================
        
        class TextAnalyzer {
            constructor() {
                this.setupDictionaries();
            }
            
            setupDictionaries() {
                // è§’è‰²è©å…¸
                this.characters = {
                    'å¤¸çˆ¶': { type: 'giant', color: '#ff6b6b', scale: 1.3 },
                    'å“ªå’': { type: 'child_god', color: '#ffd700', scale: 0.8 },
                    'æ•–ä¸™': { type: 'dragon_prince', color: '#4169e1', scale: 1.1 },
                    'ç´ æˆ”å—šå°Š': { type: 'storm_god', color: '#8b00ff', scale: 1.2 },
                    'å…«å²å¤§è›‡': { type: 'serpent', color: '#228b22', scale: 2.0 },
                    'å«¦å¨¥': { type: 'moon_goddess', color: '#c0c0c0', scale: 0.9 },
                    'åç¾¿': { type: 'archer', color: '#8b4513', scale: 1.1 },
                    'ç²¾è¡›': { type: 'bird', color: '#4ecdc4', scale: 0.5 },
                    'ç›¤å¤': { type: 'creator', color: '#2f4f4f', scale: 1.5 }
                };
                
                // å‹•ä½œè©å…¸
                this.actions = {
                    'èµ°ã‚‹': { animation: 'run', intensity: 1.0 },
                    'è¿½ã†': { animation: 'chase', intensity: 1.2 },
                    'è¿½ã„ã‹ã‘ã‚‹': { animation: 'chase', intensity: 1.2 },
                    'é£›ã¶': { animation: 'fly', intensity: 0.8 },
                    'æˆ¦ã†': { animation: 'fight', intensity: 1.5 },
                    'æ”»æ’ƒ': { animation: 'attack', intensity: 1.3 },
                    'é˜²ã': { animation: 'defend', intensity: 0.7 },
                    'ç«‹ã¤': { animation: 'stand', intensity: 0.3 },
                    'åº§ã‚‹': { animation: 'sit', intensity: 0.2 },
                    'å€’ã‚Œã‚‹': { animation: 'fall', intensity: 0.5 },
                    'è¸Šã‚‹': { animation: 'dance', intensity: 0.6 },
                    'æ³³ã': { animation: 'swim', intensity: 0.8 },
                    'ç™»ã‚‹': { animation: 'climb', intensity: 1.1 },
                    'å°„ã‚‹': { animation: 'shoot', intensity: 1.0 },
                    'æŒ¯ã‚‹': { animation: 'swing', intensity: 0.9 },
                    'æŠœã': { animation: 'draw', intensity: 0.8 },
                    'æŠ•ã’ã‚‹': { animation: 'throw', intensity: 1.0 },
                    'é‹ã¶': { animation: 'carry', intensity: 0.7 }
                };
                
                // å ´æ™¯è©å…¸
                this.scenes = {
                    'å±±': { background: 'mountain', props: ['trees', 'rocks'] },
                    'æµ·': { background: 'ocean', props: ['waves', 'clouds'] },
                    'å¤©ç©º': { background: 'sky', props: ['clouds', 'sun'] },
                    'æ£®': { background: 'forest', props: ['trees', 'bushes'] },
                    'å®®æ®¿': { background: 'palace', props: ['pillars', 'throne'] },
                    'å·': { background: 'river', props: ['water', 'stones'] },
                    'ç ‚æ¼ ': { background: 'desert', props: ['dunes', 'sun'] },
                    'æœˆ': { background: 'moon', props: ['stars', 'craters'] },
                    'åœ°åº•': { background: 'underground', props: ['rocks', 'gems'] },
                    'é›²': { background: 'clouds', props: ['mist', 'wind'] }
                };
                
                // é“å…·è©å…¸
                this.props = {
                    'å¤ªé™½': { type: 'celestial', color: '#ffd700', size: 'large' },
                    'æœˆ': { type: 'celestial', color: '#c0c0c0', size: 'large' },
                    'å‰£': { type: 'weapon', color: '#c0c0c0', size: 'medium' },
                    'å¼“': { type: 'weapon', color: '#8b4513', size: 'medium' },
                    'æ··å¤©ç¶¾': { type: 'magic_cloth', color: '#ff69b4', size: 'flowing' },
                    'ä¹¾å¤åœ': { type: 'magic_ring', color: '#ffd700', size: 'small' },
                    'çŸ³': { type: 'natural', color: '#808080', size: 'small' },
                    'æœ¨': { type: 'natural', color: '#228b22', size: 'large' },
                    'æ°´': { type: 'natural', color: '#4682b4', size: 'flowing' },
                    'ç«': { type: 'natural', color: '#ff4500', size: 'dancing' }
                };
                
                // æƒ…æ„Ÿè©å…¸
                this.emotions = {
                    'æ€’ã‚Š': { intensity: 1.5, color: '#ff0000' },
                    'æ‚²ã—ã¿': { intensity: 0.5, color: '#4169e1' },
                    'å–œã³': { intensity: 1.2, color: '#ffd700' },
                    'ææ€–': { intensity: 0.8, color: '#800080' },
                    'å‹‡æ°—': { intensity: 1.3, color: '#ff6347' },
                    'æ„›': { intensity: 0.9, color: '#ff69b4' },
                    'æ±ºæ„': { intensity: 1.1, color: '#2e8b57' }
                };
            }
            
            analyze(text) {
                const result = {
                    characters: [],
                    actions: [],
                    scenes: [],
                    props: [],
                    timeline: [],
                    rawText: text
                };
                
                // åˆ†å¥è™•ç†
                const sentences = text.split(/[ã€‚ï¼.!ï¼?ï¼Ÿ\n]/).filter(s => s.trim());
                
                sentences.forEach((sentence, index) => {
                    const sceneData = this.analyzeSentence(sentence.trim(), index);
                    if (sceneData.hasContent) {
                        result.timeline.push(sceneData);
                    }
                });
                
                // æå–æ‰€æœ‰å…ƒç´ 
                result.timeline.forEach(scene => {
                    scene.characters.forEach(char => {
                        if (!result.characters.find(c => c.name === char)) {
                            result.characters.push({ name: char, ...this.characters[char] });
                        }
                    });
                    
                    scene.actions.forEach(action => {
                        if (!result.actions.find(a => a.name === action)) {
                            result.actions.push({ name: action, ...this.actions[action] });
                        }
                    });
                    
                    scene.scenes.forEach(scene_name => {
                        if (!result.scenes.find(s => s.name === scene_name)) {
                            result.scenes.push({ name: scene_name, ...this.scenes[scene_name] });
                        }
                    });
                    
                    scene.props.forEach(prop => {
                        if (!result.props.find(p => p.name === prop)) {
                            result.props.push({ name: prop, ...this.props[prop] });
                        }
                    });
                });
                
                return result;
            }
            
            analyzeSentence(sentence, index) {
                const sceneData = {
                    id: index,
                    text: sentence,
                    characters: [],
                    actions: [],
                    scenes: [],
                    props: [],
                    duration: 3000, // é è¨­3ç§’
                    hasContent: false
                };
                
                // æª¢æ¸¬è§’è‰²
                for (const character in this.characters) {
                    if (sentence.includes(character)) {
                        sceneData.characters.push(character);
                        sceneData.hasContent = true;
                    }
                }
                
                // æª¢æ¸¬å‹•ä½œ
                for (const action in this.actions) {
                    if (sentence.includes(action)) {
                        sceneData.actions.push(action);
                        sceneData.hasContent = true;
                    }
                }
                
                // æª¢æ¸¬å ´æ™¯
                for (const scene in this.scenes) {
                    if (sentence.includes(scene)) {
                        sceneData.scenes.push(scene);
                        sceneData.hasContent = true;
                    }
                }
                
                // æª¢æ¸¬é“å…·
                for (const prop in this.props) {
                    if (sentence.includes(prop)) {
                        sceneData.props.push(prop);
                        sceneData.hasContent = true;
                    }
                }
                
                // æ ¹æ“šå‹•ä½œèª¿æ•´æŒçºŒæ™‚é–“
                sceneData.actions.forEach(action => {
                    const actionData = this.actions[action];
                    if (actionData) {
                        sceneData.duration = Math.max(sceneData.duration, actionData.intensity * 2000);
                    }
                });
                
                return sceneData;
            }
        }

        // ==================== è§’è‰²ç³»çµ± ====================
        
        class Character {
            constructor(name, data, x = 0, y = 0) {
                this.name = name;
                this.type = data.type || 'human';
                this.color = data.color || '#333';
                this.scale = data.scale || 1.0;
                this.x = x;
                this.y = y;
                this.targetX = x;
                this.targetY = y;
                this.currentAnimation = 'idle';
                this.animationTime = 0;
                this.props = [];
                
                // å‹•ä½œç‹€æ…‹
                this.limbAngles = {
                    leftArm: 0,
                    rightArm: 0,
                    leftLeg: 0,
                    rightLeg: 0,
                    body: 0,
                    head: 0
                };
                
                this.setupAnimations();
            }
            
            setupAnimations() {
                this.animations = {
                    idle: {
                        duration: 2000,
                        keyframes: [
                            { time: 0, leftArm: 0.2, rightArm: -0.2, leftLeg: 0, rightLeg: 0, body: 0 },
                            { time: 1000, leftArm: 0.25, rightArm: -0.25, leftLeg: 0.05, rightLeg: -0.05, body: 0.02 },
                            { time: 2000, leftArm: 0.2, rightArm: -0.2, leftLeg: 0, rightLeg: 0, body: 0 }
                        ]
                    },
                    run: {
                        duration: 600,
                        keyframes: [
                            { time: 0, leftArm: 0.8, rightArm: -0.8, leftLeg: 0.6, rightLeg: -0.6, body: 0.1 },
                            { time: 300, leftArm: -0.8, rightArm: 0.8, leftLeg: -0.6, rightLeg: 0.6, body: 0.1 },
                            { time: 600, leftArm: 0.8, rightArm: -0.8, leftLeg: 0.6, rightLeg: -0.6, body: 0.1 }
                        ]
                    },
                    fight: {
                        duration: 800,
                        keyframes: [
                            { time: 0, leftArm: -0.5, rightArm: 1.2, leftLeg: 0.2, rightLeg: -0.2, body: -0.1 },
                            { time: 200, leftArm: -0.3, rightArm: 0.8, leftLeg: 0.3, rightLeg: -0.3, body: 0.2 },
                            { time: 400, leftArm: 0.5, rightArm: -1.0, leftLeg: -0.2, rightLeg: 0.2, body: -0.1 },
                            { time: 800, leftArm: -0.5, rightArm: 1.2, leftLeg: 0.2, rightLeg: -0.2, body: -0.1 }
                        ]
                    },
                    fly: {
                        duration: 1000,
                        keyframes: [
                            { time: 0, leftArm: -1.2, rightArm: -1.2, leftLeg: -0.3, rightLeg: -0.3, body: 0.1 },
                            { time: 500, leftArm: -0.8, rightArm: -0.8, leftLeg: -0.1, rightLeg: -0.1, body: 0.05 },
                            { time: 1000, leftArm: -1.2, rightArm: -1.2, leftLeg: -0.3, rightLeg: -0.3, body: 0.1 }
                        ]
                    },
                    fall: {
                        duration: 1500,
                        keyframes: [
                            { time: 0, leftArm: 0.2, rightArm: -0.2, leftLeg: 0, rightLeg: 0, body: 0 },
                            { time: 500, leftArm: 0.8, rightArm: 0.8, leftLeg: -0.2, rightLeg: -0.2, body: -0.2 },
                            { time: 1000, leftArm: 1.5, rightArm: 1.5, leftLeg: 0.5, rightLeg: 0.5, body: 1.5 },
                            { time: 1500, leftArm: 1.5, rightArm: 1.5, leftLeg: 0.5, rightLeg: 0.5, body: 1.5 }
                        ]
                    }
                };
            }
            
            playAnimation(animationName) {
                if (this.animations[animationName]) {
                    this.currentAnimation = animationName;
                    this.animationTime = 0;
                }
            }
            
            update(deltaTime) {
                const animation = this.animations[this.currentAnimation];
                if (!animation) return;
                
                this.animationTime = (this.animationTime + deltaTime) % animation.duration;
                
                // æ‰¾åˆ°ç•¶å‰é—œéµå¹€
                const keyframes = animation.keyframes;
                let prevFrame = keyframes[0];
                let nextFrame = keyframes[1];
                
                for (let i = 0; i < keyframes.length - 1; i++) {
                    if (this.animationTime >= keyframes[i].time && 
                        this.animationTime <= keyframes[i + 1].time) {
                        prevFrame = keyframes[i];
                        nextFrame = keyframes[i + 1];
                        break;
                    }
                }
                
                // æ’å€¼è¨ˆç®—
                const frameDuration = nextFrame.time - prevFrame.time;
                const progress = (this.animationTime - prevFrame.time) / frameDuration;
                
                this.limbAngles.leftArm = this.lerp(prevFrame.leftArm, nextFrame.leftArm, progress);
                this.limbAngles.rightArm = this.lerp(prevFrame.rightArm, nextFrame.rightArm, progress);
                this.limbAngles.leftLeg = this.lerp(prevFrame.leftLeg, nextFrame.leftLeg, progress);
                this.limbAngles.rightLeg = this.lerp(prevFrame.rightLeg, nextFrame.rightLeg, progress);
                this.limbAngles.body = this.lerp(prevFrame.body, nextFrame.body, progress);
                
                // ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
                this.x += (this.targetX - this.x) * 0.05;
                this.y += (this.targetY - this.y) * 0.05;
            }
            
            lerp(a, b, t) {
                return a + (b - a) * t;
            }
            
            moveTo(x, y) {
                this.targetX = x;
                this.targetY = y;
            }
            
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(this.scale, this.scale);
                ctx.rotate(this.limbAngles.body);
                
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                
                // ç‰¹æ®Šé¡å‹æ¸²æŸ“
                if (this.type === 'bird') {
                    this.drawBird(ctx);
                } else if (this.type === 'serpent') {
                    this.drawSerpent(ctx);
                } else {
                    this.drawHuman(ctx);
                }
                
                // ç¹ªè£½é“å…·
                this.props.forEach(prop => this.drawProp(ctx, prop));
                
                ctx.restore();
            }
            
            drawHuman(ctx) {
                // é ­éƒ¨
                ctx.beginPath();
                ctx.arc(0, -60, 18, 0, Math.PI * 2);
                ctx.stroke();
                
                // æ ¹æ“šé¡å‹æ·»åŠ ç‰¹æ®Šç‰¹å¾µ
                if (this.type === 'child_god') {
                    // å“ªå’çš„è“®èŠ±è£é£¾
                    ctx.strokeStyle = '#ff69b4';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 6; i++) {
                        ctx.beginPath();
                        const angle = (Math.PI * 2 / 6) * i;
                        const x = Math.cos(angle) * 25;
                        const y = -60 + Math.sin(angle) * 25;
                        ctx.moveTo(0, -60);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                    }
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 4;
                }
                
                // èº«é«”
                ctx.beginPath();
                ctx.moveTo(0, -42);
                ctx.lineTo(0, 20);
                ctx.stroke();
                
                // å·¦è‡‚
                ctx.save();
                ctx.translate(0, -20);
                ctx.rotate(this.limbAngles.leftArm);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-30, 20);
                ctx.stroke();
                ctx.restore();
                
                // å³è‡‚
                ctx.save();
                ctx.translate(0, -20);
                ctx.rotate(this.limbAngles.rightArm);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(30, 20);
                ctx.stroke();
                ctx.restore();
                
                // å·¦è…¿
                ctx.save();
                ctx.translate(0, 20);
                ctx.rotate(this.limbAngles.leftLeg);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-20, 35);
                ctx.stroke();
                ctx.restore();
                
                // å³è…¿
                ctx.save();
                ctx.translate(0, 20);
                ctx.rotate(this.limbAngles.rightLeg);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(20, 35);
                ctx.stroke();
                ctx.restore();
            }
            
            drawBird(ctx) {
                // é³¥é¡çš„ç°¡åŒ–ç¹ªè£½
                ctx.beginPath();
                ctx.ellipse(0, 0, 15, 8, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ç¿…è†€
                const wingAngle = Math.sin(this.animationTime * 0.01) * 0.5;
                ctx.save();
                ctx.rotate(wingAngle);
                ctx.beginPath();
                ctx.ellipse(-12, -5, 10, 3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                
                ctx.save();
                ctx.rotate(-wingAngle);
                ctx.beginPath();
                ctx.ellipse(12, -5, 10, 3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
            
            drawSerpent(ctx) {
                // è›‡çš„ç°¡åŒ–ç¹ªè£½
                ctx.lineWidth = 8;
                const segments = 8;
                for (let i = 0; i < segments; i++) {
                    const x = i * 15;
                    const y = Math.sin(this.animationTime * 0.005 + i * 0.5) * 10;
                    
                    if (i === 0) {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // å¤šå€‹é ­éƒ¨
                for (let head = 0; head < 8; head++) {
                    const headX = -20 + head * 15;
                    const headY = -20;
                    ctx.beginPath();
                    ctx.arc(headX, headY, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            drawProp(ctx, prop) {
                // æ ¹æ“šé“å…·é¡å‹ç¹ªè£½
                ctx.save();
                ctx.strokeStyle = prop.color || '#666';
                ctx.fillStyle = prop.color || '#666';
                
                switch(prop.type) {
                    case 'weapon':
                        // æ­¦å™¨
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(20, -10);
                        ctx.lineTo(35, -25);
                        ctx.stroke();
                        break;
                    case 'magic_cloth':
                        // é­”æ³•å¸ƒåŒ¹
                        ctx.lineWidth = 3;
                        for (let i = 0; i < 50; i++) {
                            const x = 20 + i;
                            const y = -10 + Math.sin(this.animationTime * 0.01 + i * 0.2) * 5;
                            if (i === 0) {
                                ctx.beginPath();
                                ctx.moveTo(x, y);
                            } else {
                                ctx.lineTo(x, y);
                            }
                        }
                        ctx.stroke();
                        break;
                }
                
                ctx.restore();
            }
        }

        // ==================== å‹•ç•«ç®¡ç†å™¨ ====================
        
        class StoryAnimationManager {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.characters = new Map();
                this.scenes = [];
                this.currentSceneIndex = 0;
                this.sceneTime = 0;
                this.isPlaying = false;
                this.speed = 1.0;
                this.expressionLevel = 1.0;
                this.zoomLevel = 1.0;
                
                this.setupCanvas();
            }
            
            setupCanvas() {
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = 500;
            }
            
            loadStory(analysisResult) {
                this.characters.clear();
                this.scenes = analysisResult.timeline;
                this.currentSceneIndex = 0;
                this.sceneTime = 0;
                
                // å‰µå»ºè§’è‰²
                analysisResult.characters.forEach((charData, index) => {
                    const x = (this.canvas.width / (analysisResult.characters.length + 1)) * (index + 1);
                    const y = this.canvas.height / 2 + 50;
                    const character = new Character(charData.name, charData, x, y);
                    this.characters.set(charData.name, character);
                });
                
                this.startScene(0);
            }
            
            startScene(sceneIndex) {
                if (sceneIndex >= this.scenes.length) {
                    this.currentSceneIndex = 0;
                    sceneIndex = 0;
                }
                
                this.currentSceneIndex = sceneIndex;
                this.sceneTime = 0;
                
                const scene = this.scenes[sceneIndex];
                if (!scene) return;
                
                // ç‚ºè§’è‰²åˆ†é…å‹•ç•«å’Œä½ç½®
                scene.characters.forEach((charName, index) => {
                    const character = this.characters.get(charName);
                    if (character) {
                        // è¨­ç½®ä½ç½®
                        const totalChars = scene.characters.length;
                        const x = (this.canvas.width / (totalChars + 1)) * (index + 1);
                        character.moveTo(x, character.y);
                        
                        // è¨­ç½®å‹•ç•«
                        if (scene.actions.length > 0) {
                            const action = scene.actions[0];
                            const animMapping = {
                                'èµ°ã‚‹': 'run',
                                'è¿½ã†': 'run',
                                'è¿½ã„ã‹ã‘ã‚‹': 'run',
                                'é£›ã¶': 'fly',
                                'æˆ¦ã†': 'fight',
                                'æ”»æ’ƒ': 'fight',
                                'é˜²ã': 'idle',
                                'å€’ã‚Œã‚‹': 'fall',
                                'è¸Šã‚‹': 'idle',
                                'æŒ¯ã‚‹': 'fight'
                            };
                            
                            character.playAnimation(animMapping[action] || 'idle');
                        } else {
                            character.playAnimation('idle');
                        }
                    }
                });
                
                // æ›´æ–°UI
                document.getElementById('narrationText').textContent = scene.text;
                this.updateProgress();
            }
            
            update(deltaTime) {
                if (!this.isPlaying) return;
                
                const scene = this.scenes[this.currentSceneIndex];
                if (!scene) return;
                
                this.sceneTime += deltaTime * this.speed;
                
                // æ›´æ–°æ‰€æœ‰è§’è‰²
                this.characters.forEach(character => {
                    character.update(deltaTime * this.speed * this.expressionLevel);
                });
                
                // æª¢æŸ¥å ´æ™¯æ˜¯å¦çµæŸ
                if (this.sceneTime >= scene.duration) {
                    this.startScene(this.currentSceneIndex + 1);
                }
                
                this.updateProgress();
            }
            
            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç¹ªè£½èƒŒæ™¯
                this.drawBackground();
                
                // ç¹ªè£½è§’è‰²
                this.ctx.save();
                this.ctx.scale(this.zoomLevel, this.zoomLevel);
                this.ctx.translate(
                    (this.canvas.width * (1 - this.zoomLevel)) / (2 * this.zoomLevel),
                    (this.canvas.height * (1 - this.zoomLevel)) / (2 * this.zoomLevel)
                );
                
                this.characters.forEach(character => {
                    character.draw(this.ctx);
                });
                
                this.ctx.restore();
                
                // ç¹ªè£½ç‰¹æ•ˆ
                this.drawEffects();
            }
            
            drawBackground() {
                const scene = this.scenes[this.currentSceneIndex];
                if (!scene) return;
                
                // æ ¹æ“šå ´æ™¯é¡å‹é¸æ“‡èƒŒæ™¯
                const sceneType = scene.scenes[0];
                let gradient;
                
                switch(sceneType) {
                    case 'å±±':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#87CEEB');
                        gradient.addColorStop(1, '#228B22');
                        break;
                    case 'æµ·':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#87CEEB');
                        gradient.addColorStop(1, '#4682B4');
                        break;
                    case 'å¤©ç©º':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#FFD700');
                        gradient.addColorStop(1, '#87CEEB');
                        break;
                    default:
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#98FB98');
                        gradient.addColorStop(1, '#90EE90');
                }
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç¹ªè£½åœ°é¢
                this.ctx.fillStyle = '#8B4513';
                this.ctx.fillRect(0, this.canvas.height - 50, this.canvas.width, 50);
            }
            
            drawEffects() {
                const scene = this.scenes[this.currentSceneIndex];
                if (!scene) return;
                
                // ç¹ªè£½é“å…·
                scene.props.forEach(propName => {
                    this.drawSceneProp(propName);
                });
            }
            
            drawSceneProp(propName) {
                this.ctx.save();
                
                switch(propName) {
                    case 'å¤ªé™½':
                        this.ctx.fillStyle = '#FFD700';
                        this.ctx.beginPath();
                        this.ctx.arc(this.canvas.width - 100, 100, 40, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // é™½å…‰ç·š
                        this.ctx.strokeStyle = '#FFA500';
                        this.ctx.lineWidth = 3;
                        for (let i = 0; i < 12; i++) {
                            const angle = (Math.PI * 2 / 12) * i;
                            const x1 = (this.canvas.width - 100) + Math.cos(angle) * 50;
                            const y1 = 100 + Math.sin(angle) * 50;
                            const x2 = (this.canvas.width - 100) + Math.cos(angle) * 70;
                            const y2 = 100 + Math.sin(angle) * 70;
                            
                            this.ctx.beginPath();
                            this.ctx.moveTo(x1, y1);
                            this.ctx.lineTo(x2, y2);
                            this.ctx.stroke();
                        }
                        break;
                        
                    case 'æœˆ':
                        this.ctx.fillStyle = '#C0C0C0';
                        this.ctx.beginPath();
                        this.ctx.arc(100, 100, 35, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // æœˆçƒè¡¨é¢
                        this.ctx.fillStyle = '#A9A9A9';
                        this.ctx.beginPath();
                        this.ctx.arc(110, 90, 5, 0, Math.PI * 2);
                        this.ctx.arc(90, 110, 7, 0, Math.PI * 2);
                        this.ctx.arc(105, 115, 4, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                }
                
                this.ctx.restore();
            }
            
            updateProgress() {
                const totalScenes = this.scenes.length;
                const currentProgress = this.currentSceneIndex / totalScenes;
                const sceneProgress = this.sceneTime / (this.scenes[this.currentSceneIndex]?.duration || 1000);
                const totalProgress = (currentProgress + sceneProgress / totalScenes) * 100;
                
                document.getElementById('progressFill').style.width = Math.min(totalProgress, 100) + '%';
            }
            
            play() {
                this.isPlaying = true;
                document.getElementById('playBtn').innerHTML = 'â¸ ä¸€æ™‚åœæ­¢';
                document.getElementById('playBtn').classList.add('active');
            }
            
            pause() {
                this.isPlaying = false;
                document.getElementById('playBtn').innerHTML = 'â–¶ å†ç”Ÿ';
                document.getElementById('playBtn').classList.remove('active');
            }
            
            restart() {
                this.startScene(0);
                this.pause();
            }
            
            setSpeed(speed) {
                this.speed = speed;
            }
            
            setExpression(level) {
                this.expressionLevel = level;
            }
            
            setZoom(level) {
                this.zoomLevel = level;
            }
        }

        // ==================== ä¸»ç¨‹åºåˆå§‹åŒ– ====================
        
        // åˆå§‹åŒ–ç³»çµ±
        const canvas = document.getElementById('animationCanvas');
        const textAnalyzer = new TextAnalyzer();
        const animationManager = new StoryAnimationManager(canvas);
        
        let currentAnalysis = null;
        
        // é è¨­æ•…äº‹æ¨¡æ¿
        const storyTemplates = {
            kuafu: `å¤¸çˆ¶ã¯å¤ªé™½ã‚’è¿½ã„ã‹ã‘ã¦èµ°ã‚‹ã€‚å±±ã‚’è¶Šãˆã€å·ã‚’æ¸¡ã‚Šã€å¤§åœ°ã‚’é§†ã‘æŠœã‘ã‚‹ã€‚
ã¤ã„ã«æ¸‡ãã«è€ãˆãã‚Œãšã€é»„æ²³ã¨æ¸­æ°´ã‚’é£²ã¿å¹²ã™ã€‚
ãã‚Œã§ã‚‚è¶³ã‚Šãšã€åŒ—ã®å¤§æ¹–ã¸å‘ã‹ã†ãŒã€ã¤ã„ã«åŠ›å°½ãã¦å€’ã‚Œã‚‹ã€‚
å¤¸çˆ¶ã®æ–ã¯æ¡ƒã®æ£®ã¨ãªã‚Šã€æ°¸é ã«æ—…äººã‚’æ½¤ã™ã€‚`,
            
            nezha: `å“ªå’ã¯æµ·è¾ºã§æ··å¤©ç¶¾ã‚’æŒ¯ã£ã¦éŠã‚“ã§ã„ã‚‹ã€‚æµ·ãŒæ¿€ã—ãæºã‚Œã€é¾å®®ã¾ã§éœ‡å‹•ãŒä¼ã‚ã‚‹ã€‚
æ€’ã£ãŸé¾ç‹ã¯æ¯å­ã®æ•–ä¸™ã‚’æ´¾é£ã™ã‚‹ã€‚æ•–ä¸™ãŒç¾ã‚Œã€å“ªå’ã‚’å±è²¬ã™ã‚‹ã€‚
è‹¥ã„å“ªå’ã¯æ€’ã‚Šã€äºŒäººã¯æ¿€ã—ãæˆ¦ã†ã€‚ä¹¾å¤åœãŒé£›ã³äº¤ã„ã€æ··å¤©ç¶¾ãŒèˆã†ã€‚
ã¤ã„ã«å“ªå’ãŒå‹åˆ©ã—ã€æ•–ä¸™ã®é¾ç­‹ã‚’æŠœãå–ã‚‹ã€‚`,
            
            susanoo: `ç´ æˆ”å—šå°Šã¯å…«å²å¤§è›‡ã®å‰ã«ç«‹ã¡ã¯ã ã‹ã‚‹ã€‚å·¨å¤§ãªå…«ã¤ã®é ­ãŒå¤©ã‚’è¦†ã†ã€‚
å‹‡æ•¢ã«å‰£ã‚’æŠœãã€å¤§è›‡ã«ç«‹ã¡å‘ã‹ã†ã€‚æ¿€ã—ã„æˆ¦ã„ãŒå§‹ã¾ã‚‹ã€‚
é…’ã§å¤§è›‡ã‚’é…”ã‚ã›ã€éš™ã‚’çªã„ã¦å°¾ã‚’åˆ‡ã‚Šè½ã¨ã™ã€‚
å°¾ã®ä¸­ã‹ã‚‰è‰è–™å‰£ã‚’ç™ºè¦‹ã—ã€å§‰ã®å¤©ç…§å¤§ç¥ã«çŒ®ä¸Šã™ã‚‹ã€‚`,
            
            chang_e: `åç¾¿ã¯åå€‹ã®å¤ªé™½ã‚’å¼“ã§å°„è½ã¨ã—ã€ä¸è€ä¸æ­»ã®è–¬ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã€‚
å¦»ã®å«¦å¨¥ãŒãã®è–¬ã‚’è¦‹ã¤ã‘ã€ã“ã£ãã‚Šã¨é£²ã‚“ã§ã—ã¾ã†ã€‚
å«¦å¨¥ã®ä½“ãŒè»½ããªã‚Šã€ç©ºã¸ã¨èˆã„ä¸ŠãŒã‚‹ã€‚
ã¤ã„ã«æœˆã®ä¸–ç•Œã¸ã¨é£›ã³ç«‹ã¡ã€æ°¸é ã«ãã“ã§æš®ã‚‰ã™ã“ã¨ã«ãªã‚‹ã€‚`
        };
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // é€Ÿåº¦èª¿æ•´
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                animationManager.setSpeed(speed);
                document.getElementById('speedValue').textContent = speed + 'x';
            });
            
            // è¡¨ç¾åº¦èª¿æ•´
            document.getElementById('expressionSlider').addEventListener('input', (e) => {
                const expression = parseFloat(e.target.value) / 100;
                animationManager.setExpression(expression);
                document.getElementById('expressionValue').textContent = e.target.value + '%';
            });
            
            // ã‚ºãƒ¼ãƒ èª¿æ•´
            document.getElementById('zoomSlider').addEventListener('input', (e) => {
                const zoom = parseFloat(e.target.value);
                animationManager.setZoom(zoom);
                document.getElementById('zoomValue').textContent = zoom + 'x';
            });
            
            // Canvas ãƒªã‚µã‚¤ã‚º
            window.addEventListener('resize', () => {
                animationManager.setupCanvas();
            });
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        function loadTemplate(templateName) {
            const template = storyTemplates[templateName];
            if (template) {
                document.getElementById('storyInput').value = template;
            }
        }
        
        // ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿
        function loadExample(element) {
            const title = element.querySelector('.example-title').textContent;
            const template = storyTemplates[Object.keys(storyTemplates).find(key => 
                storyTemplates[key].includes(title.split('').slice(0, 2).join(''))
            )];
            
            if (template) {
                document.getElementById('storyInput').value = template;
            }
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
        function generateAnimation() {
            const storyText = document.getElementById('storyInput').value.trim();
            if (!storyText) {
                alert('ç‰©èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loading').classList.add('show');
            
            // è§£æå®Ÿè¡Œ
            setTimeout(() => {
                currentAnalysis = textAnalyzer.analyze(storyText);
                displayAnalysis(currentAnalysis);
                animationManager.loadStory(currentAnalysis);
                
                document.getElementById('loading').classList.remove('show');
            }, 1000);
        }
        
        // è§£æçµæœè¡¨ç¤º
        function displayAnalysis(analysis) {
            // æ¤œå‡ºè¦ç´ è¡¨ç¤º
            const elementsContainer = document.getElementById('detectedElements');
            elementsContainer.innerHTML = '';
            
            analysis.characters.forEach(char => {
                const tag = document.createElement('div');
                tag.className = 'tag character';
                tag.textContent = char.name;
                elementsContainer.appendChild(tag);
            });
            
            analysis.actions.forEach(action => {
                const tag = document.createElement('div');
                tag.className = 'tag action';
                tag.textContent = action.name;
                elementsContainer.appendChild(tag);
            });
            
            analysis.scenes.forEach(scene => {
                const tag = document.createElement('div');
                tag.className = 'tag scene';
                tag.textContent = scene.name;
                elementsContainer.appendChild(tag);
            });
            
            analysis.props.forEach(prop => {
                const tag = document.createElement('div');
                tag.className = 'tag prop';
                tag.textContent = prop.name;
                elementsContainer.appendChild(tag);
            });
            
            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
            const timelineContainer = document.getElementById('timeline');
            timelineContainer.innerHTML = '';
            
            analysis.timeline.forEach((scene, index) => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-number">${index + 1}</div>
                    <div>${scene.text}</div>
                `;
                timelineContainer.appendChild(item);
            });
        }
        
        // å†ç”Ÿåˆ¶å¾¡
        function togglePlayback() {
            if (animationManager.isPlaying) {
                animationManager.pause();
            } else {
                animationManager.play();
            }
        }
        
        function restartAnimation() {
            animationManager.restart();
        }
        
        function exportAnimation() {
            // ç°¡å˜ãªä¿å­˜æ©Ÿèƒ½ï¼ˆå®Ÿè£…ã¯çœç•¥ï¼‰
            alert('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¿å­˜æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
            animationManager.update(16); // ç´„60fps
            animationManager.render();
            requestAnimationFrame(animate);
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        setupEventListeners();
        animate();
        
        // ãƒ‡ãƒ¢ç”¨ï¼šè‡ªå‹•çš„ã«æœ€åˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        setTimeout(() => {
            loadTemplate('kuafu');
        }, 500);
    </script>
</body>
</html>