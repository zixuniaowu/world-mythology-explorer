<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>山海経クロニクル - E2Eテスト</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .test-results {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .test-pass {
            color: #4CAF50;
        }
        .test-fail {
            color: #F44336;
        }
        .test-info {
            color: #2196F3;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #444;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>山海経クロニクル E2Eテスト</h1>
    <button onclick="runTests()">テスト実行</button>
    <div id="test-results" class="test-results"></div>
    <iframe id="game-frame" src="index.html"></iframe>

    <script>
        let testResults = [];
        let gameWindow;
        let gameDocument;

        function log(message, type = 'info') {
            const result = { message, type, timestamp: new Date().toISOString() };
            testResults.push(result);
            updateDisplay();
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = testResults.map(r => {
                const className = r.type === 'pass' ? 'test-pass' : 
                                r.type === 'fail' ? 'test-fail' : 'test-info';
                return `<div class="${className}">[${r.timestamp}] ${r.message}</div>`;
            }).join('');
        }

        async function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function waitForGame() {
            const iframe = document.getElementById('game-frame');
            gameWindow = iframe.contentWindow;
            gameDocument = iframe.contentDocument;
            
            // ゲームオブジェクトが利用可能になるまで待機
            let attempts = 0;
            while (!gameWindow.game && attempts < 20) {
                await wait(500);
                attempts++;
            }
            
            return gameWindow.game !== undefined;
        }

        async function runTests() {
            testResults = [];
            log('テスト開始...');
            
            // iframeの再読み込み
            const iframe = document.getElementById('game-frame');
            iframe.src = iframe.src;
            
            // ゲームの読み込み待機
            await wait(1000);
            
            const gameLoaded = await waitForGame();
            
            try {
                // Test 1: ゲームオブジェクトの存在確認
                log('Test 1: ゲームオブジェクトの確認');
                if (gameLoaded && gameWindow.game) {
                    log('✓ ゲームオブジェクトが存在します', 'pass');
                    log(`Game object properties: ${Object.keys(gameWindow.game).join(', ')}`, 'info');
                } else {
                    log('✗ ゲームオブジェクトが見つかりません', 'fail');
                    log('デバッグ情報:', 'info');
                    log(`- iframe loaded: ${iframe !== null}`, 'info');
                    log(`- gameWindow: ${gameWindow !== null}`, 'info');
                    log(`- gameDocument: ${gameDocument !== null}`, 'info');
                    try {
                        log(`- Scripts in iframe: ${Array.from(gameDocument.querySelectorAll('script')).map(s => s.src.split('/').pop()).join(', ')}`, 'info');
                    } catch (e) {
                        log(`- Could not access iframe scripts: ${e.message}`, 'info');
                    }
                    return;
                }

                // Test 2: メインメニューの表示確認
                log('Test 2: メインメニューの表示確認');
                const mainMenu = gameDocument.getElementById('main-menu');
                if (mainMenu && mainMenu.classList.contains('active')) {
                    log('✓ メインメニューが表示されています', 'pass');
                } else {
                    log('✗ メインメニューが表示されていません', 'fail');
                }

                // Test 3: 新しいゲーム開始
                log('Test 3: 新しいゲーム開始');
                const newGameBtn = gameDocument.querySelector('button[onclick="game.startNewGame()"]');
                if (newGameBtn) {
                    newGameBtn.click();
                    await wait(500);
                    
                    const gameScreen = gameDocument.getElementById('game-screen');
                    if (gameScreen && gameScreen.classList.contains('active')) {
                        log('✓ ゲーム画面に遷移しました', 'pass');
                    } else {
                        log('✗ ゲーム画面への遷移に失敗しました', 'fail');
                    }
                } else {
                    log('✗ 新しいゲームボタンが見つかりません', 'fail');
                }

                // Test 4: 探索機能のテスト
                log('Test 4: 探索機能のテスト');
                const exploreBtn = gameDocument.querySelector('button[onclick="game.explore()"]');
                if (exploreBtn) {
                    exploreBtn.click();
                    await wait(500);
                    
                    const encounterView = gameDocument.getElementById('encounter-view');
                    if (encounterView && encounterView.classList.contains('active')) {
                        log('✓ 生物との遭遇が発生しました', 'pass');
                        
                        const creatureName = gameDocument.getElementById('creature-name').textContent;
                        log(`遭遇した生物: ${creatureName}`, 'info');
                    } else {
                        log('✗ 生物との遭遇が発生しませんでした', 'fail');
                    }
                } else {
                    log('✗ 探索ボタンが見つかりません', 'fail');
                }

                // Test 5: バトルシステムのテスト
                log('Test 5: バトルシステムのテスト');
                const battleBtn = gameDocument.querySelector('button[onclick="game.battle()"]');
                if (battleBtn) {
                    battleBtn.click();
                    await wait(500);
                    
                    const battleView = gameDocument.getElementById('battle-view');
                    if (battleView && battleView.classList.contains('active')) {
                        log('✓ バトル画面に遷移しました', 'pass');
                        
                        // 攻撃テスト
                        const attackBtn = gameDocument.querySelector('button[onclick="game.attack()"]');
                        if (attackBtn) {
                            attackBtn.click();
                            await wait(1500);
                            log('✓ 攻撃を実行しました', 'pass');
                        }
                    } else {
                        log('✗ バトル画面への遷移に失敗しました', 'fail');
                    }
                } else {
                    log('探索で生物に遭遇していないため、バトルテストをスキップ', 'info');
                }

                // Test 6: プレイヤー情報の確認
                log('Test 6: プレイヤー情報の確認');
                const hpText = gameDocument.querySelector('.hp-text');
                const spiritPoints = gameDocument.getElementById('spirit-points');
                if (hpText && spiritPoints) {
                    log(`✓ HP: ${hpText.textContent}`, 'pass');
                    log(`✓ 霊力: ${spiritPoints.textContent}`, 'pass');
                } else {
                    log('✗ プレイヤー情報が表示されていません', 'fail');
                }

                // Test 7: 図鑑機能のテスト
                log('Test 7: 図鑑機能のテスト');
                // メニューボタンを探す
                const menuToggle = gameDocument.querySelector('.menu-toggle');
                if (menuToggle) {
                    // メインメニューに戻る
                    gameWindow.game.showScreen('main-menu');
                    await wait(500);
                    
                    const collectionBtn = gameDocument.querySelector('button[onclick="game.showCollection()"]');
                    if (collectionBtn) {
                        collectionBtn.click();
                        await wait(500);
                        
                        const collectionScreen = gameDocument.getElementById('collection-screen');
                        if (collectionScreen && collectionScreen.classList.contains('active')) {
                            log('✓ 図鑑画面が表示されました', 'pass');
                            
                            const creatureCards = gameDocument.querySelectorAll('.creature-card');
                            log(`図鑑に${creatureCards.length}種類の生物枠があります`, 'info');
                        } else {
                            log('✗ 図鑑画面の表示に失敗しました', 'fail');
                        }
                    }
                }

                // Test 8: 休憩機能のテスト
                log('Test 8: 休憩機能のテスト');
                gameWindow.game.showScreen('game-screen');
                await wait(500);
                
                const restBtn = gameDocument.querySelector('button[onclick="game.rest()"]');
                if (restBtn) {
                    const beforeHp = gameWindow.game.player.hp;
                    const beforeSpirit = gameWindow.game.player.spiritPower;
                    
                    restBtn.click();
                    await wait(500);
                    
                    const afterHp = gameWindow.game.player.hp;
                    const afterSpirit = gameWindow.game.player.spiritPower;
                    
                    if (afterHp >= beforeHp && afterSpirit >= beforeSpirit) {
                        log('✓ 休憩で回復しました', 'pass');
                        log(`HP: ${beforeHp} → ${afterHp}`, 'info');
                        log(`霊力: ${beforeSpirit} → ${afterSpirit}`, 'info');
                    } else {
                        log('✗ 休憩機能が正しく動作していません', 'fail');
                    }
                }

                // Test 9: ダイアログシステムのテスト
                log('Test 9: ダイアログシステムのテスト');
                gameWindow.game.showDialogue('テストメッセージ');
                await wait(500);
                
                const dialogueBox = gameDocument.getElementById('dialogue-box');
                if (dialogueBox && dialogueBox.style.display !== 'none') {
                    log('✓ ダイアログが表示されました', 'pass');
                    
                    const continueBtn = gameDocument.querySelector('.dialogue-continue');
                    if (continueBtn) {
                        continueBtn.click();
                        await wait(500);
                        if (dialogueBox.style.display === 'none') {
                            log('✓ ダイアログを閉じることができました', 'pass');
                        }
                    }
                } else {
                    log('✗ ダイアログの表示に失敗しました', 'fail');
                }

                // 総合結果
                const passCount = testResults.filter(r => r.type === 'pass').length;
                const failCount = testResults.filter(r => r.type === 'fail').length;
                log(`\nテスト完了: ${passCount} 成功, ${failCount} 失敗`, 'info');

            } catch (error) {
                log(`エラー発生: ${error.message}`, 'fail');
                console.error(error);
            }
        }
    </script>
</body>
</html>