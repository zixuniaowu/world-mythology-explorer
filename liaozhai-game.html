<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊斎志異ミステリー - 火柴人探偵ゲーム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f5f3e9;
            color: #2c1810;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ゲームコンテナ */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* ヘッダー */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
        }

        .game-title {
            font-size: 2.5em;
            color: #8b4513;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-subtitle {
            font-size: 1.2em;
            color: #666;
        }

        /* メインゲームエリア */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* 火柴人キャンバスエリア */
        .stick-figure-area {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        #gameCanvas {
            width: 100%;
            height: 400px;
            border: 1px dashed #ddd;
            cursor: pointer;
        }

        /* テキストとパズルエリア */
        .content-area {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
        }

        /* 章タイトル */
        .chapter-title {
            font-size: 1.8em;
            color: #8b4513;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b4513;
        }

        /* テキスト表示エリア */
        .text-display {
            background: #fefefe;
            padding: 15px;
            border-left: 4px solid #d4a574;
            margin-bottom: 20px;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .text-display p {
            margin-bottom: 10px;
        }

        /* パズルエリア */
        .puzzle-area {
            background: #f9f7f3;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .puzzle-question {
            font-size: 1.3em;
            color: #8b4513;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .puzzle-options {
            display: grid;
            gap: 10px;
        }

        .option-button {
            background: white;
            border: 2px solid #d4a574;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            text-align: left;
        }

        .option-button:hover {
            background: #fff8dc;
            border-color: #8b4513;
            transform: translateX(5px);
        }

        .option-button.correct {
            background: #90ee90;
            border-color: #228b22;
        }

        .option-button.wrong {
            background: #ffcccb;
            border-color: #dc143c;
        }

        /* ボトムコントロール */
        .bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #8b4513;
        }

        /* スコア表示 */
        .score-display {
            font-size: 1.3em;
            color: #8b4513;
            font-weight: bold;
        }

        /* プログレスバー */
        .progress-container {
            flex: 1;
            margin: 0 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b4513, #d4a574);
            transition: width 0.5s ease;
            width: 0%;
        }

        /* ホームボタン */
        .home-button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .home-button:hover {
            background: #8b4513;
            transform: translateY(-2px);
        }

        /* スタート画面 */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .start-content {
            background: linear-gradient(135deg, #8b4513 0%, #8b4513 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 600px;
        }

        .start-title {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .start-description {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .start-button {
            background: #FFD700;
            color: #8b4513;
            border: none;
            padding: 20px 40px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(255,215,0,0.5);
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }

        .modal-title {
            font-size: 2em;
            color: #8b4513;
            margin-bottom: 20px;
        }

        .modal-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            color: #666;
        }

        .modal-button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            background: #8b4513;
            transform: translateY(-2px);
        }

        /* 探偵ノート */
        .detective-note {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .note-title {
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .clue-item {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        /* ヒントシステム */
        .hint-button {
            background: #d4a574;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .hint-button:hover {
            background: #cd853f;
            transform: translateY(-1px);
        }

        .hint-text {
            margin-top: 10px;
            padding: 10px;
            background: #f9f7f3;
            border-radius: 5px;
            font-size: 0.9em;
            color: #8b4513;
            display: none;
        }

        /* 幽霊エフェクト */
        @keyframes ghostFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .stick-figure-area {
                min-height: 300px;
            }
            
            #gameCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- スタート画面 -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <h1 class="start-title">聊斎志異の謎</h1>
            <p class="start-description">
                火柴人探偵となって、狐仙と幽霊の世界を探索しよう！<br>
                不思議な物語に隠された真実を解き明かせ！
            </p>
            <button class="start-button" onclick="startGame()">ゲームスタート</button>
        </div>
    </div>

    <!-- ゲームコンテナ -->
    <div class="game-container">
        <!-- ヘッダー -->
        <div class="game-header">
            <h1 class="game-title">聊斎志異ミステリー</h1>
            <p class="game-subtitle">火柴人探偵の怪異調査</p>
        </div>

        <!-- メインゲームエリア -->
        <div class="game-area">
            <!-- 火柴人キャンバス -->
            <div class="stick-figure-area">
                <canvas id="gameCanvas"></canvas>
            </div>

            <!-- コンテンツエリア -->
            <div class="content-area" id="contentArea">
                <h2 class="chapter-title" id="chapterTitle">第一話：画皮</h2>
                <div class="text-display" id="textDisplay">
                    <p>ゲームを開始してください...</p>
                </div>
                <div class="puzzle-area" id="puzzleArea" style="display: none;">
                    <div class="puzzle-question" id="puzzleQuestion"></div>
                    <div class="puzzle-options" id="puzzleOptions"></div>
                    <button class="hint-button" onclick="showHint()">ヒント (-10点)</button>
                    <div class="hint-text" id="hintText"></div>
                </div>
            </div>
        </div>

        <!-- ボトムコントロール -->
        <div class="bottom-controls">
            <div class="score-display">スコア: <span id="scoreValue">0</span></div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <a href="chinese-mythology-index.html" class="home-button">ホーム</a>
        </div>
    </div>

    <!-- 探偵ノート -->
    <div class="detective-note">
        <div class="note-title">🔍 探偵ノート</div>
        <div id="cluesList"></div>
    </div>

    <!-- モーダル -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">物語クリア！</h2>
            <p class="modal-message" id="modalMessage">おめでとうございます！</p>
            <button class="modal-button" onclick="closeModal()">続ける</button>
        </div>
    </div>

    <script>
        // ゲーム状態
        const gameState = {
            currentChapter: 0,
            currentPuzzle: 0,
            totalPuzzles: 3,
            completedPuzzles: 0,
            score: 0,
            clues: [],
            solvedPuzzles: [],
            animations: {},
            chapters: []
        };

        // 聊斎志異の物語データ
        const liaozhaiStories = [
            {
                id: 1,
                title: "画皮",
                content: `
                    <p>太原の王生は、道で美しい女に出会った。女は「私は人に追われています」と助けを求めた。</p>
                    <p>王生は女を家に連れ帰り、密かに匿った。しかし、道士が王生の家を訪れ、「邪気を感じる」と警告した。</p>
                    <p>ある夜、王生がこっそり女の部屋を覗くと、恐ろしい鬼が人の皮を彩色していた。女の正体は、美しい皮を被った悪鬼だったのだ。</p>
                    <p>王生は恐怖で逃げようとしたが、悪鬼に見つかり、心臓を抜き取られて死んでしまった。</p>
                `,
                puzzles: [
                    {
                        type: 'character_identity',
                        question: '美しい女の正体は何でしたか？',
                        options: [
                            '迷子になった貴族の娘',
                            '美しい皮を被った悪鬼',
                            '変身した狐仙',
                            '天界から降りてきた仙女'
                        ],
                        correct: 1,
                        hint: '王生が夜に目撃した恐ろしい光景を思い出してください。'
                    },
                    {
                        type: 'warning_sign',
                        question: '道士は何を感じて警告しましたか？',
                        options: [
                            '金運の上昇',
                            '幸運の訪れ',
                            '邪気の存在',
                            '病気の前兆'
                        ],
                        correct: 2,
                        hint: '道士が王生の家を訪れた理由に注目してください。'
                    },
                    {
                        type: 'tragic_ending',
                        question: '王生の最期はどうなりましたか？',
                        options: [
                            '女と幸せに暮らした',
                            '道士に救われた',
                            '心臓を抜き取られて死んだ',
                            '逃げることに成功した'
                        ],
                        correct: 2,
                        hint: '悪鬼に見つかった後の結末を確認してください。'
                    }
                ]
            },
            {
                id: 2,
                title: "聶小倩",
                content: `
                    <p>書生の寧采臣は、金華の荒れ寺に宿泊した。深夜、美しい女・聶小倩が現れた。</p>
                    <p>小倩は「私は幽霊です。妖怪に操られて男を誘惑していますが、あなたの正直な心に打たれました」と告白した。</p>
                    <p>寧采臣と小倩は互いに惹かれ合った。小倩は「私の骨を掘り出して、故郷に埋葬してください」と頼んだ。</p>
                    <p>寧采臣が小倩の願いを叶えると、小倩は生まれ変わり、二人は結ばれて幸せに暮らした。</p>
                `,
                puzzles: [
                    {
                        type: 'character_confession',
                        question: '聶小倩は自分について何と告白しましたか？',
                        options: [
                            '逃亡中の貴族の娘',
                            '妖怪に操られている幽霊',
                            '天界の仙女',
                            '狐の化身'
                        ],
                        correct: 1,
                        hint: '小倩が寧采臣に打ち明けた真実を思い出してください。'
                    },
                    {
                        type: 'request_puzzle',
                        question: '小倩は寧采臣に何を頼みましたか？',
                        options: [
                            '一緒に逃げてほしい',
                            '妖怪を退治してほしい',
                            '骨を掘り出して故郷に埋葬してほしい',
                            '手紙を届けてほしい'
                        ],
                        correct: 2,
                        hint: '小倩が解放されるために必要なことは何でしたか？'
                    },
                    {
                        type: 'happy_ending',
                        question: '物語の結末はどうなりましたか？',
                        options: [
                            '小倩は成仏して消えた',
                            '寧采臣は呪われた',
                            '二人は永遠に別れた',
                            '小倩は生まれ変わり二人は結ばれた'
                        ],
                        correct: 3,
                        hint: '願いが叶った後の展開を確認してください。'
                    }
                ]
            },
            {
                id: 3,
                title: "青鳳",
                content: `
                    <p>書生の耿去病は、狐仙の娘・青鳳と出会い、恋に落ちた。</p>
                    <p>青鳳の叔父は人間との交際に反対し、「狐族の掟を破れば、雷に打たれて死ぬ」と警告した。</p>
                    <p>しかし青鳳は「愛する人のためなら、雷に打たれても構わない」と決意した。</p>
                    <p>青鳳の真心に感動した天帝は、青鳳を人間に転生させ、二人は正式に夫婦となった。</p>
                `,
                puzzles: [
                    {
                        type: 'supernatural_identity',
                        question: '青鳳の正体は何でしたか？',
                        options: [
                            '人間の娘',
                            '狐仙の娘',
                            '龍の化身',
                            '花の精霊'
                        ],
                        correct: 1,
                        hint: '青鳳の家族について言及されている部分に注目。'
                    },
                    {
                        type: 'forbidden_love',
                        question: '叔父が警告した狐族の掟を破った結果は？',
                        options: [
                            '永遠の幸福',
                            '一族からの追放',
                            '雷に打たれて死ぬ',
                            '記憶を失う'
                        ],
                        correct: 2,
                        hint: '掟を破ることの恐ろしい結果について確認してください。'
                    },
                    {
                        type: 'divine_intervention',
                        question: '天帝は青鳳の真心にどう応えましたか？',
                        options: [
                            '罰を与えた',
                            '青鳳を人間に転生させた',
                            '二人を引き離した',
                            '何もしなかった'
                        ],
                        correct: 1,
                        hint: '物語の最後で天帝が下した決定を思い出してください。'
                    }
                ]
            },
            {
                id: 4,
                title: "嬰寧",
                content: `
                    <p>王子服は山で道に迷い、美しい少女に出会った。少女は嬰寧と名乗り、いつも笑っていた。</p>
                    <p>嬰寧は狐の養女で、純粋無垢な性格だった。王子服は嬰寧の無邪気な笑顔に心を奪われた。</p>
                    <p>結婚後も嬰寧は笑い続けたが、ある日隣人の無礼な男を懲らしめた後、「もう笑わない」と言った。</p>
                    <p>「人の世は複雑で、いつも笑っていては生きていけない」と悟った嬰寧は、普通の人間の妻となった。</p>
                `,
                puzzles: [
                    {
                        type: 'character_trait',
                        question: '嬰寧の最も特徴的な性格は？',
                        options: [
                            'いつも泣いている',
                            'いつも怒っている',
                            'いつも笑っている',
                            'いつも眠っている'
                        ],
                        correct: 2,
                        hint: '嬰寧の名前と共に語られる特徴を探してください。'
                    },
                    {
                        type: 'hidden_background',
                        question: '嬰寧の育ちの背景は？',
                        options: [
                            '貴族の実の娘',
                            '狐の養女',
                            '天界の仙女',
                            '孤児院で育った'
                        ],
                        correct: 1,
                        hint: '嬰寧の出自について説明されている部分を確認。'
                    },
                    {
                        type: 'character_growth',
                        question: '嬰寧が笑わなくなった理由は？',
                        options: [
                            '病気になったから',
                            '夫に飽きたから',
                            '人の世の複雑さを悟ったから',
                            '故郷が恋しくなったから'
                        ],
                        correct: 2,
                        hint: '隣人の事件後の嬰寧の言葉に注目してください。'
                    }
                ]
            },
            {
                id: 5,
                title: "王六郎",
                content: `
                    <p>漁師の許は、いつも同じ場所で釣りをしていた。ある日、水中から声がして「私は溺死した王六郎です」と名乗った。</p>
                    <p>王六郎の霊は許と友人になり、魚を追い込んで大漁にしてくれた。許は王六郎に酒や食べ物を供えた。</p>
                    <p>王六郎は「まもなく生まれ変わります。来世でも友人でいましょう」と告げて去った。</p>
                    <p>数年後、許は王六郎の生まれ変わりと再会し、前世の記憶はなかったが、不思議な縁で親友となった。</p>
                `,
                puzzles: [
                    {
                        type: 'spirit_identity',
                        question: '王六郎は何者でしたか？',
                        options: [
                            '河の神様',
                            '溺死した人の霊',
                            '龍王の使者',
                            '水の妖怪'
                        ],
                        correct: 1,
                        hint: '王六郎が自己紹介した内容を思い出してください。'
                    },
                    {
                        type: 'spirit_help',
                        question: '王六郎は許をどのように助けましたか？',
                        options: [
                            '宝物を与えた',
                            '病気を治した',
                            '魚を追い込んで大漁にした',
                            '未来を予言した'
                        ],
                        correct: 2,
                        hint: '漁師である許への最も実用的な助けは何でしたか？'
                    },
                    {
                        type: 'reincarnation',
                        question: '生まれ変わった王六郎はどうなりましたか？',
                        options: [
                            '許を覚えていて感謝した',
                            '前世の記憶はないが親友になった',
                            '許を避けた',
                            '再び水死した'
                        ],
                        correct: 1,
                        hint: '転生後の二人の関係について確認してください。'
                    }
                ]
            },
            {
                id: 6,
                title: "黄英",
                content: `
                    <p>馬子才は菊の花を愛する文人だった。ある日、菊花売りの姉弟と出会った。</p>
                    <p>姉の黄英は美しく、菊の栽培に詳しかった。実は二人は菊花の精霊だった。</p>
                    <p>馬子才は黄英と結婚し、黄英の指導で見事な菊園を作った。しかし馬は商売を軽蔑していた。</p>
                    <p>黄英は「花を愛するなら、花で生計を立てることも尊い」と諭し、馬も次第に理解するようになった。</p>
                `,
                puzzles: [
                    {
                        type: 'flower_spirit',
                        question: '黄英と弟の正体は？',
                        options: [
                            '普通の花売り',
                            '菊花の精霊',
                            '貧しい農民',
                            '仙界の使者'
                        ],
                        correct: 1,
                        hint: '姉弟の超自然的な正体について言及されています。'
                    },
                    {
                        type: 'conflict_values',
                        question: '馬子才が最初に軽蔑していたことは？',
                        options: [
                            '花を育てること',
                            '結婚すること',
                            '商売をすること',
                            '勉強すること'
                        ],
                        correct: 2,
                        hint: '文人としての馬の価値観と対立したものは何でしたか？'
                    },
                    {
                        type: 'wisdom_lesson',
                        question: '黄英が馬に教えた教訓は？',
                        options: [
                            '金儲けが全て',
                            '花を愛するなら花で生計を立てることも尊い',
                            '商売人になるべき',
                            '文人をやめるべき'
                        ],
                        correct: 1,
                        hint: '黄英の諭しの核心的なメッセージを探してください。'
                    }
                ]
            }
        ];

        // キャンバスの初期化
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // アニメーション設定
        let animationFrame = 0;
        let currentAnimation = 'detective';

        // 火柴人描画関数
        function drawStickFigure(x, y, type = 'detective', frame = 0, scale = 1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.strokeStyle = type === 'detective' ? '#2c1810' : '#8b4513';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            // 頭
            ctx.beginPath();
            ctx.arc(0, -30, 15, 0, Math.PI * 2);
            ctx.stroke();

            if (type === 'detective') {
                // 探偵の帽子
                ctx.beginPath();
                ctx.moveTo(-20, -35);
                ctx.lineTo(20, -35);
                ctx.lineTo(15, -45);
                ctx.lineTo(-15, -45);
                ctx.closePath();
                ctx.stroke();

                // 虫眼鏡
                ctx.beginPath();
                ctx.arc(25, -10, 8, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(31, -4);
                ctx.lineTo(40, 5);
                ctx.stroke();
            }

            // 体
            ctx.beginPath();
            ctx.moveTo(0, -15);
            ctx.lineTo(0, 20);
            ctx.stroke();

            // 腕（アニメーション）
            const armAngle = Math.sin(frame * 0.1) * 0.3;
            
            // 左腕
            ctx.beginPath();
            ctx.moveTo(0, -5);
            ctx.lineTo(-15, 5);
            ctx.lineTo(-10 + Math.sin(frame * 0.1 + Math.PI) * 5, 20);
            ctx.stroke();

            // 右腕
            ctx.beginPath();
            ctx.moveTo(0, -5);
            ctx.lineTo(15, 5);
            ctx.lineTo(10 + Math.sin(frame * 0.1) * 5, 20);
            ctx.stroke();

            // 脚（歩行アニメーション）
            const legAngle = Math.sin(frame * 0.15) * 0.5;
            
            // 左脚
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.lineTo(-10 + Math.sin(frame * 0.15) * 10, 40);
            ctx.lineTo(-15 + Math.sin(frame * 0.15) * 15, 60);
            ctx.stroke();

            // 右脚
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.lineTo(10 + Math.sin(frame * 0.15 + Math.PI) * 10, 40);
            ctx.lineTo(15 + Math.sin(frame * 0.15 + Math.PI) * 15, 60);
            ctx.stroke();

            ctx.restore();
        }

        // 妖怪・幽霊描画
        function drawSupernatural(x, y, type, frame = 0) {
            ctx.save();
            ctx.translate(x, y);
            
            switch(type) {
                case 'ghost': // 幽霊
                    ctx.globalAlpha = 0.7;
                    ctx.strokeStyle = '#b3e5fc';
                    ctx.fillStyle = '#e1f5fe';
                    ctx.lineWidth = 2;
                    
                    // 浮遊効果
                    const floatY = Math.sin(frame * 0.05) * 10;
                    ctx.translate(0, floatY);
                    
                    // 体（流れるような形）
                    ctx.beginPath();
                    ctx.moveTo(0, -30);
                    ctx.quadraticCurveTo(-20, 0, -15, 30);
                    ctx.quadraticCurveTo(-10, 40, 0, 35);
                    ctx.quadraticCurveTo(10, 40, 15, 30);
                    ctx.quadraticCurveTo(20, 0, 0, -30);
                    ctx.fill();
                    ctx.stroke();
                    
                    // 顔
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(-5, -10, 3, 0, Math.PI * 2);
                    ctx.arc(5, -10, 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.globalAlpha = 1;
                    break;
                    
                case 'fox': // 狐狸精
                    ctx.strokeStyle = '#ff8a65';
                    ctx.fillStyle = '#ffccbc';
                    ctx.lineWidth = 2;
                    
                    // 体
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 25, 18, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // 頭
                    ctx.beginPath();
                    ctx.arc(0, -20, 15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // 耳
                    ctx.beginPath();
                    ctx.moveTo(-10, -28);
                    ctx.lineTo(-8, -40);
                    ctx.lineTo(-5, -30);
                    ctx.moveTo(10, -28);
                    ctx.lineTo(8, -40);
                    ctx.lineTo(5, -30);
                    ctx.stroke();
                    
                    // 尻尾（ふわふわ）
                    ctx.beginPath();
                    const tailAngle = Math.sin(frame * 0.08) * 0.3;
                    ctx.moveTo(20, 0);
                    ctx.quadraticCurveTo(
                        40 + Math.sin(frame * 0.1) * 5,
                        -10 + Math.cos(frame * 0.1) * 5,
                        35,
                        -25
                    );
                    ctx.stroke();
                    
                    // 目
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(-5, -20, 2, 0, Math.PI * 2);
                    ctx.arc(5, -20, 2, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                    
                case 'flower_spirit': // 花の精霊
                    ctx.strokeStyle = '#c8e6c9';
                    ctx.fillStyle = '#a5d6a7';
                    ctx.lineWidth = 2;
                    
                    // 花びらのような体
                    for (let i = 0; i < 5; i++) {
                        const angle = (Math.PI * 2 / 5) * i + frame * 0.02;
                        ctx.save();
                        ctx.rotate(angle);
                        ctx.beginPath();
                        ctx.ellipse(0, -20, 8, 20, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                        ctx.restore();
                    }
                    
                    // 中心の顔
                    ctx.fillStyle = '#fff9c4';
                    ctx.beginPath();
                    ctx.arc(0, 0, 12, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // 目
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(-4, -2, 2, 0, Math.PI * 2);
                    ctx.arc(4, -2, 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 微笑み
                    ctx.beginPath();
                    ctx.arc(0, 2, 4, 0, Math.PI);
                    ctx.stroke();
                    break;
            }
            
            ctx.restore();
        }

        // アニメーションループ
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 背景（神秘的な雰囲気）
            const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/2);
            gradient.addColorStop(0, 'rgba(230, 184, 255, 0.1)');
            gradient.addColorStop(1, 'rgba(139, 69, 19, 0.1)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // メインキャラクター描画
            if (currentAnimation === 'detective') {
                drawStickFigure(canvas.width / 2, canvas.height / 2 + 50, 'detective', animationFrame);
            } else if (currentAnimation === 'celebration') {
                // 祝賀アニメーション
                drawStickFigure(canvas.width / 2, canvas.height / 2 + 50 - Math.abs(Math.sin(animationFrame * 0.1)) * 30, 'detective', animationFrame);
                
                // 紙吹雪効果（紫系）
                for (let i = 0; i < 10; i++) {
                    const hue = 270 + (i * 10); // 紫系の色相
                    ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;
                    ctx.fillRect(
                        canvas.width / 2 + Math.sin(animationFrame * 0.05 + i) * 100,
                        (animationFrame * 2 + i * 50) % canvas.height,
                        5,
                        10
                    );
                }
            } else if (currentAnimation === 'thinking') {
                drawStickFigure(canvas.width / 2, canvas.height / 2 + 50, 'detective', animationFrame);
                
                // 思考バブル
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(canvas.width / 2 + 50, canvas.height / 2 - 50, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#333';
                ctx.font = '20px sans-serif';
                ctx.fillText('?', canvas.width / 2 + 45, canvas.height / 2 - 45);
            } else if (currentAnimation.includes('creature_')) {
                const creatureType = currentAnimation.replace('creature_', '');
                drawSupernatural(canvas.width / 2, canvas.height / 2, creatureType, animationFrame);
            }
            
            animationFrame++;
            requestAnimationFrame(animate);
        }

        // ゲーム開始
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameState.chapters = liaozhaiStories;
            loadChapter(0);
            animate();
        }

        // 章の読み込み
        function loadChapter(chapterIndex) {
            if (chapterIndex >= gameState.chapters.length) {
                showGameComplete();
                return;
            }
            
            gameState.currentChapter = chapterIndex;
            gameState.currentPuzzle = 0;
            const chapter = gameState.chapters[chapterIndex];
            
            document.getElementById('chapterTitle').textContent = chapter.title;
            document.getElementById('textDisplay').innerHTML = chapter.content;
            document.getElementById('puzzleArea').style.display = 'none';
            
            // アニメーション変更
            currentAnimation = 'detective';
            
            // 2秒後に最初のパズルを表示
            setTimeout(() => {
                showPuzzle(0);
            }, 3000);
        }

        // パズル表示
        function showPuzzle(puzzleIndex) {
            const chapter = gameState.chapters[gameState.currentChapter];
            const puzzle = chapter.puzzles[puzzleIndex];
            
            document.getElementById('puzzleArea').style.display = 'block';
            document.getElementById('puzzleQuestion').textContent = puzzle.question;
            document.getElementById('hintText').style.display = 'none';
            
            const optionsContainer = document.getElementById('puzzleOptions');
            optionsContainer.innerHTML = '';
            
            puzzle.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.onclick = () => checkAnswer(index, puzzle.correct);
                optionsContainer.appendChild(button);
            });
            
            currentAnimation = 'thinking';
        }

        // 答え確認
        function checkAnswer(selected, correct) {
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.disabled = true);
            
            if (selected === correct) {
                buttons[selected].classList.add('correct');
                gameState.score += 100;
                gameState.completedPuzzles++;
                currentAnimation = 'celebration';
                
                // 手がかりを追加
                addClue(`✓ ${gameState.chapters[gameState.currentChapter].title} - パズル${gameState.currentPuzzle + 1}クリア`);
                
                setTimeout(() => {
                    nextPuzzle();
                }, 2000);
            } else {
                buttons[selected].classList.add('wrong');
                buttons[correct].classList.add('correct');
                gameState.score = Math.max(0, gameState.score - 20);
                
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('wrong', 'correct');
                    });
                    currentAnimation = 'detective';
                }, 2000);
            }
            
            updateScore();
            updateProgress();
        }

        // 次のパズル
        function nextPuzzle() {
            gameState.currentPuzzle++;
            
            if (gameState.currentPuzzle >= gameState.totalPuzzles) {
                // 章クリア
                showChapterComplete();
            } else {
                showPuzzle(gameState.currentPuzzle);
            }
        }

        // 章クリア表示
        function showChapterComplete() {
            gameState.score += 300; // ボーナスポイント
            updateScore();
            
            document.getElementById('modalTitle').textContent = '物語クリア！';
            document.getElementById('modalMessage').textContent = `${gameState.chapters[gameState.currentChapter].title}を完了しました！\nボーナス: +300点`;
            document.getElementById('modal').classList.add('active');
            
            currentAnimation = 'celebration';
        }

        // ゲームクリア
        function showGameComplete() {
            document.getElementById('modalTitle').textContent = 'ゲームクリア！';
            document.getElementById('modalMessage').textContent = `おめでとうございます！\n全ての物語を解明しました！\n最終スコア: ${gameState.score}点`;
            document.getElementById('modal').classList.add('active');
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            loadChapter(gameState.currentChapter + 1);
        }

        // ヒント表示
        function showHint() {
            const chapter = gameState.chapters[gameState.currentChapter];
            const puzzle = chapter.puzzles[gameState.currentPuzzle];
            
            document.getElementById('hintText').textContent = puzzle.hint;
            document.getElementById('hintText').style.display = 'block';
            
            gameState.score = Math.max(0, gameState.score - 10);
            updateScore();
        }

        // スコア更新
        function updateScore() {
            document.getElementById('scoreValue').textContent = gameState.score;
        }

        // 進捗更新
        function updateProgress() {
            const totalPuzzles = gameState.chapters.length * gameState.totalPuzzles;
            const progress = (gameState.completedPuzzles / totalPuzzles) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // 手がかり追加
        function addClue(clue) {
            gameState.clues.push(clue);
            const cluesList = document.getElementById('cluesList');
            const clueItem = document.createElement('div');
            clueItem.className = 'clue-item';
            clueItem.textContent = clue;
            cluesList.appendChild(clueItem);
        }

        // ウィンドウリサイズ対応
        window.addEventListener('resize', () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        });

        // 初期化
        updateScore();
        updateProgress();
    </script>
</body>
</html>