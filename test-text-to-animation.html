<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>文字到动画测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-case {
            border: 2px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .test-input {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test-output {
            background: #e8f5e9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .pass {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .fail {
            background: #ffcdd2;
            color: #c62828;
        }
        canvas {
            border: 1px solid #333;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>文字到动画 E2E 测试</h1>
    
    <div id="test-results"></div>
    
    <script>
        // 从 text-to-animation.html 复制的解析逻辑
        class TextParser {
            constructor() {
                this.patterns = {
                    characters: {
                        person: /\b(person|people|man|woman|boy|girl|人|个人|男|女|孩子)\b/gi,
                        bird: /\b(bird|birds|鸟|鳥|小鸟)\b/gi,
                        animal: /\b(dog|cat|animal|狗|猫|动物)\b/gi
                    },
                    actions: {
                        walk: /\b(walk|walking|走|走路|步行|歩く)\b/gi,
                        run: /\b(run|running|跑|跑步|走る)\b/gi,
                        jump: /\b(jump|jumping|跳|跳跃|ジャンプ)\b/gi,
                        fly: /\b(fly|flying|飞|飞行|飛ぶ)\b/gi,
                        wave: /\b(wave|waving|招手|挥手|手を振る)\b/gi,
                        talk: /\b(talk|talking|speak|说话|对话|聊天|話す)\b/gi,
                        stand: /\b(stand|standing|站|站立|立つ)\b/gi
                    },
                    objects: {
                        tree: /\b(tree|trees|树|木|树木|木)\b/gi,
                        mountain: /\b(mountain|mountains|hill|山|山脉|山)\b/gi,
                        sun: /\b(sun|太阳|日|太陽)\b/gi,
                        cloud: /\b(cloud|clouds|云|雲)\b/gi,
                        house: /\b(house|home|房子|家|房屋|家)\b/gi,
                        flower: /\b(flower|flowers|花|花朵|花)\b/gi
                    },
                    emotions: {
                        happy: /\b(happy|glad|开心|快乐|高兴|嬉しい)\b/gi,
                        sad: /\b(sad|upset|伤心|难过|悲しい)\b/gi,
                        angry: /\b(angry|mad|生气|愤怒|怒る)\b/gi
                    },
                    counts: {
                        two: /\b(two|2|两个|二|两|ふたつ)\b/gi,
                        three: /\b(three|3|三个|三|みっつ)\b/gi,
                        many: /\b(many|several|multiple|多个|许多|たくさん)\b/gi
                    }
                };
            }

            parse(text) {
                const result = {
                    characters: [],
                    actions: [],
                    objects: [],
                    emotions: [],
                    count: 1
                };

                // 检测数量
                for (const [count, pattern] of Object.entries(this.patterns.counts)) {
                    if (pattern.test(text)) {
                        result.count = count === 'two' ? 2 : count === 'three' ? 3 : 4;
                        break;
                    }
                }

                // 检测角色
                for (const [type, pattern] of Object.entries(this.patterns.characters)) {
                    if (pattern.test(text)) {
                        result.characters.push(type);
                    }
                }

                // 检测动作
                for (const [action, pattern] of Object.entries(this.patterns.actions)) {
                    if (pattern.test(text)) {
                        result.actions.push(action);
                    }
                }

                // 检测物体
                for (const [object, pattern] of Object.entries(this.patterns.objects)) {
                    if (pattern.test(text)) {
                        result.objects.push(object);
                    }
                }

                // 检测情绪
                for (const [emotion, pattern] of Object.entries(this.patterns.emotions)) {
                    if (pattern.test(text)) {
                        result.emotions.push(emotion);
                    }
                }

                // 默认值
                if (result.characters.length === 0) {
                    result.characters.push('person');
                }
                if (result.actions.length === 0) {
                    result.actions.push('stand');
                }

                return result;
            }
        }

        // 测试用例
        const testCases = [
            {
                input: "A person walking to a tree",
                expected: {
                    characters: ['person'],
                    actions: ['walk'],
                    objects: ['tree'],
                    count: 1
                }
            },
            {
                input: "Two people talking under the sun",
                expected: {
                    characters: ['person'],
                    actions: ['talk'],
                    objects: ['sun'],
                    count: 2
                }
            },
            {
                input: "一只鸟在山上飞",
                expected: {
                    characters: ['bird'],
                    actions: ['fly'],
                    objects: ['mountain'],
                    count: 1
                }
            },
            {
                input: "三个人在跑步",
                expected: {
                    characters: ['person'],
                    actions: ['run'],
                    objects: [],
                    count: 3
                }
            },
            {
                input: "Happy boy jumping near flowers",
                expected: {
                    characters: ['person'],
                    actions: ['jump'],
                    objects: ['flower'],
                    emotions: ['happy'],
                    count: 1
                }
            },
            {
                input: "两个人在树下对话",
                expected: {
                    characters: ['person'],
                    actions: ['talk'],
                    objects: ['tree'],
                    count: 2
                }
            },
            {
                input: "A sad person standing alone",
                expected: {
                    characters: ['person'],
                    actions: ['stand'],
                    emotions: ['sad'],
                    count: 1
                }
            },
            {
                input: "Many birds flying over mountains",
                expected: {
                    characters: ['bird'],
                    actions: ['fly'],
                    objects: ['mountain'],
                    count: 4
                }
            }
        ];

        // 运行测试
        function runTests() {
            const parser = new TextParser();
            const resultsDiv = document.getElementById('test-results');
            let passCount = 0;
            let failCount = 0;

            testCases.forEach((testCase, index) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                
                const result = parser.parse(testCase.input);
                
                // 比较结果
                let passed = true;
                let failureReasons = [];

                // 检查角色
                if (JSON.stringify(result.characters.sort()) !== JSON.stringify(testCase.expected.characters.sort())) {
                    passed = false;
                    failureReasons.push(`角色不匹配: 期望 ${JSON.stringify(testCase.expected.characters)}, 得到 ${JSON.stringify(result.characters)}`);
                }

                // 检查动作
                if (JSON.stringify(result.actions.sort()) !== JSON.stringify(testCase.expected.actions.sort())) {
                    passed = false;
                    failureReasons.push(`动作不匹配: 期望 ${JSON.stringify(testCase.expected.actions)}, 得到 ${JSON.stringify(result.actions)}`);
                }

                // 检查物体
                if (JSON.stringify(result.objects.sort()) !== JSON.stringify(testCase.expected.objects.sort())) {
                    passed = false;
                    failureReasons.push(`物体不匹配: 期望 ${JSON.stringify(testCase.expected.objects)}, 得到 ${JSON.stringify(result.objects)}`);
                }

                // 检查数量
                if (result.count !== testCase.expected.count) {
                    passed = false;
                    failureReasons.push(`数量不匹配: 期望 ${testCase.expected.count}, 得到 ${result.count}`);
                }

                // 检查情绪（如果有）
                if (testCase.expected.emotions) {
                    if (JSON.stringify(result.emotions.sort()) !== JSON.stringify(testCase.expected.emotions.sort())) {
                        passed = false;
                        failureReasons.push(`情绪不匹配: 期望 ${JSON.stringify(testCase.expected.emotions)}, 得到 ${JSON.stringify(result.emotions)}`);
                    }
                }

                testDiv.innerHTML = `
                    <h3>测试案例 ${index + 1}</h3>
                    <div class="test-input"><strong>输入:</strong> "${testCase.input}"</div>
                    <div class="test-output"><strong>解析结果:</strong> ${JSON.stringify(result, null, 2)}</div>
                    <div class="test-result ${passed ? 'pass' : 'fail'}">
                        <strong>状态:</strong> ${passed ? '✅ 通过' : '❌ 失败'}
                        ${!passed ? '<br><strong>原因:</strong><br>' + failureReasons.join('<br>') : ''}
                    </div>
                `;

                if (passed) {
                    passCount++;
                } else {
                    failCount++;
                }

                resultsDiv.appendChild(testDiv);
            });

            // 总结
            const summary = document.createElement('div');
            summary.innerHTML = `
                <h2>测试总结</h2>
                <p>总测试数: ${testCases.length}</p>
                <p style="color: green;">✅ 通过: ${passCount}</p>
                <p style="color: red;">❌ 失败: ${failCount}</p>
                <p>成功率: ${((passCount / testCases.length) * 100).toFixed(1)}%</p>
            `;
            resultsDiv.insertBefore(summary, resultsDiv.firstChild);
        }

        // 运行测试
        runTests();

        // 添加视觉测试
        function addVisualTest() {
            const visualDiv = document.createElement('div');
            visualDiv.innerHTML = `
                <h2>视觉测试</h2>
                <p>输入文字测试动画生成:</p>
                <input type="text" id="visual-input" style="width: 400px; padding: 10px;" placeholder="输入测试文字...">
                <button onclick="testVisual()">生成动画</button>
                <div id="visual-result"></div>
                <canvas id="test-canvas" width="600" height="300" style="display: none;"></canvas>
            `;
            document.body.appendChild(visualDiv);
        }

        function testVisual() {
            const input = document.getElementById('visual-input').value;
            const parser = new TextParser();
            const result = parser.parse(input);
            
            document.getElementById('visual-result').innerHTML = `
                <p><strong>解析结果:</strong></p>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            
            // 显示画布
            const canvas = document.getElementById('test-canvas');
            canvas.style.display = 'block';
            
            // 这里可以添加简单的动画预览
        }

        addVisualTest();
    </script>
</body>
</html>