<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Mythology Explorer - Interactive Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #fff;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px 40px;
            background: rgba(15, 12, 41, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .nav-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 10px 40px 10px 15px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
        }


        /* Main Container */
        .main-container {
            margin-top: 100px;
            padding: 40px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-title {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2em;
        }

        /* Map Container */
        .map-container {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        #worldMapCanvas {
            width: 100%;
            height: auto;
            cursor: crosshair;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(102, 126, 234, 0.3), 
                        inset 0 0 30px rgba(102, 126, 234, 0.1);
        }

        /* Mythology Markers */
        .mythology-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .mythology-marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .marker-inner {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .marker-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, transparent 70%);
            animation: pulse 2s infinite;
            filter: blur(2px);
        }

        .marker-pin {
            position: absolute;
            width: 20px;
            height: 20px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, #fff 30%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }

        .mythology-marker.active .marker-pin {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 30px rgba(255, 255, 255, 1);
        }

        .marker-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 1;
            transition: all 0.3s ease;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .marker-label::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }

        .mythology-marker:hover .marker-label {
            transform: translateX(-50%) translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Connection Lines */
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform-origin: left center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .connection-line.show {
            opacity: 1;
            animation: flow 3s linear infinite;
        }

        @keyframes flow {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Enhanced marker animations */
        .mythology-marker {
            animation: float-marker 3s ease-in-out infinite;
            animation-delay: calc(var(--marker-index) * 0.2s);
        }

        @keyframes float-marker {
            0%, 100% {
                transform: translate(-50%, -50%) translateY(0);
            }
            50% {
                transform: translate(-50%, -50%) translateY(-5px);
            }
        }


        /* Map overlay effect */
        .map-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(15, 12, 41, 0.2) 100%);
            pointer-events: none;
            z-index: 5;
        }

        /* Floating Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: float 20s infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* Legend / Filter Controls */
        .legend {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            user-select: none;
            position: relative;
        }

        /* Tooltip for legend items */
        .legend-item::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            margin-bottom: 5px;
            z-index: 1000;
        }

        .legend-item:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .legend-item.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .filter-controls {
            margin-top: 20px;
            text-align: center;
        }

        /* Filter instructions */
        .filter-instructions {
            text-align: center;
            margin: 15px 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .filter-instructions i {
            color: #667eea;
            margin-right: 5px;
        }

        .filter-btn {
            padding: 8px 20px;
            margin: 0 5px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #667eea;
        }

        /* About Section */
        .about-section {
            margin-top: 60px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .about-section h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #fff;
        }

        .about-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }

        .links-section {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .link-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .link-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #667eea;
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .nav-controls {
                flex-direction: column;
                gap: 10px;
            }

            .search-input {
                width: 200px;
            }

            .main-container {
                padding: 20px;
                margin-top: 120px;
            }

            .page-title h1 {
                font-size: 2em;
            }

            .mythology-marker {
                width: 25px;
                height: 25px;
            }

            .marker-pin {
                width: 15px;
                height: 15px;
            }

            .marker-label {
                font-size: 9px;
                padding: 3px 6px;
                bottom: -18px;
            }

            /* 增加手機端點擊區域 */
            .mythology-marker::before {
                content: '';
                position: absolute;
                width: 45px;
                height: 45px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: transparent;
                z-index: -1;
            }

            .links-section {
                flex-direction: column;
                align-items: center;
            }
            
            /* 手機端過濾器優化 */
            .legend {
                gap: 8px;
            }
            
            .legend-item {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .legend-color {
                width: 16px;
                height: 16px;
            }
            
            .filter-controls {
                margin-top: 15px;
            }
            
            .filter-btn {
                padding: 6px 15px;
                font-size: 12px;
                margin: 0 3px;
            }
        }

        /* Loading Animation */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #667eea;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Floating Particles -->
    <div class="particles" id="particles"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo" onclick="location.reload()">World Mythology Explorer</div>
        <div class="nav-controls">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="神話を検索...">
                <span class="search-icon">🔍</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <div class="page-title">
            <h1 id="mainTitle">世界神話の旅</h1>
            <p class="page-subtitle" id="subtitle">地域をクリックして神話の宝物を探索</p>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div class="map-wrapper">
                <canvas id="worldMapCanvas"></canvas>
                <div id="mythologyMarkers"></div>
                <div id="connectionLines"></div>
            </div>


            <!-- Tooltip -->
            <div class="tooltip" id="tooltip"></div>
        </div>

        <!-- Filter Instructions -->
        <div class="filter-instructions">
            <i>🎯</i> <span>地域をクリックして、その地域の神話のみを表示できます</span>
        </div>

        <!-- Legend -->
        <div class="legend" id="legendFilter">
            <div class="legend-item" data-region="east-asia" data-tooltip="中国と日本の神話を表示" onclick="toggleFilter('east-asia')">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span class="legend-text">東アジア神話</span>
            </div>
            <div class="legend-item" data-region="south-asia" data-tooltip="インドの神話を表示" onclick="toggleFilter('south-asia')">
                <div class="legend-color" style="background: #4ecdc4;"></div>
                <span class="legend-text">南アジア神話</span>
            </div>
            <div class="legend-item" data-region="middle-east" data-tooltip="メソポタミアの神話を表示" onclick="toggleFilter('middle-east')">
                <div class="legend-color" style="background: #f7b731;"></div>
                <span class="legend-text">中東神話</span>
            </div>
            <div class="legend-item" data-region="europe" data-tooltip="ギリシャ、北欧、ケルトの神話を表示" onclick="toggleFilter('europe')">
                <div class="legend-color" style="background: #5f27cd;"></div>
                <span class="legend-text">ヨーロッパ神話</span>
            </div>
            <div class="legend-item" data-region="africa" data-tooltip="エジプトと西アフリカの神話を表示" onclick="toggleFilter('africa')">
                <div class="legend-color" style="background: #ee5a6f;"></div>
                <span class="legend-text">アフリカ神話</span>
            </div>
            <div class="legend-item" data-region="americas" data-tooltip="アステカ・マヤと北米先住民の神話を表示" onclick="toggleFilter('americas')">
                <div class="legend-color" style="background: #00d2d3;"></div>
                <span class="legend-text">アメリカ神話</span>
            </div>
            <div class="legend-item" data-region="oceania" data-tooltip="オーストラリアとポリネシアの神話を表示" onclick="toggleFilter('oceania')">
                <div class="legend-color" style="background: #22a6b3;"></div>
                <span class="legend-text">オセアニア神話</span>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="filter-controls">
            <button class="filter-btn" onclick="showAllRegions()" title="すべての地域の神話を表示します">🌍 すべて表示</button>
            <button class="filter-btn" onclick="clearFilters()" title="選択したフィルターを解除します">✖ フィルタークリア</button>
        </div>

        <!-- About Section -->
        <div class="about-section">
            <h2>世界神話エクスプローラーについて</h2>
            <div class="about-content">
                <p>人間の想像力の豊かなタペストリーを旅しましょう。メソポタミアの古代の物語から太平洋諸島の鮮やかな物語まで、さまざまな文化が神話を通じて存在の神秘をどのように説明してきたかを探ります。</p>
                <p>各神話は単なる物語ではなく、文明の魂を表しています - 彼らの価値観、恐れ、希望、そして宇宙への理解。任意の地域をクリックして、その神話の遺産を発見してください。</p>
            </div>
            <div class="links-section">
                <a href="ai-text-to-animation.html" class="link-btn">AIアニメーションツール</a>
                <a href="text-to-animation.html" class="link-btn">シンプルアニメーション</a>
                <a href="#" class="link-btn">コミュニティフォーラム</a>
            </div>
        </div>
    </div>

    <!-- Canvas Performance Optimization -->
    <script src="canvas-performance-optimizations.js"></script>
    <script>
        // Language fixed to Japanese
        const currentLanguage = 'ja';
        
        // Language data for UI elements
        const translations = {
            ja: {
                title: "世界神話の旅",
                subtitle: "地域をクリックして神話の宝物を探索",
                search: "神話を検索...",
                categories: {
                    'east-asia': "東アジア神話",
                    'south-asia': "南アジア神話",
                    'europe': "ヨーロッパ神話",
                    'middle-east': "中東神話",
                    'africa': "アフリカ神話",
                    'americas': "アメリカ神話",
                    'oceania': "オセアニア神話"
                },
                aboutTitle: "世界神話について",
                aboutText1: "人間の想像力の豊かなタペストリーを旅しましょう。メソポタミアの古代の物語から太平洋諸島の鮮やかな物語まで、さまざまな文化が神話を通じて存在の神秘をどのように説明してきたかを探ります。",
                aboutText2: "各神話は単なる物語ではなく、文明の魂を表しています - 彼らの価値観、恐れ、希望、そして宇宙への理解。任意の地域をクリックして、その神話の遺産を発見してください。",
                links: {
                    aiAnimation: "AIアニメーションツール",
                    simpleAnimation: "シンプルアニメーション",
                    community: "コミュニティフォーラム"
                }
            },
            zh: {
                title: "世界神话之旅",
                subtitle: "点击地区探索神话宝藏",
                search: "搜索神话...",
                categories: {
                    'east-asia': "东亚神话",
                    'south-asia': "南亚神话",
                    'europe': "欧洲神话",
                    'middle-east': "中东神话",
                    'africa': "非洲神话",
                    'americas': "美洲神话",
                    'oceania': "大洋洲神话"
                },
                aboutTitle: "关于世界神话",
                aboutText1: "踏上人类想象力丰富的旅程。从美索不达米亚的古代故事到太平洋岛屿的生动传说，探索不同文化如何通过神话来解释存在的奥秘。",
                aboutText2: "每个神话不仅仅是一个故事，更代表着文明的灵魂——他们的价值观、恐惧、希望以及对宇宙的理解。点击任意地区，发现其神话遗产。",
                links: {
                    aiAnimation: "AI动画工具",
                    simpleAnimation: "简单动画",
                    community: "社区论坛"
                }
            },
            en: {
                title: "Journey Through World Mythology",
                subtitle: "Click on regions to explore mythological treasures",
                search: "Search mythology...",
                categories: {
                    'east-asia': "East Asian Mythology",
                    'south-asia': "South Asian Mythology",
                    'europe': "European Mythology",
                    'middle-east': "Middle Eastern Mythology",
                    'africa': "African Mythology",
                    'americas': "American Mythology",
                    'oceania': "Oceanian Mythology"
                },
                aboutTitle: "About World Mythology",
                aboutText1: "Journey through the rich tapestry of human imagination. From the ancient tales of Mesopotamia to the vibrant stories of Pacific islands, explore how different cultures have explained the mysteries of existence through mythology.",
                aboutText2: "Each mythology is more than just stories - they represent the soul of civilizations, their values, fears, hopes, and understanding of the cosmos. Click on any region to discover its mythological heritage.",
                links: {
                    aiAnimation: "AI Animation Tool",
                    simpleAnimation: "Simple Animation",
                    community: "Community Forum"
                }
            }
        };
        
        
        // Update UI text based on current language
        function updateUILanguage() {
            const t = translations[currentLanguage];
            
            // Update page title and subtitle
            const pageTitle = document.querySelector('#mainTitle');
            const pageSubtitle = document.querySelector('#subtitle');
            if (pageTitle) pageTitle.textContent = t.title;
            if (pageSubtitle) pageSubtitle.textContent = t.subtitle;
            
            // Update search placeholder
            const searchInput = document.querySelector('#searchInput');
            if (searchInput) searchInput.placeholder = t.search;
            
            // Update legend items
            document.querySelectorAll('.legend-item').forEach(item => {
                const region = item.getAttribute('data-region');
                if (region && t.categories[region]) {
                    const textElement = item.querySelector('.legend-text');
                    if (textElement) textElement.textContent = t.categories[region];
                }
            });
            
            // Update about section
            const aboutTitle = document.querySelector('.about-section h2');
            const aboutTexts = document.querySelectorAll('.about-content p');
            if (aboutTitle) aboutTitle.textContent = t.aboutTitle;
            if (aboutTexts[0]) aboutTexts[0].textContent = t.aboutText1;
            if (aboutTexts[1]) aboutTexts[1].textContent = t.aboutText2;
            
            // Update links
            const linkBtns = document.querySelectorAll('.link-btn');
            if (linkBtns[0]) linkBtns[0].textContent = t.links.aiAnimation;
            if (linkBtns[1]) linkBtns[1].textContent = t.links.simpleAnimation;
            if (linkBtns[2]) linkBtns[2].textContent = t.links.community;
        }
        
        // Update legend text to Japanese
        function updateLegendLanguage() {
            document.querySelectorAll('.legend-text').forEach(element => {
                const text = element.getAttribute('data-ja') || element.getAttribute('data-en');
                element.textContent = text;
            });
        }
        
        // Mythology locations with real world coordinates (normalized 0-1)
        const mythologyLocations = {
            china: { 
                x: 0.78, y: 0.38, 
                name: { en: "China", ja: "中国", zh: "中国" }, 
                region: { en: "Shanhaijing", ja: "山海経", zh: "山海经" }
            },
            japan: { 
                x: 0.87, y: 0.36, 
                name: { en: "Japan", ja: "日本", zh: "日本" }, 
                region: { en: "Kojiki", ja: "古事記", zh: "古事记" }
            },
            india: { 
                x: 0.67, y: 0.48, 
                name: { en: "India", ja: "インド", zh: "印度" }, 
                region: { en: "Mahabharata", ja: "マハーバーラタ", zh: "摩诃婆罗多" }
            },
            greece: { 
                x: 0.52, y: 0.38, 
                name: { en: "Greece", ja: "ギリシャ", zh: "希腊" }, 
                region: { en: "Olympus", ja: "オリンポス", zh: "奥林匹斯" }
            },
            egypt: { 
                x: 0.53, y: 0.50, 
                name: { en: "Egypt", ja: "エジプト", zh: "埃及" }, 
                region: { en: "Hieroglyphs", ja: "ヒエログリフ", zh: "象形文字" }
            },
            norse: { 
                x: 0.50, y: 0.22, 
                name: { en: "Scandinavia", ja: "スカンジナビア", zh: "斯堪的纳维亚" }, 
                region: { en: "Valhalla", ja: "ヴァルハラ", zh: "瓦尔哈拉" }
            },
            celtic: { 
                x: 0.46, y: 0.28, 
                name: { en: "Ireland", ja: "アイルランド", zh: "爱尔兰" }, 
                region: { en: "Tír na nÓg", ja: "ケルト神話", zh: "青春之地" }
            },
            mesopotamia: { 
                x: 0.58, y: 0.42, 
                name: { en: "Mesopotamia", ja: "メソポタミア", zh: "美索不达米亚" }, 
                region: { en: "Babylon", ja: "バビロン", zh: "巴比伦" }
            },
            aztecMaya: { 
                x: 0.22, y: 0.50, 
                name: { en: "Mexico", ja: "メキシコ", zh: "墨西哥" }, 
                region: { en: "Tenochtitlan", ja: "テノチティトラン", zh: "特诺奇提特兰" }
            },
            nativeAmerican: { 
                x: 0.18, y: 0.38, 
                name: { en: "North America", ja: "北アメリカ", zh: "北美洲" }, 
                region: { en: "Great Spirit", ja: "グレートスピリット", zh: "大精灵" }
            },
            westAfrica: { 
                x: 0.48, y: 0.58, 
                name: { en: "West Africa", ja: "西アフリカ", zh: "西非" }, 
                region: { en: "Yoruba", ja: "ヨルバ", zh: "约鲁巴" }
            },
            aboriginal: { 
                x: 0.82, y: 0.72, 
                name: { en: "Australia", ja: "オーストラリア", zh: "澳大利亚" }, 
                region: { en: "Dreamtime", ja: "ドリームタイム", zh: "梦境时代" }
            },
            polynesian: { 
                x: 0.90, y: 0.65, 
                name: { en: "Polynesia", ja: "ポリネシア", zh: "波利尼西亚" }, 
                region: { en: "Moana", ja: "モアナ", zh: "海洋" }
            }
        };

        // Mythology Data
        const mythologyData = {
            china: {
                title: "Chinese Mythology",
                titleZh: "中国神话",
                titleJa: "中国神話",
                origin: "Ancient China",
                originJa: "古代中国",
                description: "A rich tapestry of legends including the Classic of Mountains and Seas (山海经), Investiture of the Gods (封神演义), and Strange Tales from a Chinese Studio (聊斋志异).",
                descriptionJa: "山海経、封神演義、聊斎志異などの豊かな伝説の織物。古代中国の神話体系は、天地創造から神々と妖怪の物語まで幅広く展開しています。",
                features: ["Dragons", "Immortals", "Journey to the West", "Jade Emperor", "Fox Spirits"],
                featuresJa: ["龍", "仙人", "西遊記", "玉皇大帝", "狐狸精"],
                color: "#ff6b6b"
            },
            japan: {
                title: "Japanese Mythology",
                titleZh: "日本神话",
                titleJa: "日本神話",
                origin: "Ancient Japan",
                originZh: "古代日本",
                originJa: "古代日本",
                description: "Ancient chronicles like Kojiki (古事記) and Nihon Shoki (日本書紀), plus a rich tradition of yokai (妖怪) folklore.",
                descriptionZh: "包括古事记、日本书纪等古代编年史，以及丰富的妖怪民俗传统。",
                descriptionJa: "古事記や日本書紀などの古代の記録、そして豊かな妖怪の民俗伝統。",
                features: ["Kami", "Yokai", "Amaterasu", "Susanoo", "Kitsune"],
                featuresJa: ["神", "妖怪", "天照大神", "須佐之男", "狐"],
                featuresZh: ["神灵", "妖怪", "天照大神", "须佐之男", "狐狸"],
                color: "#ff9999"
            },
            india: {
                title: "Indian Mythology",
                titleZh: "印度神话",
                titleJa: "インド神話",
                origin: "Ancient India",
                originZh: "古代印度",
                originJa: "古代インド",
                description: "Epic tales from the Mahabharata, Ramayana, and ancient Vedic texts that form the foundation of Hindu philosophy.",
                descriptionZh: "来自摩诃婆罗多、罗摩衍那和古代吠陀经典的史诗故事，构成了印度教哲学的基础。",
                descriptionJa: "マハーバーラタ、ラーマーヤナ、そして古代ヴェーダの経典からの壮大な物語。ヒンドゥー哲学の基礎を形成する神話体系です。",
                features: ["Vishnu", "Shiva", "Krishna", "Rama", "Vedas"],
                featuresZh: ["毗湿奴", "湿婆", "克里希纳", "罗摩", "吠陀经"],
                featuresJa: ["ヴィシュヌ", "シヴァ", "クリシュナ", "ラーマ", "ヴェーダ"],
                color: "#4ecdc4"
            },
            mesopotamia: {
                title: "Mesopotamian Mythology",
                titleZh: "美索不达米亚神话",
                titleJa: "メソポタミア神話",
                origin: "Ancient Mesopotamia",
                originZh: "古代美索不达米亚",
                originJa: "古代メソポタミア",
                description: "The world's oldest recorded myths, including the Epic of Gilgamesh and tales from ancient Babylon and Sumeria.",
                descriptionZh: "世界上最古老的记录神话，包括吉尔伽美什史诗以及来自古巴比伦和苏美尔的传说。",
                descriptionJa: "ギルガメシュ叙事詩を含む世界最古の記録された神話。古代バビロンとシュメールの物語が文明の黎明期を物語ります。",
                features: ["Gilgamesh", "Enkidu", "Tiamat", "Marduk", "Ishtar"],
                featuresZh: ["吉尔伽美什", "恩奇都", "提亚马特", "马尔杜克", "伊什塔尔"],
                featuresJa: ["ギルガメシュ", "エンキドゥ", "ティアマト", "マルドゥク", "イシュタル"],
                color: "#f7b731"
            },
            greece: {
                title: "Greek Mythology",
                titleZh: "希腊神话",
                titleJa: "ギリシャ神話",
                origin: "Ancient Greece",
                originZh: "古希腊",
                originJa: "古代ギリシャ",
                description: "The pantheon of Olympian gods and heroes whose stories have influenced Western culture for millennia.",
                descriptionZh: "奥林匹斯众神和英雄的万神殿，他们的故事千年来影响着西方文化。",
                descriptionJa: "オリンポスの神々と英雄たちの物語。西洋文化に数千年にわたって影響を与え続けている神話体系です。",
                features: ["Zeus", "Athena", "Odysseus", "Hercules", "Olympus"],
                featuresZh: ["宙斯", "雅典娜", "奥德修斯", "赫拉克勒斯", "奥林匹斯"],
                featuresJa: ["ゼウス", "アテナ", "オデュッセウス", "ヘラクレス", "オリンポス"],
                color: "#5f27cd"
            },
            norse: {
                title: "Norse Mythology",
                titleZh: "北欧神话",
                titleJa: "北欧神話",
                origin: "Ancient Scandinavia",
                originZh: "古代斯堪的纳维亚",
                originJa: "古代スカンジナビア",
                description: "Tales of gods, giants, and the cosmic tree Yggdrasil from the Viking Age, preserved in the Eddas.",
                descriptionZh: "维京时代的诸神、巨人和世界树伊格德拉希尔的故事，保存在埃达中。",
                descriptionJa: "エッダに保存されたヴァイキング時代の神々、巨人、世界樹ユグドラシルの物語。北欧の厳しい自然が生んだ壮大な神話です。",
                features: ["Odin", "Thor", "Loki", "Ragnarok", "Valhalla"],
                featuresZh: ["奥丁", "索尔", "洛基", "诸神黄昏", "瓦尔哈拉"],
                featuresJa: ["オーディン", "トール", "ロキ", "ラグナロク", "ヴァルハラ"],
                color: "#7f39fb"
            },
            celtic: {
                title: "Celtic Mythology",
                titleZh: "凯尔特神话",
                titleJa: "ケルト神話",
                origin: "Ancient Celtic Lands",
                originZh: "古代凯尔特地区",
                originJa: "古代ケルト地域",
                description: "Mystical tales from Ireland, Wales, and Scotland featuring otherworldly beings and heroic quests.",
                descriptionZh: "来自爱尔兰、威尔士和苏格兰的神秘故事，描绘了异世界生灵和英雄探险。",
                descriptionJa: "アイルランド、ウェールズ、スコットランドから伝わる神秘的な物語。異界の存在と英雄の冒険が織りなす幻想的な世界です。",
                features: ["Tuatha Dé Danann", "Cú Chulainn", "Morrigan", "Druids", "Sidhe"],
                featuresZh: ["达努神族", "库丘林", "莫瑞甘", "德鲁伊", "仙灵"],
                featuresJa: ["トゥアハ・デ・ダナーン", "クー・フーリン", "モリガン", "ドルイド", "シー"],
                color: "#9c59d1"
            },
            egypt: {
                title: "Egyptian Mythology",
                titleZh: "埃及神话",
                titleJa: "エジプト神話",
                origin: "Ancient Egypt",
                originZh: "古埃及",
                originJa: "古代エジプト",
                description: "Stories of gods who controlled the Nile, the afterlife, and the cosmic order, preserved in hieroglyphs and papyri.",
                descriptionZh: "掌管尼罗河、来世和宇宙秩序的诸神故事，保存在象形文字和纸莎草纸中。",
                descriptionJa: "ナイル川、来世、宇宙の秩序を司る神々の物語。ヒエログリフとパピルスに保存された永遠の生命への探求です。",
                features: ["Ra", "Osiris", "Isis", "Anubis", "Book of the Dead"],
                featuresZh: ["拉", "奥西里斯", "伊西斯", "阿努比斯", "死者之书"],
                featuresJa: ["ラー", "オシリス", "イシス", "アヌビス", "死者の書"],
                color: "#ee5a6f"
            },
            westAfrica: {
                title: "West African Mythology",
                titleZh: "西非神话",
                titleJa: "西アフリカ神話",
                origin: "West Africa",
                originZh: "西非",
                originJa: "西アフリカ",
                description: "Oral traditions including the trickster Anansi and creation myths from various West African cultures.",
                descriptionZh: "包括恶作剧之神阿南西在内的口述传统，以及来自各种西非文化的创世神话。",
                descriptionJa: "アナンシを含む口承伝統。ヨルバ族をはじめとする様々な西アフリカ文化の創造神話が豊かな精神世界を物語ります。",
                features: ["Anansi", "Yoruba Orishas", "Trickster Tales", "Creation Stories", "Ancestral Spirits"],
                featuresZh: ["阿南西", "约鲁巴神灵", "恶作剧故事", "创世故事", "祖先之灵"],
                featuresJa: ["アナンシ", "ヨルバのオリシャ", "トリックスター物語", "創世神話", "祖先の霊"],
                color: "#ff7979"
            },
            aztecMaya: {
                title: "Aztec & Maya Mythology",
                titleZh: "阿兹特克与玛雅神话",
                titleJa: "アステカ・マヤ神話",
                origin: "Mesoamerica",
                originZh: "中美洲",
                originJa: "メソアメリカ",
                description: "Complex cosmologies from the Aztec and Maya civilizations, featuring feathered serpents and jaguar gods.",
                descriptionZh: "阿兹特克和玛雅文明的复杂宇宙观，以羽蛇神和美洲豹神为特色。",
                descriptionJa: "アステカとマヤ文明の複雑な宇宙観。羽毛の蛇やジャガーの神々が織りなす、天文学と精神世界が融合した神話体系です。",
                features: ["Quetzalcoatl", "Kukulkan", "Popol Vuh", "Tezcatlipoca", "Xibalba"],
                featuresZh: ["羽蛇神", "库库尔坎", "波波尔乌", "特斯卡特利波卡", "西巴尔巴"],
                featuresJa: ["ケツァルコアトル", "ククルカン", "ポポル・ヴー", "テスカトリポカ", "シバルバ"],
                color: "#00d2d3"
            },
            nativeAmerican: {
                title: "Native American Mythology",
                titleZh: "北美原住民神话",
                titleJa: "ネイティブアメリカン神話",
                origin: "North America",
                originZh: "北美洲",
                originJa: "北アメリカ",
                description: "Diverse traditions from hundreds of tribes, featuring creation stories, animal spirits, and sacred landscapes.",
                descriptionZh: "来自数百个部落的多样传统，包括创世故事、动物精灵和神圣景观。",
                descriptionJa: "数百の部族から伝わる多様な伝統。創世物語、動物の霊、聖なる大地が紡ぐ、自然との深い絆を表す神話です。",
                features: ["Coyote", "Thunderbird", "Great Spirit", "Vision Quests", "Sacred Animals"],
                featuresZh: ["郊狼", "雷鸟", "大精灵", "灵视探索", "神圣动物"],
                featuresJa: ["コヨーテ", "サンダーバード", "グレート・スピリット", "ビジョン・クエスト", "聖なる動物"],
                color: "#00b8d4"
            },
            aboriginal: {
                title: "Aboriginal Dreamtime",
                titleZh: "澳洲原住民梦时代",
                titleJa: "アボリジニ・ドリームタイム",
                origin: "Australia",
                originZh: "澳大利亚",
                originJa: "オーストラリア",
                description: "The Dreamtime stories that explain the creation of the land, animals, and people of Australia.",
                descriptionZh: "梦时代故事解释了澳大利亚土地、动物和人民的创造。",
                descriptionJa: "オーストラリアの大地、動物、人々の創造を説明するドリームタイムの物語。時間と空間を超越した神聖なる世界観です。",
                features: ["Rainbow Serpent", "Dreamtime", "Songlines", "Creation Ancestors", "Sacred Sites"],
                featuresZh: ["彩虹蛇", "梦境时代", "歌之径", "创世祖先", "圣地"],
                featuresJa: ["虹蛇", "ドリームタイム", "ソングライン", "創造の祖先", "聖地"],
                color: "#22a6b3"
            },
            polynesian: {
                title: "Polynesian Mythology",
                titleZh: "波利尼西亚神话",
                titleJa: "ポリネシア神話",
                origin: "Pacific Islands",
                originZh: "太平洋岛屿",
                originJa: "太平洋諸島",
                description: "Ocean-spanning myths from Hawaii, Tahiti, New Zealand, and other Pacific islands.",
                descriptionZh: "来自夏威夷、塔希提、新西兰和其他太平洋岛屿的跨海神话。",
                descriptionJa: "ハワイ、タヒチ、ニュージーランドなど太平洋諸島の海を越えた神話。大海原を舞台にした壮大な冒険と神々の物語です。",
                features: ["Maui", "Pele", "Tangaroa", "Tiki", "Ocean Voyages"],
                featuresZh: ["毛伊", "贝利", "坦加罗阿", "提基", "海洋航行"],
                featuresJa: ["マウイ", "ペレ", "タンガロア", "ティキ", "海洋航海"],
                color: "#30e3ca"
            }
        };


        let currentLang = 'ja';
        let canvas, ctx;
        let mapImage;
        let canvasWidth, canvasHeight;
        let canvasOptimizer;
        let isMapDirty = true;

        // Initialize canvas and load map
        function initializeMap() {
            canvas = document.getElementById('worldMapCanvas');
            
            // Initialize canvas optimizer if available
            if (typeof WorldMapCanvasOptimizer !== 'undefined') {
                try {
                    canvasOptimizer = new WorldMapCanvasOptimizer(canvas, {
                        enableOffscreenCanvas: true,
                        enableImageSmoothing: true,
                        frameRate: 30
                    });
                    ctx = canvasOptimizer.ctx;
                } catch (error) {
                    console.warn('Canvas optimizer failed to initialize:', error);
                    ctx = canvas.getContext('2d');
                }
            } else {
                ctx = canvas.getContext('2d');
            }
            
            // Create world map image
            mapImage = new Image();
            mapImage.onload = function() {
                // Set canvas size
                const maxWidth = 1200;
                const aspectRatio = mapImage.height / mapImage.width;
                canvasWidth = Math.min(maxWidth, window.innerWidth - 80);
                canvasHeight = canvasWidth * aspectRatio;
                
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                // Draw map with overlay
                drawMap();
                
                // Create markers
                createMythologyMarkers();
                
                // Create connection lines
                createConnectionLines();
            };
            
            // Use a stylized world map image (we'll create a gradient-based one)
            createStylizedWorldMap();
        }

        // Create a stylized world map using canvas
        function createStylizedWorldMap() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 1200;
            tempCanvas.height = 600;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Create gradient background with aurora effect
            const gradient = tempCtx.createLinearGradient(0, 0, 1200, 600);
            gradient.addColorStop(0, '#0f0c29');
            gradient.addColorStop(0.3, '#302b63');
            gradient.addColorStop(0.7, '#24243e');
            gradient.addColorStop(1, '#0f3460');
            tempCtx.fillStyle = gradient;
            tempCtx.fillRect(0, 0, 1200, 600);
            
            // Add aurora waves
            tempCtx.globalAlpha = 0.3;
            const auroraGradient = tempCtx.createLinearGradient(0, 0, 1200, 300);
            auroraGradient.addColorStop(0, 'transparent');
            auroraGradient.addColorStop(0.5, '#667eea');
            auroraGradient.addColorStop(1, 'transparent');
            tempCtx.fillStyle = auroraGradient;
            tempCtx.fillRect(0, 0, 1200, 300);
            tempCtx.globalAlpha = 1;
            
            // Draw simplified continents
            tempCtx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            tempCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            tempCtx.lineWidth = 2;
            
            // Draw continents (simplified shapes)
            drawContinents(tempCtx);
            
            // Set the map image
            mapImage.src = tempCanvas.toDataURL();
        }

        // Draw more detailed continent shapes
        function drawContinents(ctx) {
            // Set up drawing style
            ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 20;
            ctx.shadowColor = 'rgba(102, 126, 234, 0.5)';
            
            // North America
            ctx.beginPath();
            ctx.moveTo(150, 100);
            ctx.lineTo(200, 90);
            ctx.lineTo(250, 100);
            ctx.lineTo(300, 120);
            ctx.lineTo(350, 180);
            ctx.lineTo(380, 250);
            ctx.lineTo(350, 350);
            ctx.lineTo(300, 400);
            ctx.quadraticCurveTo(250, 420, 200, 400);
            ctx.lineTo(150, 350);
            ctx.lineTo(120, 280);
            ctx.lineTo(100, 200);
            ctx.lineTo(120, 150);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // South America
            ctx.beginPath();
            ctx.moveTo(280, 400);
            ctx.lineTo(320, 420);
            ctx.quadraticCurveTo(340, 460, 320, 520);
            ctx.lineTo(280, 580);
            ctx.lineTo(240, 560);
            ctx.lineTo(220, 500);
            ctx.lineTo(240, 440);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Africa
            ctx.beginPath();
            ctx.moveTo(580, 200);
            ctx.lineTo(620, 180);
            ctx.lineTo(660, 200);
            ctx.lineTo(680, 250);
            ctx.lineTo(700, 320);
            ctx.quadraticCurveTo(680, 400, 640, 480);
            ctx.lineTo(600, 520);
            ctx.lineTo(560, 500);
            ctx.lineTo(540, 440);
            ctx.lineTo(520, 380);
            ctx.lineTo(500, 320);
            ctx.lineTo(520, 260);
            ctx.lineTo(560, 220);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Europe
            ctx.beginPath();
            ctx.moveTo(560, 200);
            ctx.lineTo(540, 160);
            ctx.lineTo(560, 140);
            ctx.lineTo(600, 130);
            ctx.lineTo(640, 140);
            ctx.lineTo(660, 160);
            ctx.lineTo(640, 180);
            ctx.lineTo(600, 190);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Asia
            ctx.beginPath();
            ctx.moveTo(660, 140);
            ctx.lineTo(760, 120);
            ctx.lineTo(860, 140);
            ctx.lineTo(960, 180);
            ctx.lineTo(1020, 220);
            ctx.lineTo(1040, 280);
            ctx.lineTo(1000, 340);
            ctx.lineTo(920, 380);
            ctx.lineTo(820, 360);
            ctx.lineTo(720, 320);
            ctx.lineTo(680, 280);
            ctx.lineTo(680, 220);
            ctx.lineTo(700, 180);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // India
            ctx.beginPath();
            ctx.moveTo(780, 360);
            ctx.lineTo(820, 380);
            ctx.lineTo(840, 420);
            ctx.lineTo(820, 460);
            ctx.lineTo(780, 440);
            ctx.lineTo(760, 400);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Australia
            ctx.beginPath();
            ctx.moveTo(920, 480);
            ctx.lineTo(1020, 460);
            ctx.lineTo(1060, 500);
            ctx.lineTo(1040, 540);
            ctx.lineTo(980, 560);
            ctx.lineTo(920, 540);
            ctx.lineTo(900, 500);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Add grid overlay for style
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.1)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 15]);
            
            // Vertical lines
            for (let x = 0; x < 1200; x += 100) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, 600);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = 0; y < 600; y += 100) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(1200, y);
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
        }

        // Optimized draw function
        function drawMap() {
            if (canvasOptimizer && canvasOptimizer.batchDraw) {
                canvasOptimizer.batchDraw((ctx) => {
                    drawMapContent(ctx);
                });
            } else {
                drawMapContent(ctx);
            }
        }
        
        // Draw map content with performance optimizations
        function drawMapContent(context) {
            // Clear canvas
            context.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // Draw base map
            context.drawImage(mapImage, 0, 0, canvasWidth, canvasHeight);
            
            // Create overlay gradient once and reuse
            if (!window.mapOverlayGradient || window.lastCanvasSize !== canvasWidth) {
                window.mapOverlayGradient = context.createRadialGradient(
                    canvasWidth/2, canvasHeight/2, 0, 
                    canvasWidth/2, canvasHeight/2, canvasWidth/2
                );
                window.mapOverlayGradient.addColorStop(0, 'rgba(102, 126, 234, 0.15)');
                window.mapOverlayGradient.addColorStop(0.3, 'rgba(118, 75, 162, 0.1)');
                window.mapOverlayGradient.addColorStop(0.6, 'rgba(238, 90, 111, 0.05)');
                window.mapOverlayGradient.addColorStop(1, 'transparent');
                window.lastCanvasSize = canvasWidth;
            }
            
            context.fillStyle = window.mapOverlayGradient;
            context.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // Optimized star rendering - reduce number and use batching
            drawOptimizedStars(context);
        }
        
        // Pre-generate star positions for better performance
        let starPositions = [];
        function generateStarPositions() {
            starPositions = [];
            for (let i = 0; i < 30; i++) { // Reduced from 50 to 30
                starPositions.push({
                    x: Math.random() * canvasWidth,
                    y: Math.random() * canvasHeight,
                    size: Math.random() * 1.5 + 0.5,
                    opacity: Math.random() * 0.6 + 0.4
                });
            }
        }
        
        function drawOptimizedStars(context) {
            if (starPositions.length === 0) {
                generateStarPositions();
            }
            
            // Batch star drawing
            context.save();
            starPositions.forEach(star => {
                context.globalAlpha = star.opacity;
                context.fillStyle = 'rgba(255, 255, 255, 1)';
                context.beginPath();
                context.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                context.fill();
            });
            context.restore();
        }

        // Create mythology markers
        function createMythologyMarkers() {
            const markersContainer = document.getElementById('mythologyMarkers');
            markersContainer.innerHTML = '';
            
            Object.entries(mythologyLocations).forEach(([key, location], index) => {
                const marker = createMarker(key, location, index);
                markersContainer.appendChild(marker);
            });
        }

        // Create individual marker
        function createMarker(mythKey, location, index) {
            const marker = document.createElement('div');
            marker.className = 'mythology-marker';
            marker.dataset.mythology = mythKey;
            marker.style.setProperty('--marker-index', index);
            
            const x = location.x * canvasWidth;
            const y = location.y * canvasHeight;
            
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            
            const markerInner = document.createElement('div');
            markerInner.className = 'marker-inner';
            
            const glow = document.createElement('div');
            glow.className = 'marker-glow';
            glow.style.background = `radial-gradient(circle, ${mythologyData[mythKey].color}88 0%, transparent 70%)`;
            
            const pin = document.createElement('div');
            pin.className = 'marker-pin';
            pin.style.background = `radial-gradient(circle, ${mythologyData[mythKey].color} 30%, transparent 70%)`;
            
            const label = document.createElement('div');
            label.className = 'marker-label';
            const regionText = typeof location.region === 'object' ? location.region[currentLanguage] || location.region.ja : location.region;
            const nameText = typeof location.name === 'object' ? location.name[currentLanguage] || location.name.ja : location.name;
            label.innerHTML = `<div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">${regionText}</div><div style="font-size: 12px; font-weight: bold;">${nameText}</div>`;
            
            markerInner.appendChild(glow);
            markerInner.appendChild(pin);
            markerInner.appendChild(label);
            marker.appendChild(markerInner);
            
            // Add click event - direct navigation to mythology page
            marker.addEventListener('click', () => {
                exploreMythology(mythKey);
            });
            
            return marker;
        }

        // Create connection lines between related mythologies
        function createConnectionLines() {
            const connections = [
                ['china', 'japan'],
                ['greece', 'egypt'],
                ['norse', 'celtic'],
                ['aztecMaya', 'nativeAmerican'],
                ['india', 'mesopotamia']
            ];
            
            const linesContainer = document.getElementById('connectionLines');
            linesContainer.innerHTML = '';
            
            connections.forEach(([from, to]) => {
                const line = createConnectionLine(from, to);
                if (line) linesContainer.appendChild(line);
            });
        }

        // Create connection line between two mythologies
        function createConnectionLine(from, to) {
            const fromLoc = mythologyLocations[from];
            const toLoc = mythologyLocations[to];
            
            if (!fromLoc || !toLoc) return null;
            
            const x1 = fromLoc.x * canvasWidth;
            const y1 = fromLoc.y * canvasHeight;
            const x2 = toLoc.x * canvasWidth;
            const y2 = toLoc.y * canvasHeight;
            
            const line = document.createElement('div');
            line.className = 'connection-line';
            line.dataset.from = from;
            line.dataset.to = to;
            
            const distance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);
            
            line.style.width = distance + 'px';
            line.style.left = x1 + 'px';
            line.style.top = y1 + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            return line;
        }

        // Initialize particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = Math.random() * 10 + 5 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 20 + 20) + 's';
                particlesContainer.appendChild(particle);
            }
        }



        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateUILanguage();
            createMythologyMarkers();
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            document.querySelectorAll('.mythology-marker').forEach(marker => {
                const mythologyKey = marker.dataset.mythology;
                const mythologyData_ = mythologyData[mythologyKey];
                
                const searchableText = [
                    mythologyData_.title,
                    mythologyData_.titleZh,
                    mythologyData_.titleJa,
                    mythologyData_.origin,
                    mythologyData_.description,
                    ...mythologyData_.features
                ].join(' ').toLowerCase();
                
                if (searchableText.includes(searchTerm)) {
                    marker.style.opacity = '1';
                    marker.style.pointerEvents = 'auto';
                } else {
                    marker.style.opacity = '0.3';
                    marker.style.pointerEvents = 'none';
                }
            });
            
            // Reset if search is empty
            if (!searchTerm) {
                document.querySelectorAll('.mythology-marker').forEach(marker => {
                    marker.style.opacity = '';
                    marker.style.pointerEvents = '';
                });
            }
        });

        // Filter functionality
        let activeFilters = new Set();
        
        // Define region categories for each mythology
        const mythologyRegions = {
            'china': 'east-asia',
            'japan': 'east-asia',
            'india': 'south-asia',
            'egypt': 'africa',
            'greece': 'europe',
            'norse': 'europe',
            'mesopotamia': 'middle-east',
            'celtic': 'europe',
            'aztecMaya': 'americas',
            'nativeAmerican': 'americas',
            'westAfrica': 'africa',
            'aboriginal': 'oceania',
            'polynesian': 'oceania'
        };
        
        // Toggle filter function
        function toggleFilter(region) {
            const filterItem = document.querySelector(`[data-region="${region}"]`);
            
            if (activeFilters.has(region)) {
                // Remove filter
                activeFilters.delete(region);
                filterItem.classList.remove('active');
            } else {
                // Add filter
                activeFilters.add(region);
                filterItem.classList.add('active');
            }
            
            applyFilters();
        }
        
        // Apply filters to markers with smooth animations
        function applyFilters() {
            const markers = document.querySelectorAll('.mythology-marker');
            
            markers.forEach((marker, index) => {
                const mythologyKey = marker.dataset.mythology;
                const mythologyRegion = mythologyRegions[mythologyKey];
                
                // Add transition for smooth animations
                marker.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Delay animations for staggered effect
                setTimeout(() => {
                    if (activeFilters.size === 0) {
                        // No filters active, show all
                        marker.style.opacity = '1';
                        marker.style.transform = 'translate(-50%, -50%) scale(1)';
                        marker.style.pointerEvents = 'auto';
                        marker.style.filter = 'none';
                    } else if (activeFilters.has(mythologyRegion)) {
                        // Show filtered items with highlight
                        marker.style.opacity = '1';
                        marker.style.transform = 'translate(-50%, -50%) scale(1.15)';
                        marker.style.pointerEvents = 'auto';
                        marker.style.filter = 'drop-shadow(0 0 10px rgba(255, 255, 255, 0.8))';
                    } else {
                        // Hide non-filtered items
                        marker.style.opacity = '0.15';
                        marker.style.transform = 'translate(-50%, -50%) scale(0.7)';
                        marker.style.pointerEvents = 'none';
                        marker.style.filter = 'grayscale(100%)';
                    }
                }, index * 50); // Staggered animation delay
            });
        }
        
        // Show all regions
        function showAllRegions() {
            activeFilters.clear();
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('active');
            });
            applyFilters();
        }
        
        // Clear filters (same as show all)
        function clearFilters() {
            showAllRegions();
        }

        // Explore mythology function
        function exploreMythology(region) {
            const mythologyPages = {
                china: 'chinese-mythology-index.html',  // 保持中文版
                greece: 'greek-mythology-index-ja.html',
                norse: 'norse-mythology-index-ja.html',
                egypt: 'egyptian-mythology-index-ja.html',
                india: 'indian-mythology-index-ja.html',
                japan: 'japanese-mythology-index.html',  // 保持日文版
                mesopotamia: 'mesopotamian-mythology-index-ja.html',
                celtic: 'celtic-mythology-index-ja.html',
                nativeAmerican: 'native-american-mythology-index-ja.html',
                aztecMaya: 'aztec-maya-mythology-index-ja.html',
                westAfrica: 'west-african-mythology-index-ja.html',
                aboriginal: 'aboriginal-mythology-index-ja.html',
                polynesian: 'polynesian-mythology-index-ja.html'
            };
            
            if (mythologyPages[region]) {
                window.location.href = mythologyPages[region];
            } else {
                alert(`${mythologyData[region].title} coming soon!`);
            }
        }

        // Initialize Japanese interface
        function initializeJapanese() {
            // Update page title and subtitle to Japanese
            document.getElementById('mainTitle').textContent = "世界神話の旅";
            document.getElementById('subtitle').textContent = "地域をクリックして神話の宝物を探索";
            
            // Update search placeholder to Japanese
            document.getElementById('searchInput').placeholder = "神話を検索...";
            
            // Update legend text
            updateLegendLanguage();
            updateUILanguage();
            
            // Create markers with current language
            createMythologyMarkers();
        }
        
        // Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all components
            createParticles();
            initializeMap();
            updateLegendLanguage();
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (mapImage && mapImage.complete) {
                const maxWidth = 1200;
                const aspectRatio = mapImage.height / mapImage.width;
                canvasWidth = Math.min(maxWidth, window.innerWidth - 80);
                canvasHeight = canvasWidth * aspectRatio;
                
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                drawMap();
                createMythologyMarkers();
                createConnectionLines();
                
            }
        });


        // Animation on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Observe elements for scroll animations
        document.querySelectorAll('.legend-item, .about-section').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.style.transition = 'all 0.6s ease';
            observer.observe(el);
        });
    </script>
</body>
</html>