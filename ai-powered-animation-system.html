<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå‹•åŠ›å‹•ç•«ç”Ÿæˆç³»çµ± - æ¬¡ä¸–ä»£æ–‡å­—è½‰å‹•ç•«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .ai-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .ai-badge {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .ai-badge.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .main-container {
            flex: 1;
            display: flex;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        .left-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .story-textarea {
            width: 100%;
            height: 180px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            padding: 15px;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .story-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .ai-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-label {
            font-size: 0.9em;
            color: #ccc;
        }

        .config-select, .config-input {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-family: inherit;
        }

        .config-select option {
            background: #333;
            color: white;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border: none;
            border-radius: 10px;
            color: #333;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            position: relative;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-analysis {
            max-height: 300px;
            overflow-y: auto;
        }

        .analysis-section {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .analysis-title {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .analysis-content {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .canvas-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canvas-title {
            font-size: 1.8em;
            color: #ffd700;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #ffd700;
        }

        .control-btn.active {
            background: #ffd700;
            color: #333;
            border-color: #ffd700;
        }

        .animation-canvas {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .ai-insights {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .insights-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-content {
            font-size: 1em;
            line-height: 1.6;
            color: #f0f0f0;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .ai-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            color: #ffaaaa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .example-prompt {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .example-prompt:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ffd700;
            transform: translateX(5px);
        }

        .progress-section {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffb347 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
            }
            
            .ai-config {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– AIå‹•åŠ›å‹•ç•«ç”Ÿæˆç³»çµ±</h1>
        <p class="subtitle">æ¬¡ä¸–ä»£æ–‡å­—è½‰ç«æŸ´äººå‹•ç•«æŠ€è¡“</p>
        <div class="ai-badges">
            <span class="ai-badge active" data-model="gpt">GPT-4 Turbo</span>
            <span class="ai-badge" data-model="gemini">Gemini Pro</span>
            <span class="ai-badge" data-model="claude">Claude 3</span>
            <span class="ai-badge" data-model="local">æœ¬åœ°LLM</span>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <!-- AIè¨­å®šé¢æ¿ -->
            <div class="panel">
                <h3 class="panel-title">
                    <span>ğŸ§ </span>
                    <span>AIå¼•æ“è¨­å®š</span>
                </h3>

                <div class="ai-config">
                    <div class="config-item">
                        <label class="config-label">AIæ¨¡å‹</label>
                        <select class="config-select" id="aiModel">
                            <option value="demo">Demoæ¨¡å¼ (æ™ºèƒ½è¦å‰‡)</option>
                            <option value="qwen2" selected>ğŸ”¥ æœ¬åœ°Qwen2 (æœ€ä½³ä¸­æ–‡)</option>
                            <option value="llama2">âœ… æœ¬åœ°Llama2 (è‹±æ–‡è¼ƒä½³)</option>
                            <option value="gpt-3.5">GPT-3.5 Turbo (éœ€è¦API Key)</option>
                            <option value="gpt-4">GPT-4 (éœ€è¦API Key)</option>
                            <option value="gemini">Gemini Pro (éœ€è¦API Key)</option>
                            <option value="claude">Claude 3 (éœ€è¦API Key)</option>
                        </select>
                    </div>

                    <div class="config-item">
                        <label class="config-label">å‰µé€ åŠ›</label>
                        <select class="config-select" id="creativity">
                            <option value="0.3">ä¿å®ˆ (0.3)</option>
                            <option value="0.7" selected>å¹³è¡¡ (0.7)</option>
                            <option value="1.0">å‰µæ–° (1.0)</option>
                        </select>
                    </div>

                    <div class="config-item">
                        <label class="config-label">å‹•ç•«é¢¨æ ¼</label>
                        <select class="config-select" id="animationStyle">
                            <option value="traditional">å‚³çµ±ç¥è©±</option>
                            <option value="modern" selected>ç¾ä»£æ¼”ç¹¹</option>
                            <option value="cartoon">å¡é€šé¢¨æ ¼</option>
                            <option value="realistic">å¯«å¯¦é¢¨æ ¼</option>
                        </select>
                    </div>

                    <div class="config-item">
                        <label class="config-label">API Key</label>
                        <input type="password" class="config-input" id="apiKey" 
                               placeholder="è¼¸å…¥API Key (å¯é¸)">
                    </div>
                </div>
            </div>

            <!-- æ•…äº‹è¼¸å…¥é¢æ¿ -->
            <div class="panel">
                <h3 class="panel-title">
                    <span>ğŸ“</span>
                    <span>æ•…äº‹æ–‡æœ¬è¼¸å…¥</span>
                </h3>

                <div class="example-prompts">
                    <div class="example-prompt" onclick="loadExample(this)">
                        ğŸ‰ å¤¸çˆ¶è¿½æ—¥ï¼šå¤¸çˆ¶æ±ºå¿ƒè¿½ä¸Šå¤ªé™½ï¼Œè·‘éé«˜å±±å’Œå¤§æ²³...
                    </div>
                    <div class="example-prompt" onclick="loadExample(this)">
                        âš”ï¸ ç´ æˆ”å—šå°Šï¼šå‹‡æ•¢çš„ç¥éˆé¢å°å…«é ­å…«å°¾çš„å·¨è›‡...
                    </div>
                    <div class="example-prompt" onclick="loadExample(this)">
                        ğŸŒ™ å«¦å¨¥å¥”æœˆï¼šç¾éº—çš„å«¦å¨¥å·åƒäº†ä¸æ­»è—¥ï¼Œé£›å‘æœˆå®®...
                    </div>
                </div>

                <textarea class="story-textarea" id="storyInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç¥è©±æ•…äº‹...

ç¤ºä¾‹ï¼š
å¤¸çˆ¶æ±ºå¿ƒè¿½ä¸Šå¤ªé™½ï¼Œä»–é‚é–‹å·¨å¤§çš„æ­¥ä¼é–‹å§‹å¥”è·‘ã€‚è·¨è¶Šé«˜å±±ï¼Œç©¿éæ£®æ—ï¼Œè¶Šéå¤§æ²³ï¼Œä½†å¤ªé™½å§‹çµ‚åœ¨å‰æ–¹ã€‚çµ‚æ–¼ï¼Œå¤¸çˆ¶å› ç‚ºæ¸´æœ›è€Œå€’ä¸‹ï¼Œä»–çš„æ‰‹æ–åŒ–ä½œæ¡ƒæ—ï¼Œç‚ºå¾Œä¾†çš„æ—…äººæä¾›é™°æ¶¼ã€‚

æˆ–è€…ï¼š
ç´ æˆ”å—šå°Šè½èªªå…«å²å¤§è›‡æ­£åœ¨å¨è„…äººé–“ï¼Œä»–å‹‡æ•¢åœ°æèµ·ç¥åŠï¼Œä¾†åˆ°å¤§è›‡çš„å·¢ç©´ã€‚å…«å€‹é ­é¡±åŒæ™‚å’†å“®ï¼Œä½†è‹±é›„æ¯«ä¸ç•æ‡¼ï¼Œæ®åŠæ–¬å‘æ€ªç‰©..."></textarea>

                <button class="generate-btn" id="generateBtn" onclick="generateWithAI()">
                    <span>ğŸš€ AIç”Ÿæˆå‹•ç•«</span>
                </button>

                <div class="loading" id="loading">
                    <div class="ai-spinner"></div>
                    <div>AIæ­£åœ¨åˆ†ææ•…äº‹ä¸¦ç”Ÿæˆå‹•ç•«...</div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">
                        é€™å¯èƒ½éœ€è¦10-30ç§’æ™‚é–“
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- AIåˆ†æçµæœ -->
            <div class="panel">
                <h3 class="panel-title">
                    <span>ğŸ”</span>
                    <span>AIæ·±åº¦åˆ†æ</span>
                </h3>

                <div class="ai-analysis" id="aiAnalysis">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        è¼¸å…¥æ•…äº‹å¾Œï¼ŒAIå°‡åœ¨æ­¤é¡¯ç¤ºè©³ç´°åˆ†æçµæœ
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- ç•«å¸ƒæ§åˆ¶ -->
            <div class="canvas-controls">
                <h2 class="canvas-title">ğŸ¬ æ™ºèƒ½å‹•ç•«ç”Ÿæˆ</h2>
                <div class="playback-controls">
                    <button class="control-btn" id="playBtn" onclick="togglePlay()">
                        â–¶ æ’­æ”¾
                    </button>
                    <button class="control-btn" onclick="restartAnimation()">
                        â® é‡æ–°é–‹å§‹
                    </button>
                    <button class="control-btn" onclick="exportAnimation()">
                        ğŸ’¾ å°å‡º
                    </button>
                </div>
            </div>

            <!-- å‹•ç•«ç•«å¸ƒ -->
            <div class="animation-canvas">
                <canvas id="animationCanvas"></canvas>
                
                <div class="progress-section">
                    <div class="progress-text">
                        <span>å‹•ç•«é€²åº¦</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="ai-insights">
                    <div class="insights-title">
                        <span>ğŸ§ </span>
                        <span>AIå°æ¼”æ´å¯Ÿ</span>
                    </div>
                    <div class="insights-content" id="insightsContent">
                        AIå°‡æ ¹æ“šæ‚¨çš„æ•…äº‹æä¾›å°ˆæ¥­çš„å‹•ç•«å°æ¼”å»ºè­°å’Œæƒ…æ„Ÿåˆ†æ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AIé›†æˆç³»çµ± ====================
        
        class AIAnimationEngine {
            constructor() {
                this.currentModel = 'demo';
                this.apiKey = '';
                this.creativity = 0.7;
                this.animationStyle = 'modern';
                this.setupCanvas();
                this.setupEventListeners();
            }
            
            setupCanvas() {
                this.canvas = document.getElementById('animationCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = 500;
                this.isPlaying = false;
                this.currentScene = 0;
                this.animationData = null;
            }
            
            setupEventListeners() {
                // AIæ¨¡å‹åˆ‡æ›
                document.querySelectorAll('.ai-badge').forEach(badge => {
                    badge.addEventListener('click', () => {
                        document.querySelectorAll('.ai-badge').forEach(b => b.classList.remove('active'));
                        badge.classList.add('active');
                        this.currentModel = badge.dataset.model;
                    });
                });
                
                // åƒæ•¸æ›´æ–°
                document.getElementById('aiModel').addEventListener('change', (e) => {
                    this.currentModel = e.target.value;
                });
                
                document.getElementById('creativity').addEventListener('change', (e) => {
                    this.creativity = parseFloat(e.target.value);
                });
                
                document.getElementById('animationStyle').addEventListener('change', (e) => {
                    this.animationStyle = e.target.value;
                });
                
                document.getElementById('apiKey').addEventListener('input', (e) => {
                    this.apiKey = e.target.value;
                });
            }
            
            async generateAnimation(storyText) {
                this.showLoading(true);
                this.clearError();
                
                try {
                    let analysisResult;
                    
                    switch(this.currentModel) {
                        case 'gpt-3.5':
                        case 'gpt-4':
                            analysisResult = await this.analyzeWithGPT(storyText);
                            break;
                        case 'gemini':
                            analysisResult = await this.analyzeWithGemini(storyText);
                            break;
                        case 'claude':
                            analysisResult = await this.analyzeWithClaude(storyText);
                            break;
                        case 'qwen2':
                            analysisResult = await this.analyzeWithLocal(storyText, 'qwen2:7b');
                            break;
                        case 'llama2':
                            analysisResult = await this.analyzeWithLocal(storyText, 'llama2');
                            break;
                        case 'local':
                            analysisResult = await this.analyzeWithLocal(storyText, 'qwen2:7b');
                            break;
                        default:
                            analysisResult = await this.generateDemoAnalysis(storyText);
                    }
                    
                    this.displayAnalysis(analysisResult);
                    this.loadAnimation(analysisResult);
                    this.showInsights(analysisResult.insights);
                    
                } catch (error) {
                    this.showError(`AIåˆ†æå¤±æ•—: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async analyzeWithGPT(storyText) {
                if (!this.apiKey) {
                    throw new Error('è«‹æä¾›OpenAI API Key');
                }
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: this.currentModel === 'gpt-4' ? "gpt-4" : "gpt-3.5-turbo",
                        messages: [{
                            role: "system",
                            content: `ä½ æ˜¯ä¸–ç•Œé ‚ç´šçš„å‹•ç•«å°æ¼”å’Œæ•…äº‹åˆ†æå¸«ã€‚è«‹å°‡è¼¸å…¥çš„ç¥è©±æ•…äº‹è½‰æ›ç‚ºè©³ç´°çš„ç«æŸ´äººå‹•ç•«è…³æœ¬ã€‚
                            
                            è¿”å›JSONæ ¼å¼ï¼Œå¿…é ˆåŒ…å«ï¼š
                            {
                                "title": "æ•…äº‹æ¨™é¡Œ",
                                "style": "è¦–è¦ºé¢¨æ ¼æè¿°",
                                "characters": [
                                    {
                                        "name": "è§’è‰²åç¨±",
                                        "type": "è§’è‰²é¡å‹",
                                        "personality": "æ€§æ ¼ç‰¹é»",
                                        "color": "ä»£è¡¨é¡è‰²",
                                        "scale": 0.8-1.5,
                                        "special_features": "ç‰¹æ®Šç‰¹å¾µ"
                                    }
                                ],
                                "scenes": [
                                    {
                                        "id": 1,
                                        "description": "å ´æ™¯æè¿°",
                                        "background": "èƒŒæ™¯é¡å‹",
                                        "duration": 5000,
                                        "camera": "æ”å½±æ©Ÿè§’åº¦",
                                        "mood": "æƒ…æ„Ÿæ°›åœ",
                                        "characters_actions": [
                                            {
                                                "character": "è§’è‰²åç¨±",
                                                "action": "å…·é«”å‹•ä½œ",
                                                "intensity": 1.0,
                                                "start_time": 0,
                                                "duration": 2000,
                                                "emotion": "æƒ…æ„Ÿç‹€æ…‹"
                                            }
                                        ],
                                        "props": ["é“å…·1", "é“å…·2"],
                                        "effects": ["ç‰¹æ•ˆ1", "ç‰¹æ•ˆ2"]
                                    }
                                ],
                                "insights": "å°æ¼”åˆ†æå’Œå»ºè­°",
                                "theme": "æ•…äº‹ä¸»é¡Œ",
                                "emotional_arc": "æƒ…æ„Ÿå¼§ç·šæè¿°"
                            }`
                        }, {
                            role: "user",
                            content: storyText
                        }],
                        temperature: this.creativity,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI APIéŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // å¦‚æœä¸æ˜¯ç´”JSONï¼Œå˜—è©¦æå–JSONéƒ¨åˆ†
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error('ç„¡æ³•è§£æAIè¿”å›çš„å…§å®¹');
                }
            }
            
            async analyzeWithGemini(storyText) {
                if (!this.apiKey) {
                    throw new Error('è«‹æä¾›Google Gemini API Key');
                }
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `ä½œç‚ºå°ˆæ¥­å‹•ç•«å°æ¼”ï¼Œè«‹åˆ†æä»¥ä¸‹ç¥è©±æ•…äº‹ä¸¦ç”Ÿæˆç«æŸ´äººå‹•ç•«è…³æœ¬ï¼š\n\n${storyText}\n\nè«‹è¿”å›è©³ç´°çš„JSONæ ¼å¼å‹•ç•«æ•¸æ“šï¼ŒåŒ…å«è§’è‰²ã€å ´æ™¯ã€å‹•ä½œåºåˆ—ã€æƒ…æ„Ÿåˆ†æç­‰ã€‚`
                            }]
                        }],
                        generationConfig: {
                            temperature: this.creativity,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Gemini APIéŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                
                // è§£æå…§å®¹ä¸¦æå–JSON
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                throw new Error('ç„¡æ³•å¾GeminiéŸ¿æ‡‰ä¸­æå–æœ‰æ•ˆæ•¸æ“š');
            }
            
            async analyzeWithLocal(storyText, modelName = 'qwen2:7b') {
                // æ ¹æ“šæ¨¡å‹èª¿æ•´promptèªè¨€
                const isQwen = modelName.includes('qwen');
                
                const prompt = isQwen ? 
                    `ä½œç‚ºå°ˆæ¥­å‹•ç•«å°æ¼”ï¼Œè«‹åˆ†æä»¥ä¸‹ç¥è©±æ•…äº‹ä¸¦ç”Ÿæˆè©³ç´°çš„ç«æŸ´äººå‹•ç•«è…³æœ¬ã€‚

æ•…äº‹ï¼š${storyText}

è«‹ç”¨JSONæ ¼å¼å›å¾©ï¼ŒåŒ…å«ï¼š
{
    "title": "æ•…äº‹æ¨™é¡Œ",
    "style": "å‹•ç•«é¢¨æ ¼",
    "characters": [{"name": "è§’è‰²åç¨±", "type": "è§’è‰²é¡å‹", "color": "#é¡è‰²", "scale": 1.0, "personality": "æ€§æ ¼ç‰¹å¾µ", "special_features": "ç‰¹æ®Šç‰¹å¾µ"}],
    "scenes": [{"id": 1, "description": "å ´æ™¯æè¿°", "background": "èƒŒæ™¯é¡å‹", "duration": 5000, "mood": "æƒ…æ„Ÿæ°›åœ", "characters_actions": [{"character": "è§’è‰²åç¨±", "action": "å‹•ä½œé¡å‹", "intensity": 1.0, "emotion": "æƒ…æ„Ÿç‹€æ…‹"}], "props": ["é“å…·1"], "effects": ["ç‰¹æ•ˆ1"]}],
    "insights": "å°æ¼”åˆ†æå’Œå»ºè­°",
    "theme": "æ•…äº‹ä¸»é¡Œ",
    "emotional_arc": "æƒ…æ„Ÿå¼§ç·š"
}` :
                    `As a professional animation director, analyze this mythology story and create a detailed animation script in JSON format.

Story: ${storyText}

Please respond with a JSON object containing:
{
    "title": "Story title",
    "style": "Animation style", 
    "characters": [{"name": "Character name", "type": "character type", "color": "#color", "scale": 1.0, "personality": "traits", "special_features": "special features"}],
    "scenes": [{"id": 1, "description": "Scene description", "background": "background type", "duration": 5000, "mood": "emotional tone", "characters_actions": [{"character": "name", "action": "action type", "intensity": 1.0, "emotion": "emotion"}], "props": ["prop1"], "effects": ["effect1"]}],
    "insights": "Director's analysis and recommendations",
    "theme": "Story theme",
    "emotional_arc": "Emotional progression"
}`;

                const response = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelName,
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: this.creativity,
                            top_p: 0.9,
                            num_predict: 2000
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`æœ¬åœ°LLMé€£æ¥å¤±æ•—: ${response.status}ã€‚è«‹ç¢ºä¿${modelName}æ¨¡å‹å·²å®‰è£ä¸¦ä¸”Ollamaæ­£åœ¨é‹è¡Œã€‚`);
                }
                
                const data = await response.json();
                console.log(`${modelName} response:`, data.response);
                
                // å˜—è©¦æå–JSON
                const jsonMatches = data.response.match(/\{[\s\S]*?\}/g);
                
                if (jsonMatches) {
                    // å˜—è©¦è§£ææ¯å€‹å¯èƒ½çš„JSON
                    for (const jsonStr of jsonMatches) {
                        try {
                            const parsed = JSON.parse(jsonStr);
                            // é©—è­‰å¿…éœ€çš„å­—æ®µ
                            if (parsed.title && parsed.characters && parsed.scenes) {
                                return parsed;
                            }
                        } catch (e) {
                            console.warn('JSONè§£æå¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹');
                        }
                    }
                }
                
                // å¦‚æœç„¡æ³•è§£æJSONï¼Œä½¿ç”¨æ™ºèƒ½è§£æ
                console.warn('ä½¿ç”¨å‚™ç”¨è§£ææ–¹æ¡ˆ');
                return this.parseLocalLLMResponse(data.response, storyText);
            }
            
            parseLocalLLMResponse(response, originalText) {
                // ç•¶æœ¬åœ°LLMç„¡æ³•è¿”å›æ¨™æº–JSONæ™‚çš„å‚™ç”¨è§£æ
                console.log('ä½¿ç”¨å‚™ç”¨è§£ææ–¹æ¡ˆ');
                
                const characters = this.extractCharacters(originalText);
                const scenes = this.generateScenes(originalText, characters);
                
                return {
                    title: "æœ¬åœ°AIè§£æçš„ç¥è©±æ•…äº‹",
                    style: this.animationStyle,
                    characters: characters,
                    scenes: scenes,
                    insights: `æœ¬åœ°Llama2åˆ†æ: ${response.substring(0, 200)}...`,
                    theme: this.getStoryGenre(originalText),
                    emotional_arc: "é–‹å§‹ â†’ ç™¼å±• â†’ é«˜æ½® â†’ çµå±€"
                };
            }
            
            async generateDemoAnalysis(storyText) {
                // Demoæ¨¡å¼ï¼šæ™ºèƒ½è§£ææ–‡æœ¬ç”Ÿæˆçµæ§‹åŒ–æ•¸æ“š
                await new Promise(resolve => setTimeout(resolve, 2000)); // æ¨¡æ“¬APIå»¶é²
                
                const characters = this.extractCharacters(storyText);
                const scenes = this.generateScenes(storyText, characters);
                
                return {
                    title: "æ™ºèƒ½è§£æçš„ç¥è©±æ•…äº‹",
                    style: this.animationStyle,
                    characters: characters,
                    scenes: scenes,
                    insights: `æ ¹æ“šæ–‡æœ¬åˆ†æï¼Œé€™æ˜¯ä¸€å€‹${this.getStoryGenre(storyText)}çš„æ•…äº‹ã€‚æƒ…æ„Ÿå¼·åº¦è¼ƒ${this.getEmotionalIntensity(storyText)}ï¼Œé©åˆç”¨${this.animationStyle}é¢¨æ ¼è¡¨ç¾ã€‚å»ºè­°é‡é»çªå‡º${this.getKeyThemes(storyText)}çš„ä¸»é¡Œã€‚`,
                    theme: this.getStoryGenre(storyText),
                    emotional_arc: "é–‹å§‹å¹³éœ â†’ è¡çªå‡ç´š â†’ é«˜æ½® â†’ çµå±€"
                };
            }
            
            extractCharacters(text) {
                // æ™ºèƒ½è§’è‰²æå–
                const characterKeywords = {
                    'å¤¸çˆ¶': { type: 'giant', color: '#ff6b6b', scale: 1.3, personality: 'å …æ¯…ä¸å±ˆ' },
                    'å“ªå’': { type: 'divine_child', color: '#ffd700', scale: 0.8, personality: 'å‹‡æ•¢é ‘çš®' },
                    'æ•–ä¸™': { type: 'dragon_prince', color: '#4169e1', scale: 1.1, personality: 'é«˜å‚²å¨åš´' },
                    'ç´ æˆ”å—šå°Š': { type: 'storm_god', color: '#8b00ff', scale: 1.2, personality: 'å‹‡çŒ›ç„¡ç•' },
                    'å…«å²å¤§è›‡': { type: 'serpent', color: '#228b22', scale: 2.0, personality: 'å‡¶æƒ¡ææ€–' },
                    'å«¦å¨¥': { type: 'moon_goddess', color: '#c0c0c0', scale: 0.9, personality: 'å„ªé›…ç¥ç§˜' }
                };
                
                const foundCharacters = [];
                for (const [name, data] of Object.entries(characterKeywords)) {
                    if (text.includes(name)) {
                        foundCharacters.push({
                            name,
                            ...data,
                            special_features: this.getSpecialFeatures(name)
                        });
                    }
                }
                
                // å¦‚æœæ²’æœ‰è­˜åˆ¥åˆ°è§’è‰²ï¼Œå‰µå»ºé€šç”¨è§’è‰²
                if (foundCharacters.length === 0) {
                    foundCharacters.push({
                        name: 'ä¸»è§’',
                        type: 'hero',
                        color: '#ff6b6b',
                        scale: 1.0,
                        personality: 'è‹±å‹‡',
                        special_features: 'ç™¼å…‰çš„çœ¼ç›'
                    });
                }
                
                return foundCharacters;
            }
            
            generateScenes(text, characters) {
                // æ™ºèƒ½å ´æ™¯åˆ†å‰²
                const sentences = text.split(/[ã€‚ï¼.!ï¼?ï¼Ÿ\n]/).filter(s => s.trim().length > 5);
                const scenes = [];
                
                sentences.forEach((sentence, index) => {
                    const actions = this.extractActions(sentence);
                    const background = this.detectBackground(sentence);
                    
                    scenes.push({
                        id: index + 1,
                        description: sentence,
                        background: background,
                        duration: Math.max(3000, sentence.length * 100),
                        camera: index === 0 ? 'wide' : (index === sentences.length - 1 ? 'close' : 'medium'),
                        mood: this.detectMood(sentence),
                        characters_actions: this.generateCharacterActions(sentence, characters, actions),
                        props: this.extractProps(sentence),
                        effects: this.suggestEffects(sentence)
                    });
                });
                
                return scenes;
            }
            
            extractActions(text) {
                const actionKeywords = {
                    'è·‘': 'run', 'è¿½': 'chase', 'é£›': 'fly', 'æˆ°': 'fight', 
                    'å€’': 'fall', 'ç«™': 'stand', 'å': 'sit', 'è·³': 'jump',
                    'æ”»æ“Š': 'attack', 'é˜²ç¦¦': 'defend', 'é€ƒè·‘': 'flee'
                };
                
                const actions = [];
                for (const [keyword, action] of Object.entries(actionKeywords)) {
                    if (text.includes(keyword)) {
                        actions.push(action);
                    }
                }
                
                return actions.length > 0 ? actions : ['idle'];
            }
            
            detectBackground(text) {
                const backgrounds = {
                    'å±±': 'mountain', 'æµ·': 'ocean', 'å¤©': 'sky', 'æ£®æ—': 'forest',
                    'å®®æ®¿': 'palace', 'æ²™æ¼ ': 'desert', 'æœˆ': 'moon', 'é›²': 'clouds'
                };
                
                for (const [keyword, bg] of Object.entries(backgrounds)) {
                    if (text.includes(keyword)) {
                        return bg;
                    }
                }
                
                return 'default';
            }
            
            detectMood(text) {
                if (text.includes('æ€’') || text.includes('æ†¤')) return 'angry';
                if (text.includes('æ‚²') || text.includes('å‚·')) return 'sad';
                if (text.includes('å–œ') || text.includes('æ¨‚')) return 'happy';
                if (text.includes('æ') || text.includes('æ€–')) return 'fearful';
                if (text.includes('æˆ°') || text.includes('é¬¥')) return 'intense';
                return 'neutral';
            }
            
            generateCharacterActions(sentence, characters, actions) {
                return characters.map((char, index) => ({
                    character: char.name,
                    action: actions[index % actions.length],
                    intensity: this.calculateIntensity(sentence),
                    start_time: 0,
                    duration: 2000,
                    emotion: this.detectMood(sentence)
                }));
            }
            
            calculateIntensity(text) {
                let intensity = 0.5;
                if (text.includes('æ¿€çƒˆ') || text.includes('çŒ›çƒˆ')) intensity += 0.4;
                if (text.includes('è¼•') || text.includes('æ…¢')) intensity -= 0.3;
                if (text.includes('å¿«') || text.includes('æ€¥')) intensity += 0.3;
                return Math.max(0.1, Math.min(1.5, intensity));
            }
            
            extractProps(text) {
                const props = [];
                if (text.includes('å¤ªé™½')) props.push('sun');
                if (text.includes('æœˆ')) props.push('moon');
                if (text.includes('åŠ')) props.push('sword');
                if (text.includes('å¼“')) props.push('bow');
                if (text.includes('æ··å¤©ç¶¾')) props.push('magic_cloth');
                return props;
            }
            
            suggestEffects(text) {
                const effects = [];
                if (text.includes('ç«') || text.includes('ç‡ƒç‡’')) effects.push('fire');
                if (text.includes('æ°´') || text.includes('æ³¢æµª')) effects.push('water');
                if (text.includes('é›·') || text.includes('é›»')) effects.push('lightning');
                if (text.includes('é¢¨') || text.includes('é¢±é¢¨')) effects.push('wind');
                return effects;
            }
            
            getSpecialFeatures(characterName) {
                const features = {
                    'å¤¸çˆ¶': 'ç™¼å…‰çš„å·¨å¤§èº«è»€',
                    'å“ªå’': 'è“®èŠ±è£é£¾å’Œä¸‰é ­å…­è‡‚',
                    'æ•–ä¸™': 'é¾é±—å’Œé¾è§’',
                    'ç´ æˆ”å—šå°Š': 'é›·é›»ç’°ç¹',
                    'å«¦å¨¥': 'æœˆå…‰å…‰è¼'
                };
                return features[characterName] || 'ç‰¹æ®Šå…‰æ•ˆ';
            }
            
            getStoryGenre(text) {
                if (text.includes('æˆ°') || text.includes('é¬¥')) return 'è‹±é›„å†’éšª';
                if (text.includes('æ„›') || text.includes('æƒ…')) return 'æµªæ¼«æ„›æƒ…';
                if (text.includes('çŠ§ç‰²') || text.includes('æ­»')) return 'æ‚²åŠ‡å²è©©';
                return 'ç¥è©±å‚³èªª';
            }
            
            getEmotionalIntensity(text) {
                const intensityWords = ['æ¿€çƒˆ', 'çŒ›çƒˆ', 'ç‹‚æš´', 'æº«å’Œ', 'å¹³éœ', 'è¼•æŸ”'];
                let intensity = 'ä¸­ç­‰';
                
                if (text.includes('æ¿€çƒˆ') || text.includes('çŒ›çƒˆ')) intensity = 'é«˜';
                if (text.includes('å¹³éœ') || text.includes('æº«å’Œ')) intensity = 'ä½';
                
                return intensity;
            }
            
            getKeyThemes(text) {
                const themes = [];
                if (text.includes('è¿½') || text.includes('å¤¢æƒ³')) themes.push('è¿½æ±‚ç†æƒ³');
                if (text.includes('çŠ§ç‰²')) themes.push('è‹±å‹‡çŠ§ç‰²');
                if (text.includes('æ„›')) themes.push('æ„›èˆ‡å¥‰ç»');
                if (text.includes('æ­£ç¾©')) themes.push('æ­£ç¾©æˆ°å‹é‚ªæƒ¡');
                return themes.length > 0 ? themes.join('ã€') : 'å‹‡æ°£èˆ‡æˆé•·';
            }
            
            displayAnalysis(analysis) {
                const container = document.getElementById('aiAnalysis');
                
                if (!analysis) {
                    container.innerHTML = '<div style="color: #ff6b6b;">åˆ†ææ•¸æ“šç„¡æ•ˆ</div>';
                    return;
                }
                
                // ç¢ºä¿æ‰€æœ‰å¿…éœ€çš„å±¬æ€§å­˜åœ¨
                const title = analysis.title || 'æœªçŸ¥æ¨™é¡Œ';
                const theme = analysis.theme || 'æœªçŸ¥ä¸»é¡Œ';
                const style = analysis.style || 'é è¨­é¢¨æ ¼';
                const characters = analysis.characters || [];
                const scenes = analysis.scenes || [];
                const emotional_arc = analysis.emotional_arc || 'æœªå®šç¾©';
                
                container.innerHTML = `
                    <div class="analysis-section">
                        <div class="analysis-title">ğŸ“– æ•…äº‹æ¦‚è¿°</div>
                        <div class="analysis-content">
                            <strong>æ¨™é¡Œ:</strong> ${title}<br>
                            <strong>ä¸»é¡Œ:</strong> ${theme}<br>
                            <strong>é¢¨æ ¼:</strong> ${style}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <div class="analysis-title">ğŸ‘¥ è§’è‰²åˆ†æ</div>
                        <div class="analysis-content">
                            ${characters.length > 0 ? characters.map(char => 
                                `<div style="margin-bottom: 8px;">
                                    <strong>${char.name || 'æœªçŸ¥è§’è‰²'}</strong> (${char.type || 'æœªçŸ¥é¡å‹'})<br>
                                    <small>æ€§æ ¼: ${char.personality || 'æœªçŸ¥'} | ç‰¹å¾µ: ${char.special_features || 'ç„¡ç‰¹æ®Šç‰¹å¾µ'}</small>
                                </div>`
                            ).join('') : 'æš«ç„¡è§’è‰²ä¿¡æ¯'}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <div class="analysis-title">ğŸ¬ å ´æ™¯è¦åŠƒ</div>
                        <div class="analysis-content">
                            å…± ${scenes.length} å€‹å ´æ™¯<br>
                            ç¸½æ™‚é•·: ${scenes.length > 0 ? Math.round(scenes.reduce((sum, scene) => sum + (scene.duration || 3000), 0) / 1000) : 0} ç§’<br>
                            æƒ…æ„Ÿå¼§ç·š: ${emotional_arc}
                        </div>
                    </div>
                `;
            }
            
            loadAnimation(data) {
                this.animationData = data;
                this.currentScene = 0;
                this.renderCurrentScene();
            }
            
            renderCurrentScene() {
                if (!this.animationData) return;
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç°¡åŒ–çš„æ¸²æŸ“ç³»çµ±
                const scene = this.animationData.scenes[this.currentScene];
                if (!scene) return;
                
                // ç¹ªè£½èƒŒæ™¯
                this.drawBackground(scene.background);
                
                // ç¹ªè£½è§’è‰²
                scene.characters_actions.forEach((action, index) => {
                    this.drawCharacter(action, index);
                });
                
                // ç¹ªè£½é“å…·å’Œç‰¹æ•ˆ
                scene.props.forEach(prop => this.drawProp(prop));
                scene.effects.forEach(effect => this.drawEffect(effect));
            }
            
            drawBackground(backgroundType) {
                let gradient;
                
                switch(backgroundType) {
                    case 'mountain':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#87CEEB');
                        gradient.addColorStop(1, '#228B22');
                        break;
                    case 'ocean':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#87CEEB');
                        gradient.addColorStop(1, '#4682B4');
                        break;
                    case 'sky':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#FFD700');
                        gradient.addColorStop(1, '#87CEEB');
                        break;
                    default:
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#98FB98');
                        gradient.addColorStop(1, '#90EE90');
                }
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            drawCharacter(actionData, index) {
                const x = (this.canvas.width / (this.animationData.characters.length + 1)) * (index + 1);
                const y = this.canvas.height * 0.6;
                const character = this.animationData.characters.find(c => c.name === actionData.character);
                
                if (!character) return;
                
                this.ctx.save();
                this.ctx.translate(x, y);
                this.ctx.scale(character.scale, character.scale);
                
                // æ ¹æ“šå‹•ä½œèª¿æ•´å§¿æ…‹
                let rotation = 0;
                if (actionData.action === 'run') rotation = Math.sin(Date.now() * 0.01) * 0.1;
                if (actionData.action === 'fall') rotation = Math.PI / 4;
                
                this.ctx.rotate(rotation);
                
                this.ctx.strokeStyle = character.color;
                this.ctx.lineWidth = 4;
                this.ctx.lineCap = 'round';
                
                // ç°¡åŒ–çš„ç«æŸ´äººç¹ªè£½
                // é ­éƒ¨
                this.ctx.beginPath();
                this.ctx.arc(0, -60, 18, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // èº«é«”
                this.ctx.beginPath();
                this.ctx.moveTo(0, -42);
                this.ctx.lineTo(0, 20);
                this.ctx.stroke();
                
                // æ ¹æ“šå‹•ä½œç¹ªè£½å››è‚¢
                this.drawLimbs(actionData.action, actionData.intensity);
                
                // ç¹ªè£½ç‰¹æ®Šç‰¹å¾µ
                this.drawSpecialFeatures(character);
                
                this.ctx.restore();
            }
            
            drawLimbs(action, intensity) {
                const time = Date.now() * 0.01;
                let armAngle = 0;
                let legAngle = 0;
                
                switch(action) {
                    case 'run':
                        armAngle = Math.sin(time) * 0.8 * intensity;
                        legAngle = Math.sin(time) * 0.6 * intensity;
                        break;
                    case 'fight':
                        armAngle = -Math.PI/3 + Math.sin(time * 2) * 0.5;
                        legAngle = 0.2;
                        break;
                    case 'fall':
                        armAngle = 1.2;
                        legAngle = 0.5;
                        break;
                    default:
                        armAngle = 0.2;
                        legAngle = 0;
                }
                
                // å·¦è‡‚
                this.ctx.beginPath();
                this.ctx.moveTo(0, -20);
                this.ctx.lineTo(-25 * Math.cos(armAngle), -20 + 25 * Math.sin(armAngle));
                this.ctx.stroke();
                
                // å³è‡‚
                this.ctx.beginPath();
                this.ctx.moveTo(0, -20);
                this.ctx.lineTo(25 * Math.cos(-armAngle), -20 + 25 * Math.sin(-armAngle));
                this.ctx.stroke();
                
                // å·¦è…¿
                this.ctx.beginPath();
                this.ctx.moveTo(0, 20);
                this.ctx.lineTo(-20 * Math.cos(legAngle), 20 + 30 * Math.sin(legAngle) + 30);
                this.ctx.stroke();
                
                // å³è…¿
                this.ctx.beginPath();
                this.ctx.moveTo(0, 20);
                this.ctx.lineTo(20 * Math.cos(-legAngle), 20 + 30 * Math.sin(-legAngle) + 30);
                this.ctx.stroke();
            }
            
            drawSpecialFeatures(character) {
                // æ ¹æ“šè§’è‰²é¡å‹ç¹ªè£½ç‰¹æ®Šç‰¹å¾µ
                if (character.name === 'å“ªå’') {
                    // è“®èŠ±è£é£¾
                    this.ctx.strokeStyle = '#ff69b4';
                    this.ctx.lineWidth = 2;
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI * 2 / 6) * i;
                        this.ctx.beginPath();
                        this.ctx.moveTo(0, -60);
                        this.ctx.lineTo(Math.cos(angle) * 25, -60 + Math.sin(angle) * 25);
                        this.ctx.stroke();
                    }
                }
            }
            
            drawProp(prop) {
                switch(prop) {
                    case 'sun':
                        this.ctx.fillStyle = '#FFD700';
                        this.ctx.beginPath();
                        this.ctx.arc(this.canvas.width - 100, 80, 30, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                    case 'moon':
                        this.ctx.fillStyle = '#C0C0C0';
                        this.ctx.beginPath();
                        this.ctx.arc(100, 80, 25, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                }
            }
            
            drawEffect(effect) {
                // ç°¡åŒ–çš„ç‰¹æ•ˆç¹ªè£½
                if (effect === 'fire') {
                    this.ctx.fillStyle = `rgba(255, ${100 + Math.sin(Date.now() * 0.01) * 50}, 0, 0.7)`;
                    for (let i = 0; i < 5; i++) {
                        this.ctx.beginPath();
                        this.ctx.arc(
                            this.canvas.width * 0.5 + Math.random() * 100 - 50,
                            this.canvas.height * 0.8 + Math.random() * 50,
                            Math.random() * 10 + 5,
                            0, Math.PI * 2
                        );
                        this.ctx.fill();
                    }
                }
            }
            
            showInsights(insights) {
                document.getElementById('insightsContent').textContent = insights;
            }
            
            showLoading(show) {
                const loading = document.getElementById('loading');
                const btn = document.getElementById('generateBtn');
                
                if (show) {
                    loading.classList.add('show');
                    btn.disabled = true;
                    btn.innerHTML = '<span>ğŸ¤– AIåˆ†æä¸­...</span>';
                } else {
                    loading.classList.remove('show');
                    btn.disabled = false;
                    btn.innerHTML = '<span>ğŸš€ AIç”Ÿæˆå‹•ç•«</span>';
                }
            }
            
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            
            clearError() {
                document.getElementById('errorMessage').style.display = 'none';
            }
            
            play() {
                this.isPlaying = true;
                document.getElementById('playBtn').innerHTML = 'â¸ æš«åœ';
                document.getElementById('playBtn').classList.add('active');
                this.animate();
            }
            
            pause() {
                this.isPlaying = false;
                document.getElementById('playBtn').innerHTML = 'â–¶ æ’­æ”¾';
                document.getElementById('playBtn').classList.remove('active');
            }
            
            animate() {
                if (!this.isPlaying || !this.animationData) return;
                
                this.renderCurrentScene();
                
                // ç°¡å–®çš„å ´æ™¯åˆ‡æ›é‚è¼¯
                if (Math.random() < 0.01) {
                    this.currentScene = (this.currentScene + 1) % this.animationData.scenes.length;
                }
                
                requestAnimationFrame(() => this.animate());
            }
        }
        
        // ==================== å…¨å±€å‡½æ•¸ ====================
        
        let aiEngine;
        
        function initializeSystem() {
            aiEngine = new AIAnimationEngine();
            
            // è¼‰å…¥ç¤ºä¾‹
            setTimeout(() => {
                loadExample(document.querySelector('.example-prompt'));
            }, 1000);
        }
        
        function loadExample(element) {
            const examples = {
                'å¤¸çˆ¶è¿½æ—¥': `å¤¸çˆ¶æ±ºå¿ƒè¿½ä¸Šå¤ªé™½ï¼Œä»–é‚é–‹å·¨å¤§çš„æ­¥ä¼é–‹å§‹å¥”è·‘ã€‚è·¨è¶Šé«˜å±±ï¼Œç©¿éæ£®æ—ï¼Œè¶Šéå¤§æ²³ï¼Œä½†å¤ªé™½å§‹çµ‚åœ¨å‰æ–¹ã€‚æ¸´æœ›è®“ä»–åœä¸‹ä¾†å–å…‰äº†é»ƒæ²³å’Œæ¸­æ°´ï¼Œä½†ä»ç„¶ä¸å¤ ã€‚ä»–ç¹¼çºŒå‘åŒ—æ–¹çš„å¤§æ¾¤å¥”å»ï¼Œä½†çµ‚æ–¼é«”åŠ›ä¸æ”¯å€’ä¸‹ã€‚å¤¸çˆ¶æ­»å¾Œï¼Œä»–çš„æ‰‹æ–åŒ–ä½œäº†ä¸€ç‰‡èŒ‚å¯†çš„æ¡ƒæ—ï¼Œç‚ºå¾Œä¾†çš„æ—…äººæä¾›é™°æ¶¼å’Œç”˜ç”œçš„æœå¯¦ã€‚`,
                
                'ç´ æˆ”å—šå°Š': `ç´ æˆ”å—šå°Šè½èªªå…«å²å¤§è›‡æ­£åœ¨å¨è„…äººé–“ï¼Œä»–æ¯…ç„¶æ±ºå®šå‰å¾€è¨ä¼ã€‚ä¾†åˆ°å¤§è›‡çš„å·¢ç©´ï¼Œåªè¦‹å…«å€‹å¦‚å±±èˆ¬å·¨å¤§çš„é ­é¡±ï¼Œå…«æ¢é•·å°¾æ©«æƒå¤©åœ°ã€‚ç´ æˆ”å—šå°Šæ¯«ä¸ç•æ‡¼ï¼Œå…ˆç”¨ç¾é…’è®“å¤§è›‡é†‰å€’ï¼Œç„¶å¾ŒæŠ½å‡ºç¥åŠè‰è–™åŠï¼Œèˆ‡æ€ªç‰©å±•é–‹æ¿€çƒˆçš„æˆ°é¬¥ã€‚ç¶“éä¸€ç•ªæƒ¡æˆ°ï¼Œä»–çµ‚æ–¼æ–¬æ®ºäº†å…«å²å¤§è›‡ï¼Œä¸¦åœ¨è›‡å°¾ä¸­ç™¼ç¾äº†çè²´çš„è‰è–™åŠï¼Œå¾Œä¾†å°‡å…¶ç»çµ¦äº†å§å§å¤©ç…§å¤§ç¥ã€‚`,
                
                'å«¦å¨¥å¥”æœˆ': `åç¾¿å°„ä¸‹ä¹å€‹å¤ªé™½å¾Œï¼Œè¥¿ç‹æ¯è³œçµ¦ä»–ä¸æ­»è—¥ä½œç‚ºçè³ã€‚åç¾¿å°‡è—¥äº¤çµ¦å¦»å­å«¦å¨¥ä¿ç®¡ã€‚æŸæ—¥ï¼Œåç¾¿å¤–å‡ºç‹©çµï¼Œå«¦å¨¥ç¨è‡ªåœ¨å®¶ï¼Œå¥½å¥‡å¿ƒé©…ä½¿å¥¹æ‰“é–‹äº†è—¥ç“¶ã€‚è—¥é¦™æ’²é¼»ï¼Œå¥¹å¿ä¸ä½å“åšäº†ä¸€å£ï¼Œéš¨å³æ„Ÿåˆ°èº«é«”è¼•é£„é£„çš„ï¼Œä¸ç”±è‡ªä¸»åœ°é£›å‘å¤©ç©ºã€‚å¥¹è¶Šé£›è¶Šé«˜ï¼Œæœ€çµ‚è½åœ¨äº†æœˆå®®ä¸­ï¼Œå¾æ­¤èˆ‡åç¾¿å¤©å„ä¸€æ–¹ï¼Œåªèƒ½åœ¨æ¯å€‹æœˆåœ“ä¹‹å¤œé™é™ç›¸æœ›ã€‚`
            };
            
            const text = element.textContent;
            for (const [key, value] of Object.entries(examples)) {
                if (text.includes(key)) {
                    document.getElementById('storyInput').value = value;
                    break;
                }
            }
        }
        
        async function generateWithAI() {
            const storyText = document.getElementById('storyInput').value.trim();
            if (!storyText) {
                alert('è«‹è¼¸å…¥æ•…äº‹æ–‡æœ¬');
                return;
            }
            
            await aiEngine.generateAnimation(storyText);
        }
        
        function togglePlay() {
            if (aiEngine.isPlaying) {
                aiEngine.pause();
            } else {
                aiEngine.play();
            }
        }
        
        function restartAnimation() {
            aiEngine.currentScene = 0;
            aiEngine.pause();
            aiEngine.renderCurrentScene();
        }
        
        function exportAnimation() {
            alert('å°å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...');
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>