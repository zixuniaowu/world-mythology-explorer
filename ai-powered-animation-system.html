<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÂãïÂäõÂãïÁï´ÁîüÊàêÁ≥ªÁµ± - Ê¨°‰∏ñ‰ª£ÊñáÂ≠óËΩâÂãïÁï´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .ai-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .ai-badge {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .ai-badge.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .main-container {
            flex: 1;
            display: flex;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        .left-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .story-textarea {
            width: 100%;
            height: 180px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            padding: 15px;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .story-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .ai-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-label {
            font-size: 0.9em;
            color: #ccc;
        }

        .config-select, .config-input {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-family: inherit;
        }

        .config-select option {
            background: #333;
            color: white;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            border: none;
            border-radius: 10px;
            color: #333;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            position: relative;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-analysis {
            max-height: 300px;
            overflow-y: auto;
        }

        .analysis-section {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .analysis-title {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .analysis-content {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .canvas-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canvas-title {
            font-size: 1.8em;
            color: #ffd700;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #ffd700;
        }

        .control-btn.active {
            background: #ffd700;
            color: #333;
            border-color: #ffd700;
        }

        .animation-canvas {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .ai-insights {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .insights-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-content {
            font-size: 1em;
            line-height: 1.6;
            color: #f0f0f0;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .ai-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            color: #ffaaaa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .example-prompt {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .example-prompt:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ffd700;
            transform: translateX(5px);
        }

        .progress-section {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffb347 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
            }
            
            .ai-config {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ AIÂãïÂäõÂãïÁï´ÁîüÊàêÁ≥ªÁµ±</h1>
        <p class="subtitle">Ê¨°‰∏ñ‰ª£ÊñáÂ≠óËΩâÁÅ´Êü¥‰∫∫ÂãïÁï´ÊäÄË°ì</p>
        <div class="ai-badges">
            <span class="ai-badge active" data-model="gpt">GPT-4 Turbo</span>
            <span class="ai-badge" data-model="gemini">Gemini Pro</span>
            <span class="ai-badge" data-model="claude">Claude 3</span>
            <span class="ai-badge" data-model="local">Êú¨Âú∞LLM</span>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <!-- AIË®≠ÂÆöÈù¢Êùø -->
            <div class="panel">
                <h3 class="panel-title">
                    <span>üß†</span>
                    <span>AIÂºïÊìéË®≠ÂÆö</span>
                </h3>

                <div class="ai-config">
                    <div class="config-item">
                        <label class="config-label">AIÊ®°Âûã</label>
                        <select class="config-select" id="aiModel">
                            <option value="demo">DemoÊ®°Âºè (Êô∫ËÉΩË¶èÂâá)</option>
                            <option value="qwen2" selected>üî• Êú¨Âú∞Qwen2 (ÊúÄ‰Ω≥‰∏≠Êñá)</option>
                            <option value="llama2">‚úÖ Êú¨Âú∞Llama2 (Ëã±ÊñáËºÉ‰Ω≥)</option>
                            <option value="gpt-3.5">GPT-3.5 Turbo (ÈúÄË¶ÅAPI Key)</option>
                            <option value="gpt-4">GPT-4 (ÈúÄË¶ÅAPI Key)</option>
                            <option value="gemini">Gemini Pro (ÈúÄË¶ÅAPI Key)</option>
                            <option value="claude">Claude 3 (ÈúÄË¶ÅAPI Key)</option>
                        </select>
                    </div>

                    <div class="config-item">
                        <label class="config-label">ÂâµÈÄ†Âäõ</label>
                        <select class="config-select" id="creativity">
                            <option value="0.3">‰øùÂÆà (0.3)</option>
                            <option value="0.7" selected>Âπ≥Ë°° (0.7)</option>
                            <option value="1.0">ÂâµÊñ∞ (1.0)</option>
                        </select>
                    </div>

                    <div class="config-item">
                        <label class="config-label">ÂãïÁï´È¢®Ê†º</label>
                        <select class="config-select" id="animationStyle">
                            <option value="traditional">ÂÇ≥Áµ±Á•ûË©±</option>
                            <option value="modern" selected>Áèæ‰ª£ÊºîÁππ</option>
                            <option value="cartoon">Âç°ÈÄöÈ¢®Ê†º</option>
                            <option value="realistic">ÂØ´ÂØ¶È¢®Ê†º</option>
                        </select>
                    </div>

                    <div class="config-item">
                        <label class="config-label">API Key</label>
                        <input type="password" class="config-input" id="apiKey" 
                               placeholder="Ëº∏ÂÖ•API Key (ÂèØÈÅ∏)">
                    </div>
                </div>
            </div>

            <!-- ÊïÖ‰∫ãËº∏ÂÖ•Èù¢Êùø -->
            <div class="panel">
                <h3 class="panel-title">
                    <span>üìù</span>
                    <span>ÊïÖ‰∫ãÊñáÊú¨Ëº∏ÂÖ•</span>
                </h3>

                <div class="example-prompts">
                    <div class="example-prompt" onclick="loadExample(this)">
                        üêâ Â§∏Áà∂ËøΩÊó•ÔºöÂ§∏Áà∂Ê±∫ÂøÉËøΩ‰∏äÂ§™ÈôΩÔºåË∑ëÈÅéÈ´òÂ±±ÂíåÂ§ßÊ≤≥...
                    </div>
                    <div class="example-prompt" onclick="loadExample(this)">
                        ‚öîÔ∏è Á¥†ÊàîÂóöÂ∞äÔºöÂãáÊï¢ÁöÑÁ•ûÈùàÈù¢Â∞çÂÖ´È†≠ÂÖ´Â∞æÁöÑÂ∑®Ëõá...
                    </div>
                    <div class="example-prompt" onclick="loadExample(this)">
                        üåô Â´¶Â®•Â•îÊúàÔºöÁæéÈ∫óÁöÑÂ´¶Â®•ÂÅ∑ÂêÉ‰∫Ü‰∏çÊ≠ªËó•ÔºåÈ£õÂêëÊúàÂÆÆ...
                    </div>
                </div>

                <textarea class="story-textarea" id="storyInput" placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁ•ûË©±ÊïÖ‰∫ã...

Á§∫‰æãÔºö
Â§∏Áà∂Ê±∫ÂøÉËøΩ‰∏äÂ§™ÈôΩÔºå‰ªñÈÇÅÈñãÂ∑®Â§ßÁöÑÊ≠•‰ºêÈñãÂßãÂ•îË∑ë„ÄÇË∑®Ë∂äÈ´òÂ±±ÔºåÁ©øÈÅéÊ£ÆÊûóÔºåË∂äÈÅéÂ§ßÊ≤≥Ôºå‰ΩÜÂ§™ÈôΩÂßãÁµÇÂú®ÂâçÊñπ„ÄÇÁµÇÊñºÔºåÂ§∏Áà∂Âõ†ÁÇ∫Ê∏¥ÊúõËÄåÂÄí‰∏ãÔºå‰ªñÁöÑÊâãÊùñÂåñ‰ΩúÊ°ÉÊûóÔºåÁÇ∫Âæå‰æÜÁöÑÊóÖ‰∫∫Êèê‰æõÈô∞Ê∂º„ÄÇ

ÊàñËÄÖÔºö
Á¥†ÊàîÂóöÂ∞äËÅΩË™™ÂÖ´Â≤êÂ§ßËõáÊ≠£Âú®Â®ÅËÑÖ‰∫∫ÈñìÔºå‰ªñÂãáÊï¢Âú∞ÊèêËµ∑Á•ûÂäçÔºå‰æÜÂà∞Â§ßËõáÁöÑÂ∑¢Á©¥„ÄÇÂÖ´ÂÄãÈ†≠È°±ÂêåÊôÇÂíÜÂìÆÔºå‰ΩÜËã±ÈõÑÊØ´‰∏çÁïèÊáºÔºåÊèÆÂäçÊñ¨ÂêëÊÄ™Áâ©..."></textarea>

                <button class="generate-btn" id="generateBtn" onclick="generateWithAI()">
                    <span>üöÄ AIÁîüÊàêÂãïÁï´</span>
                </button>

                <div class="loading" id="loading">
                    <div class="ai-spinner"></div>
                    <div>AIÊ≠£Âú®ÂàÜÊûêÊïÖ‰∫ã‰∏¶ÁîüÊàêÂãïÁï´...</div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">
                        ÈÄôÂèØËÉΩÈúÄË¶Å10-30ÁßíÊôÇÈñì
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- AIÂàÜÊûêÁµêÊûú -->
            <div class="panel">
                <h3 class="panel-title">
                    <span>üîç</span>
                    <span>AIÊ∑±Â∫¶ÂàÜÊûê</span>
                </h3>

                <div class="ai-analysis" id="aiAnalysis">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        Ëº∏ÂÖ•ÊïÖ‰∫ãÂæåÔºåAIÂ∞áÂú®Ê≠§È°ØÁ§∫Ë©≥Á¥∞ÂàÜÊûêÁµêÊûú
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- Áï´Â∏ÉÊéßÂà∂ -->
            <div class="canvas-controls">
                <h2 class="canvas-title">üé¨ Êô∫ËÉΩÂãïÁï´ÁîüÊàê</h2>
                <div class="playback-controls">
                    <button class="control-btn" id="playBtn" onclick="togglePlay()">
                        ‚ñ∂ Êí≠Êîæ
                    </button>
                    <button class="control-btn" onclick="restartAnimation()">
                        ‚èÆ ÈáçÊñ∞ÈñãÂßã
                    </button>
                    <button class="control-btn" onclick="exportAnimation()">
                        üíæ Â∞éÂá∫
                    </button>
                </div>
            </div>

            <!-- ÂãïÁï´Áï´Â∏É -->
            <div class="animation-canvas">
                <canvas id="animationCanvas"></canvas>
                
                <div class="progress-section">
                    <div class="progress-text">
                        <span>ÂãïÁï´ÈÄ≤Â∫¶</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="ai-insights">
                    <div class="insights-title">
                        <span>üß†</span>
                        <span>AIÂ∞éÊºîÊ¥ûÂØü</span>
                    </div>
                    <div class="insights-content" id="insightsContent">
                        AIÂ∞áÊ†πÊìöÊÇ®ÁöÑÊïÖ‰∫ãÊèê‰æõÂ∞àÊ•≠ÁöÑÂãïÁï´Â∞éÊºîÂª∫Ë≠∞ÂíåÊÉÖÊÑüÂàÜÊûê
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AIÈõÜÊàêÁ≥ªÁµ± ====================
        
        class AIAnimationEngine {
            constructor() {
                this.currentModel = 'demo';
                this.apiKey = '';
                this.creativity = 0.7;
                this.animationStyle = 'modern';
                this.setupCanvas();
                this.setupEventListeners();
            }
            
            setupCanvas() {
                this.canvas = document.getElementById('animationCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = 500;
                this.isPlaying = false;
                this.currentScene = 0;
                this.animationData = null;
            }
            
            setupEventListeners() {
                // AIÊ®°ÂûãÂàáÊèõ
                document.querySelectorAll('.ai-badge').forEach(badge => {
                    badge.addEventListener('click', () => {
                        document.querySelectorAll('.ai-badge').forEach(b => b.classList.remove('active'));
                        badge.classList.add('active');
                        this.currentModel = badge.dataset.model;
                    });
                });
                
                // ÂèÉÊï∏Êõ¥Êñ∞
                document.getElementById('aiModel').addEventListener('change', (e) => {
                    this.currentModel = e.target.value;
                });
                
                document.getElementById('creativity').addEventListener('change', (e) => {
                    this.creativity = parseFloat(e.target.value);
                });
                
                document.getElementById('animationStyle').addEventListener('change', (e) => {
                    this.animationStyle = e.target.value;
                });
                
                document.getElementById('apiKey').addEventListener('input', (e) => {
                    this.apiKey = e.target.value;
                });
            }
            
            async generateAnimation(storyText) {
                this.showLoading(true);
                this.clearError();
                
                try {
                    let analysisResult;
                    
                    switch(this.currentModel) {
                        case 'gpt-3.5':
                        case 'gpt-4':
                            analysisResult = await this.analyzeWithGPT(storyText);
                            break;
                        case 'gemini':
                            analysisResult = await this.analyzeWithGemini(storyText);
                            break;
                        case 'claude':
                            analysisResult = await this.analyzeWithClaude(storyText);
                            break;
                        case 'qwen2':
                            analysisResult = await this.analyzeWithLocal(storyText, 'qwen2:7b');
                            break;
                        case 'llama2':
                            analysisResult = await this.analyzeWithLocal(storyText, 'llama2');
                            break;
                        case 'local':
                            analysisResult = await this.analyzeWithLocal(storyText, 'qwen2:7b');
                            break;
                        default:
                            analysisResult = await this.generateDemoAnalysis(storyText);
                    }
                    
                    this.displayAnalysis(analysisResult);
                    this.loadAnimation(analysisResult);
                    this.showInsights(analysisResult.insights);
                    
                } catch (error) {
                    this.showError(`AIÂàÜÊûêÂ§±Êïó: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async analyzeWithGPT(storyText) {
                if (!this.apiKey) {
                    throw new Error('Ë´ãÊèê‰æõOpenAI API Key');
                }
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: this.currentModel === 'gpt-4' ? "gpt-4" : "gpt-3.5-turbo",
                        messages: [{
                            role: "system",
                            content: `‰Ω†ÊòØ‰∏ñÁïåÈ†ÇÁ¥öÁöÑÂãïÁï´Â∞éÊºîÂíåÊïÖ‰∫ãÂàÜÊûêÂ∏´„ÄÇË´ãÂ∞áËº∏ÂÖ•ÁöÑÁ•ûË©±ÊïÖ‰∫ãËΩâÊèõÁÇ∫Ë©≥Á¥∞ÁöÑÁÅ´Êü¥‰∫∫ÂãïÁï´ËÖ≥Êú¨„ÄÇ
                            
                            ËøîÂõûJSONÊ†ºÂºèÔºåÂøÖÈ†àÂåÖÂê´Ôºö
                            {
                                "title": "ÊïÖ‰∫ãÊ®ôÈ°å",
                                "style": "Ë¶ñË¶∫È¢®Ê†ºÊèèËø∞",
                                "characters": [
                                    {
                                        "name": "ËßíËâ≤ÂêçÁ®±",
                                        "type": "ËßíËâ≤È°ûÂûã",
                                        "personality": "ÊÄßÊ†ºÁâπÈªû",
                                        "color": "‰ª£Ë°®È°èËâ≤",
                                        "scale": 0.8-1.5,
                                        "special_features": "ÁâπÊÆäÁâπÂæµ"
                                    }
                                ],
                                "scenes": [
                                    {
                                        "id": 1,
                                        "description": "Â†¥ÊôØÊèèËø∞",
                                        "background": "ËÉåÊôØÈ°ûÂûã",
                                        "duration": 5000,
                                        "camera": "ÊîùÂΩ±Ê©üËßíÂ∫¶",
                                        "mood": "ÊÉÖÊÑüÊ∞õÂúç",
                                        "characters_actions": [
                                            {
                                                "character": "ËßíËâ≤ÂêçÁ®±",
                                                "action": "ÂÖ∑È´îÂãï‰Ωú",
                                                "intensity": 1.0,
                                                "start_time": 0,
                                                "duration": 2000,
                                                "emotion": "ÊÉÖÊÑüÁãÄÊÖã"
                                            }
                                        ],
                                        "props": ["ÈÅìÂÖ∑1", "ÈÅìÂÖ∑2"],
                                        "effects": ["ÁâπÊïà1", "ÁâπÊïà2"]
                                    }
                                ],
                                "insights": "Â∞éÊºîÂàÜÊûêÂíåÂª∫Ë≠∞",
                                "theme": "ÊïÖ‰∫ã‰∏ªÈ°å",
                                "emotional_arc": "ÊÉÖÊÑüÂºßÁ∑öÊèèËø∞"
                            }`
                        }, {
                            role: "user",
                            content: storyText
                        }],
                        temperature: this.creativity,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI APIÈåØË™§: ${response.status}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // Â¶ÇÊûú‰∏çÊòØÁ¥îJSONÔºåÂòóË©¶ÊèêÂèñJSONÈÉ®ÂàÜ
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error('ÁÑ°Ê≥ïËß£ÊûêAIËøîÂõûÁöÑÂÖßÂÆπ');
                }
            }
            
            async analyzeWithGemini(storyText) {
                if (!this.apiKey) {
                    throw new Error('Ë´ãÊèê‰æõGoogle Gemini API Key');
                }
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `‰ΩúÁÇ∫Â∞àÊ•≠ÂãïÁï´Â∞éÊºîÔºåË´ãÂàÜÊûê‰ª•‰∏ãÁ•ûË©±ÊïÖ‰∫ã‰∏¶ÁîüÊàêÁÅ´Êü¥‰∫∫ÂãïÁï´ËÖ≥Êú¨Ôºö\n\n${storyText}\n\nË´ãËøîÂõûË©≥Á¥∞ÁöÑJSONÊ†ºÂºèÂãïÁï´Êï∏ÊìöÔºåÂåÖÂê´ËßíËâ≤„ÄÅÂ†¥ÊôØ„ÄÅÂãï‰ΩúÂ∫èÂàó„ÄÅÊÉÖÊÑüÂàÜÊûêÁ≠â„ÄÇ`
                            }]
                        }],
                        generationConfig: {
                            temperature: this.creativity,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Gemini APIÈåØË™§: ${response.status}`);
                }
                
                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                
                // Ëß£ÊûêÂÖßÂÆπ‰∏¶ÊèêÂèñJSON
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                throw new Error('ÁÑ°Ê≥ïÂæûGeminiÈüøÊáâ‰∏≠ÊèêÂèñÊúâÊïàÊï∏Êìö');
            }
            
            async analyzeWithLocal(storyText, modelName = 'qwen2:7b') {
                // Ê†πÊìöÊ®°ÂûãË™øÊï¥promptË™ûË®Ä
                const isQwen = modelName.includes('qwen');
                
                const prompt = isQwen ? 
                    `‰ΩúÁÇ∫Â∞àÊ•≠ÂãïÁï´Â∞éÊºîÔºåË´ãÂàÜÊûê‰ª•‰∏ãÁ•ûË©±ÊïÖ‰∫ã‰∏¶ÁîüÊàêË©≥Á¥∞ÁöÑÁÅ´Êü¥‰∫∫ÂãïÁï´ËÖ≥Êú¨„ÄÇ

ÊïÖ‰∫ãÔºö${storyText}

Ë´ãÁî®JSONÊ†ºÂºèÂõûÂæ©ÔºåÂåÖÂê´Ôºö
{
    "title": "ÊïÖ‰∫ãÊ®ôÈ°å",
    "style": "ÂãïÁï´È¢®Ê†º",
    "characters": [{"name": "ËßíËâ≤ÂêçÁ®±", "type": "ËßíËâ≤È°ûÂûã", "color": "#È°èËâ≤", "scale": 1.0, "personality": "ÊÄßÊ†ºÁâπÂæµ", "special_features": "ÁâπÊÆäÁâπÂæµ"}],
    "scenes": [{"id": 1, "description": "Â†¥ÊôØÊèèËø∞", "background": "ËÉåÊôØÈ°ûÂûã", "duration": 5000, "mood": "ÊÉÖÊÑüÊ∞õÂúç", "characters_actions": [{"character": "ËßíËâ≤ÂêçÁ®±", "action": "Âãï‰ΩúÈ°ûÂûã", "intensity": 1.0, "emotion": "ÊÉÖÊÑüÁãÄÊÖã"}], "props": ["ÈÅìÂÖ∑1"], "effects": ["ÁâπÊïà1"]}],
    "insights": "Â∞éÊºîÂàÜÊûêÂíåÂª∫Ë≠∞",
    "theme": "ÊïÖ‰∫ã‰∏ªÈ°å",
    "emotional_arc": "ÊÉÖÊÑüÂºßÁ∑ö"
}` :
                    `As a professional animation director, analyze this mythology story and create a detailed animation script in JSON format.

Story: ${storyText}

Please respond with a JSON object containing:
{
    "title": "Story title",
    "style": "Animation style", 
    "characters": [{"name": "Character name", "type": "character type", "color": "#color", "scale": 1.0, "personality": "traits", "special_features": "special features"}],
    "scenes": [{"id": 1, "description": "Scene description", "background": "background type", "duration": 5000, "mood": "emotional tone", "characters_actions": [{"character": "name", "action": "action type", "intensity": 1.0, "emotion": "emotion"}], "props": ["prop1"], "effects": ["effect1"]}],
    "insights": "Director's analysis and recommendations",
    "theme": "Story theme",
    "emotional_arc": "Emotional progression"
}`;

                const response = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelName,
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: this.creativity,
                            top_p: 0.9,
                            num_predict: 2000
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Êú¨Âú∞LLMÈÄ£Êé•Â§±Êïó: ${response.status}„ÄÇË´ãÁ¢∫‰øù${modelName}Ê®°ÂûãÂ∑≤ÂÆâË£ù‰∏¶‰∏îOllamaÊ≠£Âú®ÈÅãË°å„ÄÇ`);
                }
                
                const data = await response.json();
                console.log(`${modelName} response:`, data.response);
                
                // ÂòóË©¶ÊèêÂèñJSON
                const jsonMatches = data.response.match(/\{[\s\S]*?\}/g);
                
                if (jsonMatches) {
                    // ÂòóË©¶Ëß£ÊûêÊØèÂÄãÂèØËÉΩÁöÑJSON
                    for (const jsonStr of jsonMatches) {
                        try {
                            const parsed = JSON.parse(jsonStr);
                            // È©óË≠âÂøÖÈúÄÁöÑÂ≠óÊÆµ
                            if (parsed.title && parsed.characters && parsed.scenes) {
                                return parsed;
                            }
                        } catch (e) {
                            console.warn('JSONËß£ÊûêÂ§±ÊïóÔºåÂòóË©¶‰∏ã‰∏ÄÂÄã');
                        }
                    }
                }
                
                // Â¶ÇÊûúÁÑ°Ê≥ïËß£ÊûêJSONÔºå‰ΩøÁî®Êô∫ËÉΩËß£Êûê
                console.warn('‰ΩøÁî®ÂÇôÁî®Ëß£ÊûêÊñπÊ°à');
                return this.parseLocalLLMResponse(data.response, storyText);
            }
            
            parseLocalLLMResponse(response, originalText) {
                // Áï∂Êú¨Âú∞LLMÁÑ°Ê≥ïËøîÂõûÊ®ôÊ∫ñJSONÊôÇÁöÑÂÇôÁî®Ëß£Êûê
                console.log('‰ΩøÁî®ÂÇôÁî®Ëß£ÊûêÊñπÊ°à');
                
                const characters = this.extractCharacters(originalText);
                const scenes = this.generateScenes(originalText, characters);
                
                return {
                    title: "Êú¨Âú∞AIËß£ÊûêÁöÑÁ•ûË©±ÊïÖ‰∫ã",
                    style: this.animationStyle,
                    characters: characters,
                    scenes: scenes,
                    insights: `Êú¨Âú∞Llama2ÂàÜÊûê: ${response.substring(0, 200)}...`,
                    theme: this.getStoryGenre(originalText),
                    emotional_arc: "ÈñãÂßã ‚Üí ÁôºÂ±ï ‚Üí È´òÊΩÆ ‚Üí ÁµêÂ±Ä"
                };
            }
            
            async generateDemoAnalysis(storyText) {
                // DemoÊ®°ÂºèÔºöÊô∫ËÉΩËß£ÊûêÊñáÊú¨ÁîüÊàêÁµêÊßãÂåñÊï∏Êìö
                await new Promise(resolve => setTimeout(resolve, 2000)); // Ê®°Êì¨APIÂª∂ÈÅ≤
                
                const characters = this.extractCharacters(storyText);
                const scenes = this.generateScenes(storyText, characters);
                
                return {
                    title: "Êô∫ËÉΩËß£ÊûêÁöÑÁ•ûË©±ÊïÖ‰∫ã",
                    style: this.animationStyle,
                    characters: characters,
                    scenes: scenes,
                    insights: `Ê†πÊìöÊñáÊú¨ÂàÜÊûêÔºåÈÄôÊòØ‰∏ÄÂÄã${this.getStoryGenre(storyText)}ÁöÑÊïÖ‰∫ã„ÄÇÊÉÖÊÑüÂº∑Â∫¶ËºÉ${this.getEmotionalIntensity(storyText)}ÔºåÈÅ©ÂêàÁî®${this.animationStyle}È¢®Ê†ºË°®Áèæ„ÄÇÂª∫Ë≠∞ÈáçÈªûÁ™ÅÂá∫${this.getKeyThemes(storyText)}ÁöÑ‰∏ªÈ°å„ÄÇ`,
                    theme: this.getStoryGenre(storyText),
                    emotional_arc: "ÈñãÂßãÂπ≥Èùú ‚Üí Ë°ùÁ™ÅÂçáÁ¥ö ‚Üí È´òÊΩÆ ‚Üí ÁµêÂ±Ä"
                };
            }
            
            extractCharacters(text) {
                // Êô∫ËÉΩËßíËâ≤ÊèêÂèñ
                const characterKeywords = {
                    'Â§∏Áà∂': { type: 'giant', color: '#ff6b6b', scale: 1.3, personality: 'Â†ÖÊØÖ‰∏çÂ±à' },
                    'Âì™Âêí': { type: 'divine_child', color: '#ffd700', scale: 0.8, personality: 'ÂãáÊï¢È†ëÁöÆ' },
                    'Êïñ‰∏ô': { type: 'dragon_prince', color: '#4169e1', scale: 1.1, personality: 'È´òÂÇ≤Â®ÅÂö¥' },
                    'Á¥†ÊàîÂóöÂ∞ä': { type: 'storm_god', color: '#8b00ff', scale: 1.2, personality: 'ÂãáÁåõÁÑ°Áïè' },
                    'ÂÖ´Â≤êÂ§ßËõá': { type: 'serpent', color: '#228b22', scale: 2.0, personality: 'Âá∂ÊÉ°ÊÅêÊÄñ' },
                    'Â´¶Â®•': { type: 'moon_goddess', color: '#c0c0c0', scale: 0.9, personality: 'ÂÑ™ÈõÖÁ•ûÁßò' }
                };
                
                const foundCharacters = [];
                for (const [name, data] of Object.entries(characterKeywords)) {
                    if (text.includes(name)) {
                        foundCharacters.push({
                            name,
                            ...data,
                            special_features: this.getSpecialFeatures(name)
                        });
                    }
                }
                
                // Â¶ÇÊûúÊ≤íÊúâË≠òÂà•Âà∞ËßíËâ≤ÔºåÂâµÂª∫ÈÄöÁî®ËßíËâ≤
                if (foundCharacters.length === 0) {
                    foundCharacters.push({
                        name: '‰∏ªËßí',
                        type: 'hero',
                        color: '#ff6b6b',
                        scale: 1.0,
                        personality: 'Ëã±Âãá',
                        special_features: 'ÁôºÂÖâÁöÑÁúºÁùõ'
                    });
                }
                
                return foundCharacters;
            }
            
            generateScenes(text, characters) {
                // Êô∫ËÉΩÂ†¥ÊôØÂàÜÂâ≤
                const sentences = text.split(/[„ÄÇÔºé.!ÔºÅ?Ôºü\n]/).filter(s => s.trim().length > 5);
                const scenes = [];
                
                sentences.forEach((sentence, index) => {
                    const actions = this.extractActions(sentence);
                    const background = this.detectBackground(sentence);
                    
                    scenes.push({
                        id: index + 1,
                        description: sentence,
                        background: background,
                        duration: Math.max(3000, sentence.length * 100),
                        camera: index === 0 ? 'wide' : (index === sentences.length - 1 ? 'close' : 'medium'),
                        mood: this.detectMood(sentence),
                        characters_actions: this.generateCharacterActions(sentence, characters, actions),
                        props: this.extractProps(sentence),
                        effects: this.suggestEffects(sentence)
                    });
                });
                
                return scenes;
            }
            
            extractActions(text) {
                const actionKeywords = {
                    'Ë∑ë': 'run', 'ËøΩ': 'chase', 'È£õ': 'fly', 'Êà∞': 'fight', 
                    'ÂÄí': 'fall', 'Á´ô': 'stand', 'Âùê': 'sit', 'Ë∑≥': 'jump',
                    'ÊîªÊìä': 'attack', 'Èò≤Á¶¶': 'defend', 'ÈÄÉË∑ë': 'flee'
                };
                
                const actions = [];
                for (const [keyword, action] of Object.entries(actionKeywords)) {
                    if (text.includes(keyword)) {
                        actions.push(action);
                    }
                }
                
                return actions.length > 0 ? actions : ['idle'];
            }
            
            detectBackground(text) {
                const backgrounds = {
                    'Â±±': 'mountain', 'Êµ∑': 'ocean', 'Â§©': 'sky', 'Ê£ÆÊûó': 'forest',
                    'ÂÆÆÊÆø': 'palace', 'Ê≤ôÊº†': 'desert', 'Êúà': 'moon', 'Èõ≤': 'clouds'
                };
                
                for (const [keyword, bg] of Object.entries(backgrounds)) {
                    if (text.includes(keyword)) {
                        return bg;
                    }
                }
                
                return 'default';
            }
            
            detectMood(text) {
                if (text.includes('ÊÄí') || text.includes('ÊÜ§')) return 'angry';
                if (text.includes('ÊÇ≤') || text.includes('ÂÇ∑')) return 'sad';
                if (text.includes('Âñú') || text.includes('Ê®Ç')) return 'happy';
                if (text.includes('ÊÅê') || text.includes('ÊÄñ')) return 'fearful';
                if (text.includes('Êà∞') || text.includes('È¨•')) return 'intense';
                return 'neutral';
            }
            
            generateCharacterActions(sentence, characters, actions) {
                return characters.map((char, index) => ({
                    character: char.name,
                    action: actions[index % actions.length],
                    intensity: this.calculateIntensity(sentence),
                    start_time: 0,
                    duration: 2000,
                    emotion: this.detectMood(sentence)
                }));
            }
            
            calculateIntensity(text) {
                let intensity = 0.5;
                if (text.includes('ÊøÄÁÉà') || text.includes('ÁåõÁÉà')) intensity += 0.4;
                if (text.includes('Ëºï') || text.includes('ÊÖ¢')) intensity -= 0.3;
                if (text.includes('Âø´') || text.includes('ÊÄ•')) intensity += 0.3;
                return Math.max(0.1, Math.min(1.5, intensity));
            }
            
            extractProps(text) {
                const props = [];
                if (text.includes('Â§™ÈôΩ')) props.push('sun');
                if (text.includes('Êúà')) props.push('moon');
                if (text.includes('Âäç')) props.push('sword');
                if (text.includes('Âºì')) props.push('bow');
                if (text.includes('Ê∑∑Â§©Á∂æ')) props.push('magic_cloth');
                return props;
            }
            
            suggestEffects(text) {
                const effects = [];
                if (text.includes('ÁÅ´') || text.includes('ÁáÉÁáí')) effects.push('fire');
                if (text.includes('Ê∞¥') || text.includes('Ê≥¢Êµ™')) effects.push('water');
                if (text.includes('Èõ∑') || text.includes('Èõª')) effects.push('lightning');
                if (text.includes('È¢®') || text.includes('È¢±È¢®')) effects.push('wind');
                return effects;
            }
            
            getSpecialFeatures(characterName) {
                const features = {
                    'Â§∏Áà∂': 'ÁôºÂÖâÁöÑÂ∑®Â§ßË∫´ËªÄ',
                    'Âì™Âêí': 'ËìÆËä±Ë£ùÈ£æÂíå‰∏âÈ†≠ÂÖ≠ËáÇ',
                    'Êïñ‰∏ô': 'ÈæçÈ±óÂíåÈæçËßí',
                    'Á¥†ÊàîÂóöÂ∞ä': 'Èõ∑ÈõªÁí∞Áπû',
                    'Â´¶Â®•': 'ÊúàÂÖâÂÖâËºù'
                };
                return features[characterName] || 'ÁâπÊÆäÂÖâÊïà';
            }
            
            getStoryGenre(text) {
                if (text.includes('Êà∞') || text.includes('È¨•')) return 'Ëã±ÈõÑÂÜíÈö™';
                if (text.includes('ÊÑõ') || text.includes('ÊÉÖ')) return 'Êµ™Êº´ÊÑõÊÉÖ';
                if (text.includes('ÁäßÁâ≤') || text.includes('Ê≠ª')) return 'ÊÇ≤ÂäáÂè≤Ë©©';
                return 'Á•ûË©±ÂÇ≥Ë™™';
            }
            
            getEmotionalIntensity(text) {
                const intensityWords = ['ÊøÄÁÉà', 'ÁåõÁÉà', 'ÁãÇÊö¥', 'Ê∫´Âíå', 'Âπ≥Èùú', 'ËºïÊüî'];
                let intensity = '‰∏≠Á≠â';
                
                if (text.includes('ÊøÄÁÉà') || text.includes('ÁåõÁÉà')) intensity = 'È´ò';
                if (text.includes('Âπ≥Èùú') || text.includes('Ê∫´Âíå')) intensity = '‰Ωé';
                
                return intensity;
            }
            
            getKeyThemes(text) {
                const themes = [];
                if (text.includes('ËøΩ') || text.includes('Â§¢ÊÉ≥')) themes.push('ËøΩÊ±ÇÁêÜÊÉ≥');
                if (text.includes('ÁäßÁâ≤')) themes.push('Ëã±ÂãáÁäßÁâ≤');
                if (text.includes('ÊÑõ')) themes.push('ÊÑõËàáÂ•âÁçª');
                if (text.includes('Ê≠£Áæ©')) themes.push('Ê≠£Áæ©Êà∞ÂãùÈÇ™ÊÉ°');
                return themes.length > 0 ? themes.join('„ÄÅ') : 'ÂãáÊ∞£ËàáÊàêÈï∑';
            }
            
            displayAnalysis(analysis) {
                const container = document.getElementById('aiAnalysis');
                
                if (!analysis) {
                    container.innerHTML = '<div style="color: #ff6b6b;">ÂàÜÊûêÊï∏ÊìöÁÑ°Êïà</div>';
                    return;
                }
                
                // Á¢∫‰øùÊâÄÊúâÂøÖÈúÄÁöÑÂ±¨ÊÄßÂ≠òÂú®
                const title = analysis.title || 'Êú™Áü•Ê®ôÈ°å';
                const theme = analysis.theme || 'Êú™Áü•‰∏ªÈ°å';
                const style = analysis.style || 'È†êË®≠È¢®Ê†º';
                const characters = analysis.characters || [];
                const scenes = analysis.scenes || [];
                const emotional_arc = analysis.emotional_arc || 'Êú™ÂÆöÁæ©';
                
                container.innerHTML = `
                    <div class="analysis-section">
                        <div class="analysis-title">üìñ ÊïÖ‰∫ãÊ¶ÇËø∞</div>
                        <div class="analysis-content">
                            <strong>Ê®ôÈ°å:</strong> ${title}<br>
                            <strong>‰∏ªÈ°å:</strong> ${theme}<br>
                            <strong>È¢®Ê†º:</strong> ${style}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <div class="analysis-title">üë• ËßíËâ≤ÂàÜÊûê</div>
                        <div class="analysis-content">
                            ${characters.length > 0 ? characters.map(char => 
                                `<div style="margin-bottom: 8px;">
                                    <strong>${char.name || 'Êú™Áü•ËßíËâ≤'}</strong> (${char.type || 'Êú™Áü•È°ûÂûã'})<br>
                                    <small>ÊÄßÊ†º: ${char.personality || 'Êú™Áü•'} | ÁâπÂæµ: ${char.special_features || 'ÁÑ°ÁâπÊÆäÁâπÂæµ'}</small>
                                </div>`
                            ).join('') : 'Êö´ÁÑ°ËßíËâ≤‰ø°ÊÅØ'}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <div class="analysis-title">üé¨ Â†¥ÊôØË¶èÂäÉ</div>
                        <div class="analysis-content">
                            ÂÖ± ${scenes.length} ÂÄãÂ†¥ÊôØ<br>
                            Á∏ΩÊôÇÈï∑: ${scenes.length > 0 ? Math.round(scenes.reduce((sum, scene) => sum + (scene.duration || 3000), 0) / 1000) : 0} Áßí<br>
                            ÊÉÖÊÑüÂºßÁ∑ö: ${emotional_arc}
                        </div>
                    </div>
                `;
            }
            
            loadAnimation(data) {
                this.animationData = data;
                this.currentScene = 0;
                this.renderCurrentScene();
            }
            
            renderCurrentScene() {
                if (!this.animationData) return;
                
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Á∞°ÂåñÁöÑÊ∏≤ÊüìÁ≥ªÁµ±
                const scene = this.animationData.scenes[this.currentScene];
                if (!scene) return;
                
                // Áπ™Ë£ΩËÉåÊôØ
                this.drawBackground(scene.background);
                
                // Áπ™Ë£ΩËßíËâ≤
                scene.characters_actions.forEach((action, index) => {
                    this.drawCharacter(action, index);
                });
                
                // Áπ™Ë£ΩÈÅìÂÖ∑ÂíåÁâπÊïà
                scene.props.forEach(prop => this.drawProp(prop));
                scene.effects.forEach(effect => this.drawEffect(effect));
            }
            
            drawBackground(backgroundType) {
                let gradient;
                
                switch(backgroundType) {
                    case 'mountain':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#87CEEB');
                        gradient.addColorStop(1, '#228B22');
                        break;
                    case 'ocean':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#87CEEB');
                        gradient.addColorStop(1, '#4682B4');
                        break;
                    case 'sky':
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#FFD700');
                        gradient.addColorStop(1, '#87CEEB');
                        break;
                    default:
                        gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, '#98FB98');
                        gradient.addColorStop(1, '#90EE90');
                }
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            drawCharacter(actionData, index) {
                const x = (this.canvas.width / (this.animationData.characters.length + 1)) * (index + 1);
                const y = this.canvas.height * 0.6;
                const character = this.animationData.characters.find(c => c.name === actionData.character);
                
                if (!character) return;
                
                this.ctx.save();
                this.ctx.translate(x, y);
                this.ctx.scale(character.scale, character.scale);
                
                // Ê†πÊìöÂãï‰ΩúË™øÊï¥ÂßøÊÖã
                let rotation = 0;
                if (actionData.action === 'run') rotation = Math.sin(Date.now() * 0.01) * 0.1;
                if (actionData.action === 'fall') rotation = Math.PI / 4;
                
                this.ctx.rotate(rotation);
                
                this.ctx.strokeStyle = character.color;
                this.ctx.lineWidth = 4;
                this.ctx.lineCap = 'round';
                
                // Á∞°ÂåñÁöÑÁÅ´Êü¥‰∫∫Áπ™Ë£Ω
                // È†≠ÈÉ®
                this.ctx.beginPath();
                this.ctx.arc(0, -60, 18, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // Ë∫´È´î
                this.ctx.beginPath();
                this.ctx.moveTo(0, -42);
                this.ctx.lineTo(0, 20);
                this.ctx.stroke();
                
                // Ê†πÊìöÂãï‰ΩúÁπ™Ë£ΩÂõõËÇ¢
                this.drawLimbs(actionData.action, actionData.intensity);
                
                // Áπ™Ë£ΩÁâπÊÆäÁâπÂæµ
                this.drawSpecialFeatures(character);
                
                this.ctx.restore();
            }
            
            drawLimbs(action, intensity) {
                const time = Date.now() * 0.01;
                let armAngle = 0;
                let legAngle = 0;
                
                switch(action) {
                    case 'run':
                        armAngle = Math.sin(time) * 0.8 * intensity;
                        legAngle = Math.sin(time) * 0.6 * intensity;
                        break;
                    case 'fight':
                        armAngle = -Math.PI/3 + Math.sin(time * 2) * 0.5;
                        legAngle = 0.2;
                        break;
                    case 'fall':
                        armAngle = 1.2;
                        legAngle = 0.5;
                        break;
                    default:
                        armAngle = 0.2;
                        legAngle = 0;
                }
                
                // Â∑¶ËáÇ
                this.ctx.beginPath();
                this.ctx.moveTo(0, -20);
                this.ctx.lineTo(-25 * Math.cos(armAngle), -20 + 25 * Math.sin(armAngle));
                this.ctx.stroke();
                
                // Âè≥ËáÇ
                this.ctx.beginPath();
                this.ctx.moveTo(0, -20);
                this.ctx.lineTo(25 * Math.cos(-armAngle), -20 + 25 * Math.sin(-armAngle));
                this.ctx.stroke();
                
                // Â∑¶ËÖø
                this.ctx.beginPath();
                this.ctx.moveTo(0, 20);
                this.ctx.lineTo(-20 * Math.cos(legAngle), 20 + 30 * Math.sin(legAngle) + 30);
                this.ctx.stroke();
                
                // Âè≥ËÖø
                this.ctx.beginPath();
                this.ctx.moveTo(0, 20);
                this.ctx.lineTo(20 * Math.cos(-legAngle), 20 + 30 * Math.sin(-legAngle) + 30);
                this.ctx.stroke();
            }
            
            drawSpecialFeatures(character) {
                // Ê†πÊìöËßíËâ≤È°ûÂûãÁπ™Ë£ΩÁâπÊÆäÁâπÂæµ
                if (character.name === 'Âì™Âêí') {
                    // ËìÆËä±Ë£ùÈ£æ
                    this.ctx.strokeStyle = '#ff69b4';
                    this.ctx.lineWidth = 2;
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI * 2 / 6) * i;
                        this.ctx.beginPath();
                        this.ctx.moveTo(0, -60);
                        this.ctx.lineTo(Math.cos(angle) * 25, -60 + Math.sin(angle) * 25);
                        this.ctx.stroke();
                    }
                }
            }
            
            drawProp(prop) {
                switch(prop) {
                    case 'sun':
                        this.ctx.fillStyle = '#FFD700';
                        this.ctx.beginPath();
                        this.ctx.arc(this.canvas.width - 100, 80, 30, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                    case 'moon':
                        this.ctx.fillStyle = '#C0C0C0';
                        this.ctx.beginPath();
                        this.ctx.arc(100, 80, 25, 0, Math.PI * 2);
                        this.ctx.fill();
                        break;
                }
            }
            
            drawEffect(effect) {
                // Á∞°ÂåñÁöÑÁâπÊïàÁπ™Ë£Ω
                if (effect === 'fire') {
                    this.ctx.fillStyle = `rgba(255, ${100 + Math.sin(Date.now() * 0.01) * 50}, 0, 0.7)`;
                    for (let i = 0; i < 5; i++) {
                        this.ctx.beginPath();
                        this.ctx.arc(
                            this.canvas.width * 0.5 + Math.random() * 100 - 50,
                            this.canvas.height * 0.8 + Math.random() * 50,
                            Math.random() * 10 + 5,
                            0, Math.PI * 2
                        );
                        this.ctx.fill();
                    }
                }
            }
            
            showInsights(insights) {
                document.getElementById('insightsContent').textContent = insights;
            }
            
            showLoading(show) {
                const loading = document.getElementById('loading');
                const btn = document.getElementById('generateBtn');
                
                if (show) {
                    loading.classList.add('show');
                    btn.disabled = true;
                    btn.innerHTML = '<span>ü§ñ AIÂàÜÊûê‰∏≠...</span>';
                } else {
                    loading.classList.remove('show');
                    btn.disabled = false;
                    btn.innerHTML = '<span>üöÄ AIÁîüÊàêÂãïÁï´</span>';
                }
            }
            
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            
            clearError() {
                document.getElementById('errorMessage').style.display = 'none';
            }
            
            play() {
                this.isPlaying = true;
                document.getElementById('playBtn').innerHTML = '‚è∏ Êö´ÂÅú';
                document.getElementById('playBtn').classList.add('active');
                this.animate();
            }
            
            pause() {
                this.isPlaying = false;
                document.getElementById('playBtn').innerHTML = '‚ñ∂ Êí≠Êîæ';
                document.getElementById('playBtn').classList.remove('active');
            }
            
            animate() {
                if (!this.isPlaying || !this.animationData) return;
                
                this.renderCurrentScene();
                
                // Á∞°ÂñÆÁöÑÂ†¥ÊôØÂàáÊèõÈÇèËºØ
                if (Math.random() < 0.01) {
                    this.currentScene = (this.currentScene + 1) % this.animationData.scenes.length;
                }
                
                requestAnimationFrame(() => this.animate());
            }
        }
        
        // ==================== ÂÖ®Â±ÄÂáΩÊï∏ ====================
        
        let aiEngine;
        
        function initializeSystem() {
            aiEngine = new AIAnimationEngine();
            
            // ËºâÂÖ•Á§∫‰æã
            setTimeout(() => {
                loadExample(document.querySelector('.example-prompt'));
            }, 1000);
        }
        
        function loadExample(element) {
            const examples = {
                'Â§∏Áà∂ËøΩÊó•': `Â§∏Áà∂Ê±∫ÂøÉËøΩ‰∏äÂ§™ÈôΩÔºå‰ªñÈÇÅÈñãÂ∑®Â§ßÁöÑÊ≠•‰ºêÈñãÂßãÂ•îË∑ë„ÄÇË∑®Ë∂äÈ´òÂ±±ÔºåÁ©øÈÅéÊ£ÆÊûóÔºåË∂äÈÅéÂ§ßÊ≤≥Ôºå‰ΩÜÂ§™ÈôΩÂßãÁµÇÂú®ÂâçÊñπ„ÄÇÊ∏¥ÊúõËÆì‰ªñÂÅú‰∏ã‰æÜÂñùÂÖâ‰∫ÜÈªÉÊ≤≥ÂíåÊ∏≠Ê∞¥Ôºå‰ΩÜ‰ªçÁÑ∂‰∏çÂ§†„ÄÇ‰ªñÁπºÁ∫åÂêëÂåóÊñπÁöÑÂ§ßÊæ§Â•îÂéªÔºå‰ΩÜÁµÇÊñºÈ´îÂäõ‰∏çÊîØÂÄí‰∏ã„ÄÇÂ§∏Áà∂Ê≠ªÂæåÔºå‰ªñÁöÑÊâãÊùñÂåñ‰Ωú‰∫Ü‰∏ÄÁâáËåÇÂØÜÁöÑÊ°ÉÊûóÔºåÁÇ∫Âæå‰æÜÁöÑÊóÖ‰∫∫Êèê‰æõÈô∞Ê∂ºÂíåÁîòÁîúÁöÑÊûúÂØ¶„ÄÇ`,
                
                'Á¥†ÊàîÂóöÂ∞ä': `Á¥†ÊàîÂóöÂ∞äËÅΩË™™ÂÖ´Â≤êÂ§ßËõáÊ≠£Âú®Â®ÅËÑÖ‰∫∫ÈñìÔºå‰ªñÊØÖÁÑ∂Ê±∫ÂÆöÂâçÂæÄË®é‰ºê„ÄÇ‰æÜÂà∞Â§ßËõáÁöÑÂ∑¢Á©¥ÔºåÂè™Ë¶ãÂÖ´ÂÄãÂ¶ÇÂ±±Ëà¨Â∑®Â§ßÁöÑÈ†≠È°±ÔºåÂÖ´Ê¢ùÈï∑Â∞æÊ©´ÊéÉÂ§©Âú∞„ÄÇÁ¥†ÊàîÂóöÂ∞äÊØ´‰∏çÁïèÊáºÔºåÂÖàÁî®ÁæéÈÖíËÆìÂ§ßËõáÈÜâÂÄíÔºåÁÑ∂ÂæåÊäΩÂá∫Á•ûÂäçËçâËñôÂäçÔºåËàáÊÄ™Áâ©Â±ïÈñãÊøÄÁÉàÁöÑÊà∞È¨•„ÄÇÁ∂ìÈÅé‰∏ÄÁï™ÊÉ°Êà∞Ôºå‰ªñÁµÇÊñºÊñ¨ÊÆ∫‰∫ÜÂÖ´Â≤êÂ§ßËõáÔºå‰∏¶Âú®ËõáÂ∞æ‰∏≠ÁôºÁèæ‰∫ÜÁèçË≤¥ÁöÑËçâËñôÂäçÔºåÂæå‰æÜÂ∞áÂÖ∂ÁçªÁµ¶‰∫ÜÂßêÂßêÂ§©ÁÖßÂ§ßÁ•û„ÄÇ`,
                
                'Â´¶Â®•Â•îÊúà': `ÂêéÁæøÂ∞Ñ‰∏ã‰πùÂÄãÂ§™ÈôΩÂæåÔºåË•øÁéãÊØçË≥úÁµ¶‰ªñ‰∏çÊ≠ªËó•‰ΩúÁÇ∫ÁçéË≥û„ÄÇÂêéÁæøÂ∞áËó•‰∫§Áµ¶Â¶ªÂ≠êÂ´¶Â®•‰øùÁÆ°„ÄÇÊüêÊó•ÔºåÂêéÁæøÂ§ñÂá∫Áã©ÁçµÔºåÂ´¶Â®•Áç®Ëá™Âú®ÂÆ∂ÔºåÂ•ΩÂ•áÂøÉÈ©Ö‰ΩøÂ•πÊâìÈñã‰∫ÜËó•Áì∂„ÄÇËó•È¶ôÊí≤ÈºªÔºåÂ•πÂøç‰∏ç‰ΩèÂìÅÂöê‰∫Ü‰∏ÄÂè£ÔºåÈö®Âç≥ÊÑüÂà∞Ë∫´È´îËºïÈ£ÑÈ£ÑÁöÑÔºå‰∏çÁî±Ëá™‰∏ªÂú∞È£õÂêëÂ§©Á©∫„ÄÇÂ•πË∂äÈ£õË∂äÈ´òÔºåÊúÄÁµÇËêΩÂú®‰∫ÜÊúàÂÆÆ‰∏≠ÔºåÂæûÊ≠§ËàáÂêéÁæøÂ§©ÂêÑ‰∏ÄÊñπÔºåÂè™ËÉΩÂú®ÊØèÂÄãÊúàÂúì‰πãÂ§úÈÅôÈÅôÁõ∏Êúõ„ÄÇ`
            };
            
            const text = element.textContent;
            for (const [key, value] of Object.entries(examples)) {
                if (text.includes(key)) {
                    document.getElementById('storyInput').value = value;
                    break;
                }
            }
        }
        
        async function generateWithAI() {
            const storyText = document.getElementById('storyInput').value.trim();
            if (!storyText) {
                alert('Ë´ãËº∏ÂÖ•ÊïÖ‰∫ãÊñáÊú¨');
                return;
            }
            
            await aiEngine.generateAnimation(storyText);
        }
        
        function togglePlay() {
            if (aiEngine.isPlaying) {
                aiEngine.pause();
            } else {
                aiEngine.play();
            }
        }
        
        function restartAnimation() {
            aiEngine.currentScene = 0;
            aiEngine.pause();
            aiEngine.renderCurrentScene();
        }
        
        function exportAnimation() {
            alert('Â∞éÂá∫ÂäüËÉΩÈñãÁôº‰∏≠...');
        }
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>