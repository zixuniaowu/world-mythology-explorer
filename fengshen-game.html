<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>封神演義ミステリー - 火柴人探偵ゲーム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f5f3e9;
            color: #2c1810;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ゲームコンテナ */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* ヘッダー */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
        }

        .game-title {
            font-size: 2.5em;
            color: #8b4513;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .game-subtitle {
            font-size: 1.2em;
            color: #666;
        }

        /* メインゲームエリア */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* 火柴人キャンバスエリア */
        .stick-figure-area {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        #gameCanvas {
            width: 100%;
            height: 400px;
            border: 1px dashed #ccc;
            cursor: pointer;
        }

        /* テキストとパズルエリア */
        .content-area {
            background: white;
            border: 3px solid #8b4513;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
        }

        /* 章タイトル */
        .chapter-title {
            font-size: 1.8em;
            color: #8b4513;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b4513;
        }

        /* テキスト表示エリア */
        .text-display {
            background: #fefefe;
            padding: 15px;
            border-left: 4px solid #d4a574;
            margin-bottom: 20px;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .text-display p {
            margin-bottom: 10px;
        }

        /* パズルエリア */
        .puzzle-area {
            background: #f9f7f3;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .puzzle-question {
            font-size: 1.3em;
            color: #8b4513;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .puzzle-options {
            display: grid;
            gap: 10px;
        }

        .option-button {
            background: white;
            border: 2px solid #d4a574;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            text-align: left;
        }

        .option-button:hover {
            background: #fff8dc;
            border-color: #8b4513;
            transform: translateX(5px);
        }

        .option-button.correct {
            background: #90ee90;
            border-color: #228b22;
        }

        .option-button.wrong {
            background: #ffcccb;
            border-color: #dc143c;
        }

        /* ボトムコントロール */
        .bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #8b4513;
        }

        /* スコア表示 */
        .score-display {
            font-size: 1.3em;
            color: #8b4513;
            font-weight: bold;
        }

        /* プログレスバー */
        .progress-container {
            flex: 1;
            margin: 0 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b4513, #d4a574);
            transition: width 0.5s ease;
            width: 0%;
        }

        /* ホームボタン */
        .home-button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .home-button:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }

        /* スタート画面 */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .start-content {
            background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%);
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 600px;
        }

        .start-title {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .start-description {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .start-button {
            background: #FFD700;
            color: #8b4513;
            border: none;
            padding: 20px 40px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(255,215,0,0.5);
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }

        .modal-title {
            font-size: 2em;
            color: #8b4513;
            margin-bottom: 20px;
        }

        .modal-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            color: #666;
        }

        .modal-button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }

        /* 探偵ノート */
        .detective-note {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .note-title {
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .clue-item {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        /* ヒントシステム */
        .hint-button {
            background: #ffd700;
            color: #8b4513;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .hint-button:hover {
            background: #ffed4e;
            transform: translateY(-1px);
        }

        .hint-text {
            margin-top: 10px;
            padding: 10px;
            background: #fffacd;
            border-radius: 5px;
            font-size: 0.9em;
            color: #8b4513;
            display: none;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .stick-figure-area {
                min-height: 300px;
            }
            
            #gameCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- スタート画面 -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <h1 class="start-title">封神演義の謎</h1>
            <p class="start-description">
                火柴人探偵となって、封神演義の世界を探索しよう！<br>
                神々と妖怪の戦い、英雄たちの冒険を解き明かせ！
            </p>
            <button class="start-button" onclick="startGame()">ゲームスタート</button>
        </div>
    </div>

    <!-- ゲームコンテナ -->
    <div class="game-container">
        <!-- ヘッダー -->
        <div class="game-header">
            <h1 class="game-title">封神演義ミステリー</h1>
            <p class="game-subtitle">火柴人探偵の神話調査</p>
        </div>

        <!-- メインゲームエリア -->
        <div class="game-area">
            <!-- 火柴人キャンバス -->
            <div class="stick-figure-area">
                <canvas id="gameCanvas"></canvas>
            </div>

            <!-- コンテンツエリア -->
            <div class="content-area" id="contentArea">
                <h2 class="chapter-title" id="chapterTitle">第一章：紂王と女媧</h2>
                <div class="text-display" id="textDisplay">
                    <p>ゲームを開始してください...</p>
                </div>
                <div class="puzzle-area" id="puzzleArea" style="display: none;">
                    <div class="puzzle-question" id="puzzleQuestion"></div>
                    <div class="puzzle-options" id="puzzleOptions"></div>
                    <button class="hint-button" onclick="showHint()">ヒント (-10点)</button>
                    <div class="hint-text" id="hintText"></div>
                </div>
            </div>
        </div>

        <!-- ボトムコントロール -->
        <div class="bottom-controls">
            <div class="score-display">スコア: <span id="scoreValue">0</span></div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <a href="chinese-mythology-index.html" class="home-button">ホーム</a>
        </div>
    </div>

    <!-- 探偵ノート -->
    <div class="detective-note">
        <div class="note-title">🔍 探偵ノート</div>
        <div id="cluesList"></div>
    </div>

    <!-- モーダル -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">章クリア！</h2>
            <p class="modal-message" id="modalMessage">おめでとうございます！</p>
            <button class="modal-button" onclick="closeModal()">続ける</button>
        </div>
    </div>

    <script>
        // ゲーム状態
        const gameState = {
            currentChapter: 0,
            currentPuzzle: 0,
            totalPuzzles: 3,
            completedPuzzles: 0,
            score: 0,
            clues: [],
            solvedPuzzles: [],
            animations: {},
            chapters: []
        };

        // 封神演義の章データ
        const fengshenChapters = [
            {
                id: 1,
                title: "第一回：紂王題詩",
                content: `
                    <p>殷朝の第三十代皇帝・紂王は、文武両道に優れ、力は千斤を挙げることができる英傑であった。</p>
                    <p>ある年の三月十五日、女媧聖母の誕生日に、紂王は群臣を従えて女媧宮に参拝した。</p>
                    <p>紂王が宮殿に入ると、女媧の神像の美しさに心を奪われた。紂王は筆を取り、宮殿の壁に不敬な詩を題した。</p>
                    <p>この不敬な詩が、殷朝六百年の基業を滅ぼす原因となることを、紂王はまだ知らなかった...</p>
                `,
                puzzles: [
                    {
                        type: 'character_identification',
                        question: '紂王はどのような人物として描かれていますか？',
                        options: [
                            '文武両道に優れ、千斤の力を持つ英傑',
                            '弱く臆病な暴君',
                            '詩と音楽だけを愛する文人',
                            '女媧を深く信仰する聖人君子'
                        ],
                        correct: 0,
                        hint: '紂王の能力について最初の段落を読み返してみましょう。'
                    },
                    {
                        type: 'event_sequence',
                        question: '紂王が女媧宮で行った行動は？',
                        options: [
                            '女媧像を破壊した',
                            '壁に不敬な詩を書いた',
                            '女媧に祈りを捧げた',
                            '宮殿を燃やした'
                        ],
                        correct: 1,
                        hint: '紂王が筆を取って何をしたか注目してください。'
                    },
                    {
                        type: 'consequence_prediction',
                        question: 'この出来事は何をもたらすことになりますか？',
                        options: [
                            '殷朝の繁栄',
                            '紂王の改心',
                            '殷朝六百年の基業の滅亡',
                            '女媧の祝福'
                        ],
                        correct: 2,
                        hint: '最後の段落に重要な予言があります。'
                    }
                ]
            },
            {
                id: 2,
                title: "第二回：妲己入宮",
                content: `
                    <p>女媧聖母は紂王の不敬な詩を知り、激怒した。彼女は軒轅墳の千年狐狸精、九頭雉鶏精、玉石琵琶精の三妖を召喚した。</p>
                    <p>「紂王は無道にして、生霊を塗炭の苦しみに陥れている。汝ら三妖は人間界に下り、紂王を惑わして殷朝を滅ぼすがよい。」</p>
                    <p>千年狐狸精は冀州侯蘇護の娘・妲己に化身し、その美貌で紂王を魅了した。</p>
                    <p>妲己の進言により、紂王は炮烙の刑、蠆盆の刑などの残酷な刑罰を作り、忠臣を次々と処刑した。</p>
                `,
                puzzles: [
                    {
                        type: 'creature_identification',
                        question: '女媧が召喚した三妖の筆頭は？',
                        options: [
                            '九尾の狐',
                            '千年狐狸精',
                            '白骨精',
                            '牛魔王'
                        ],
                        correct: 1,
                        hint: '軒轅墳から来た妖怪に注目してください。'
                    },
                    {
                        type: 'transformation_puzzle',
                        question: '千年狐狸精は誰に化身しましたか？',
                        options: [
                            '女媧聖母',
                            '王妃',
                            '蘇護の娘・妲己',
                            '宮女'
                        ],
                        correct: 2,
                        hint: '冀州侯の娘の名前を探してください。'
                    },
                    {
                        type: 'consequence_analysis',
                        question: '妲己の影響で紂王が作った刑罰は？',
                        options: [
                            '炮烙の刑と蠆盆の刑',
                            '斬首刑のみ',
                            '追放刑',
                            '罰金刑'
                        ],
                        correct: 0,
                        hint: '残酷な刑罰の名前が二つ挙げられています。'
                    }
                ]
            },
            {
                id: 3,
                title: "第三回：姜子牙下山",
                content: `
                    <p>崑崙山の玉虚宮で、元始天尊の弟子・姜子牙は四十年の修行を終えた。</p>
                    <p>元始天尊は姜子牙を呼び、「汝は仙骨なく、人間界で功を立てるべし。周の文王を助け、殷を滅ぼし、封神の大業を成就せよ」と命じた。</p>
                    <p>姜子牙は師の命を受け、打神鞭と杏黄旗を賜り、山を下りた。</p>
                    <p>渭水のほとりで釣りをしながら、文王との出会いを待つ姜子牙。その釣り針は真っ直ぐで、餌もつけていなかった。</p>
                `,
                puzzles: [
                    {
                        type: 'character_mission',
                        question: '姜子牙が元始天尊から受けた使命は？',
                        options: [
                            '仙人になること',
                            '崑崙山を守ること',
                            '周の文王を助けて封神の大業を成就すること',
                            '紂王を改心させること'
                        ],
                        correct: 2,
                        hint: '元始天尊の命令に注目してください。'
                    },
                    {
                        type: 'artifact_identification',
                        question: '姜子牙が授かった宝物は？',
                        options: [
                            '打神鞭と杏黄旗',
                            '太極図と盤古斧',
                            '如意棒と緊箍咒',
                            '芭蕉扇と玉浄瓶'
                        ],
                        correct: 0,
                        hint: '師から賜った二つの宝物の名前を探しましょう。'
                    },
                    {
                        type: 'symbolic_action',
                        question: '姜子牙の釣りの特徴は？',
                        options: [
                            '金の釣り針を使っていた',
                            '釣り針が真っ直ぐで餌もない',
                            '夜だけ釣りをしていた',
                            '魚ではなく龍を釣ろうとしていた'
                        ],
                        correct: 1,
                        hint: '普通の釣りとは違う点に注目してください。'
                    }
                ]
            },
            {
                id: 4,
                title: "第四回：哪吒出世",
                content: `
                    <p>陳塘関の総兵・李靖の夫人は三年六ヶ月の懐胎の末、肉球を産んだ。</p>
                    <p>李靖が剣で肉球を切ると、中から紅い光と共に男の子が現れた。これが哪吒である。</p>
                    <p>太乙真人が現れ、「この子は霊珠子の生まれ変わりで、将来封神の大業に功を立てる」と予言し、哪吒と名付けた。</p>
                    <p>七歳の時、哪吒は東海で水浴びをし、混天綾で海を揺らして龍宮を震動させ、東海龍王の三太子・敖丙と戦いになった。</p>
                `,
                puzzles: [
                    {
                        type: 'birth_mystery',
                        question: '哪吒の誕生の特異な点は？',
                        options: [
                            '雷と共に生まれた',
                            '三年六ヶ月の懐胎後、肉球から生まれた',
                            '蓮の花から生まれた',
                            '石から生まれた'
                        ],
                        correct: 1,
                        hint: '母親の懐胎期間と生まれた時の様子に注目。'
                    },
                    {
                        type: 'prophecy_puzzle',
                        question: '太乙真人は哪吒について何と予言した？',
                        options: [
                            '世界を滅ぼす魔王になる',
                            '仙人になって天に昇る',
                            '霊珠子の生まれ変わりで封神の大業に功を立てる',
                            '普通の人間として生きる'
                        ],
                        correct: 2,
                        hint: '太乙真人の言葉を注意深く読んでください。'
                    },
                    {
                        type: 'conflict_origin',
                        question: '哪吒と龍王の争いの原因は？',
                        options: [
                            '哪吒が龍王を侮辱した',
                            '混天綾で海を揺らして龍宮を震動させた',
                            '龍王の宝物を盗んだ',
                            '龍王の娘を誘拐した'
                        ],
                        correct: 1,
                        hint: '東海での水浴びの際に何が起きたか確認しましょう。'
                    }
                ]
            },
            {
                id: 5,
                title: "第五回：黄飛虎反商",
                content: `
                    <p>武成王・黄飛虎は殷朝の重臣で、七代にわたって殷に仕えた忠臣の家系であった。</p>
                    <p>ある日、黄飛虎の妻・賈氏が妹の黄妃を見舞うため宮中に入った。妲己は賈氏の美貌に嫉妬し、紂王を唆して賈氏を陵辱させようとした。</p>
                    <p>賈氏は貞節を守るため、摘星楼から身を投げて自殺した。さらに黄妃も妲己の陰謀で殺された。</p>
                    <p>妻と妹を失った黄飛虎は、ついに殷朝に背き、家族と部下を率いて西岐へ投降した。</p>
                `,
                puzzles: [
                    {
                        type: 'character_background',
                        question: '黄飛虎の殷朝での地位は？',
                        options: [
                            '一般の兵士',
                            '武成王で七代にわたる忠臣の家系',
                            '商人',
                            '道士'
                        ],
                        correct: 1,
                        hint: '黄飛虎の称号と家系について確認してください。'
                    },
                    {
                        type: 'tragedy_cause',
                        question: '賈氏が自殺した理由は？',
                        options: [
                            '病気を苦にして',
                            '貞節を守るため',
                            '黄飛虎に命じられて',
                            '事故だった'
                        ],
                        correct: 1,
                        hint: '妲己の陰謀と賈氏の行動の理由を読み取りましょう。'
                    },
                    {
                        type: 'turning_point',
                        question: '黄飛虎が殷朝に背いた最終的な理由は？',
                        options: [
                            '出世できなかったから',
                            '賄賂をもらったから',
                            '妻と妹を失ったから',
                            '戦いに負けたから'
                        ],
                        correct: 2,
                        hint: '家族に何が起きたか、その結果を確認してください。'
                    }
                ]
            }
        ];

        // キャンバスの初期化
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // アニメーション設定
        let animationFrame = 0;
        let currentAnimation = 'detective';

        // 火柴人描画関数
        function drawStickFigure(x, y, type = 'detective', frame = 0, scale = 1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.strokeStyle = type === 'detective' ? '#2c1810' : '#8b4513';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            // 頭
            ctx.beginPath();
            ctx.arc(0, -30, 15, 0, Math.PI * 2);
            ctx.stroke();

            if (type === 'detective') {
                // 探偵の帽子
                ctx.beginPath();
                ctx.moveTo(-20, -35);
                ctx.lineTo(20, -35);
                ctx.lineTo(15, -45);
                ctx.lineTo(-15, -45);
                ctx.closePath();
                ctx.stroke();

                // 虫眼鏡
                ctx.beginPath();
                ctx.arc(25, -10, 8, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(31, -4);
                ctx.lineTo(40, 5);
                ctx.stroke();
            }

            // 体
            ctx.beginPath();
            ctx.moveTo(0, -15);
            ctx.lineTo(0, 20);
            ctx.stroke();

            // 腕（アニメーション）
            const armAngle = Math.sin(frame * 0.1) * 0.3;
            
            // 左腕
            ctx.beginPath();
            ctx.moveTo(0, -5);
            ctx.lineTo(-15, 5);
            ctx.lineTo(-10 + Math.sin(frame * 0.1 + Math.PI) * 5, 20);
            ctx.stroke();

            // 右腕
            ctx.beginPath();
            ctx.moveTo(0, -5);
            ctx.lineTo(15, 5);
            ctx.lineTo(10 + Math.sin(frame * 0.1) * 5, 20);
            ctx.stroke();

            // 脚（歩行アニメーション）
            const legAngle = Math.sin(frame * 0.15) * 0.5;
            
            // 左脚
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.lineTo(-10 + Math.sin(frame * 0.15) * 10, 40);
            ctx.lineTo(-15 + Math.sin(frame * 0.15) * 15, 60);
            ctx.stroke();

            // 右脚
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.lineTo(10 + Math.sin(frame * 0.15 + Math.PI) * 10, 40);
            ctx.lineTo(15 + Math.sin(frame * 0.15 + Math.PI) * 15, 60);
            ctx.stroke();

            ctx.restore();
        }

        // 神獣・キャラクター描画
        function drawMythicalCreature(x, y, type, frame = 0) {
            ctx.save();
            ctx.translate(x, y);
            
            switch(type) {
                case 'fox_spirit': // 狐狸精
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.fillStyle = '#ff6b6b';
                    ctx.lineWidth = 2;
                    
                    // 体
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 30, 20, 0, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // 九尾
                    for (let i = 0; i < 9; i++) {
                        const angle = (Math.PI * 2 / 9) * i + frame * 0.02;
                        const tailX = Math.cos(angle) * 40;
                        const tailY = Math.sin(angle) * 40;
                        
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.quadraticCurveTo(
                            tailX * 0.5 + Math.sin(frame * 0.1 + i) * 5,
                            tailY * 0.5,
                            tailX,
                            tailY
                        );
                        ctx.stroke();
                    }
                    
                    // 頭
                    ctx.beginPath();
                    ctx.arc(0, -25, 15, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // 耳
                    ctx.beginPath();
                    ctx.moveTo(-10, -35);
                    ctx.lineTo(-5, -45);
                    ctx.lineTo(0, -35);
                    ctx.moveTo(10, -35);
                    ctx.lineTo(5, -45);
                    ctx.lineTo(0, -35);
                    ctx.stroke();
                    break;
                    
                case 'nezha': // 哪吒
                    ctx.strokeStyle = '#4a90e2';
                    ctx.lineWidth = 3;
                    
                    // 体
                    ctx.beginPath();
                    ctx.moveTo(0, -20);
                    ctx.lineTo(0, 10);
                    ctx.stroke();
                    
                    // 頭
                    ctx.beginPath();
                    ctx.arc(0, -30, 12, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // 風火輪
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.beginPath();
                    ctx.arc(-15, 25, 8, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(15, 25, 8, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // 火の効果
                    for (let i = 0; i < 5; i++) {
                        const flameHeight = Math.sin(frame * 0.2 + i) * 5 + 10;
                        ctx.beginPath();
                        ctx.moveTo(-15 + i * 7.5 - 15, 25);
                        ctx.lineTo(-15 + i * 7.5 - 15, 25 - flameHeight);
                        ctx.stroke();
                    }
                    
                    // 腕
                    ctx.strokeStyle = '#4a90e2';
                    ctx.beginPath();
                    ctx.moveTo(0, -10);
                    ctx.lineTo(-20, 0);
                    ctx.moveTo(0, -10);
                    ctx.lineTo(20, 0);
                    ctx.stroke();
                    break;
                    
                case 'jiang_ziya': // 姜子牙
                    ctx.strokeStyle = '#8b4513';
                    ctx.lineWidth = 2;
                    
                    // ローブ
                    ctx.beginPath();
                    ctx.moveTo(0, -20);
                    ctx.lineTo(-15, 30);
                    ctx.lineTo(15, 30);
                    ctx.closePath();
                    ctx.stroke();
                    
                    // 頭
                    ctx.beginPath();
                    ctx.arc(0, -30, 12, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // 髭
                    ctx.beginPath();
                    ctx.moveTo(-5, -25);
                    ctx.quadraticCurveTo(-10, -20, -12, -15);
                    ctx.moveTo(5, -25);
                    ctx.quadraticCurveTo(10, -20, 12, -15);
                    ctx.stroke();
                    
                    // 釣り竿
                    ctx.beginPath();
                    ctx.moveTo(15, -10);
                    ctx.quadraticCurveTo(30, -20, 35, -5);
                    ctx.stroke();
                    
                    // 釣り糸
                    ctx.beginPath();
                    ctx.moveTo(35, -5);
                    ctx.lineTo(35, 10 + Math.sin(frame * 0.1) * 5);
                    ctx.stroke();
                    break;
            }
            
            ctx.restore();
        }

        // アニメーションループ
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 背景
            ctx.fillStyle = 'rgba(255, 248, 220, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // メインキャラクター描画
            if (currentAnimation === 'detective') {
                drawStickFigure(canvas.width / 2, canvas.height / 2 + 50, 'detective', animationFrame);
            } else if (currentAnimation === 'celebration') {
                // 祝賀アニメーション
                drawStickFigure(canvas.width / 2, canvas.height / 2 + 50 - Math.abs(Math.sin(animationFrame * 0.1)) * 30, 'detective', animationFrame);
                
                // 紙吹雪効果
                for (let i = 0; i < 10; i++) {
                    ctx.fillStyle = `hsl(${i * 36}, 70%, 50%)`;
                    ctx.fillRect(
                        canvas.width / 2 + Math.sin(animationFrame * 0.05 + i) * 100,
                        (animationFrame * 2 + i * 50) % canvas.height,
                        5,
                        10
                    );
                }
            } else if (currentAnimation === 'thinking') {
                drawStickFigure(canvas.width / 2, canvas.height / 2 + 50, 'detective', animationFrame);
                
                // 思考バブル
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(canvas.width / 2 + 50, canvas.height / 2 - 50, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#333';
                ctx.font = '20px sans-serif';
                ctx.fillText('?', canvas.width / 2 + 45, canvas.height / 2 - 45);
            } else if (currentAnimation.includes('creature_')) {
                const creatureType = currentAnimation.replace('creature_', '');
                drawMythicalCreature(canvas.width / 2, canvas.height / 2, creatureType, animationFrame);
            }
            
            animationFrame++;
            requestAnimationFrame(animate);
        }

        // ゲーム開始
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameState.chapters = fengshenChapters;
            loadChapter(0);
            animate();
        }

        // 章の読み込み
        function loadChapter(chapterIndex) {
            if (chapterIndex >= gameState.chapters.length) {
                showGameComplete();
                return;
            }
            
            gameState.currentChapter = chapterIndex;
            gameState.currentPuzzle = 0;
            const chapter = gameState.chapters[chapterIndex];
            
            document.getElementById('chapterTitle').textContent = chapter.title;
            document.getElementById('textDisplay').innerHTML = chapter.content;
            document.getElementById('puzzleArea').style.display = 'none';
            
            // アニメーション変更
            currentAnimation = 'detective';
            
            // 2秒後に最初のパズルを表示
            setTimeout(() => {
                showPuzzle(0);
            }, 3000);
        }

        // パズル表示
        function showPuzzle(puzzleIndex) {
            const chapter = gameState.chapters[gameState.currentChapter];
            const puzzle = chapter.puzzles[puzzleIndex];
            
            document.getElementById('puzzleArea').style.display = 'block';
            document.getElementById('puzzleQuestion').textContent = puzzle.question;
            document.getElementById('hintText').style.display = 'none';
            
            const optionsContainer = document.getElementById('puzzleOptions');
            optionsContainer.innerHTML = '';
            
            puzzle.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.onclick = () => checkAnswer(index, puzzle.correct);
                optionsContainer.appendChild(button);
            });
            
            currentAnimation = 'thinking';
        }

        // 答え確認
        function checkAnswer(selected, correct) {
            const buttons = document.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.disabled = true);
            
            if (selected === correct) {
                buttons[selected].classList.add('correct');
                gameState.score += 100;
                gameState.completedPuzzles++;
                currentAnimation = 'celebration';
                
                // 手がかりを追加
                addClue(`✓ ${gameState.chapters[gameState.currentChapter].title} - パズル${gameState.currentPuzzle + 1}クリア`);
                
                setTimeout(() => {
                    nextPuzzle();
                }, 2000);
            } else {
                buttons[selected].classList.add('wrong');
                buttons[correct].classList.add('correct');
                gameState.score = Math.max(0, gameState.score - 20);
                
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('wrong', 'correct');
                    });
                    currentAnimation = 'detective';
                }, 2000);
            }
            
            updateScore();
            updateProgress();
        }

        // 次のパズル
        function nextPuzzle() {
            gameState.currentPuzzle++;
            
            if (gameState.currentPuzzle >= gameState.totalPuzzles) {
                // 章クリア
                showChapterComplete();
            } else {
                showPuzzle(gameState.currentPuzzle);
            }
        }

        // 章クリア表示
        function showChapterComplete() {
            gameState.score += 300; // ボーナスポイント
            updateScore();
            
            document.getElementById('modalTitle').textContent = '章クリア！';
            document.getElementById('modalMessage').textContent = `${gameState.chapters[gameState.currentChapter].title}を完了しました！\nボーナス: +300点`;
            document.getElementById('modal').classList.add('active');
            
            currentAnimation = 'celebration';
        }

        // ゲームクリア
        function showGameComplete() {
            document.getElementById('modalTitle').textContent = 'ゲームクリア！';
            document.getElementById('modalMessage').textContent = `おめでとうございます！\n全ての章をクリアしました！\n最終スコア: ${gameState.score}点`;
            document.getElementById('modal').classList.add('active');
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            loadChapter(gameState.currentChapter + 1);
        }

        // ヒント表示
        function showHint() {
            const chapter = gameState.chapters[gameState.currentChapter];
            const puzzle = chapter.puzzles[gameState.currentPuzzle];
            
            document.getElementById('hintText').textContent = puzzle.hint;
            document.getElementById('hintText').style.display = 'block';
            
            gameState.score = Math.max(0, gameState.score - 10);
            updateScore();
        }

        // スコア更新
        function updateScore() {
            document.getElementById('scoreValue').textContent = gameState.score;
        }

        // 進捗更新
        function updateProgress() {
            const totalPuzzles = gameState.chapters.length * gameState.totalPuzzles;
            const progress = (gameState.completedPuzzles / totalPuzzles) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // 手がかり追加
        function addClue(clue) {
            gameState.clues.push(clue);
            const cluesList = document.getElementById('cluesList');
            const clueItem = document.createElement('div');
            clueItem.className = 'clue-item';
            clueItem.textContent = clue;
            cluesList.appendChild(clueItem);
        }

        // ウィンドウリサイズ対応
        window.addEventListener('resize', () => {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        });

        // 初期化
        updateScore();
        updateProgress();
    </script>
</body>
</html>